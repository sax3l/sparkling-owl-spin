Ã–versikt fÃ¶r alla sidor och dess funktioner


Onboarding Wizard â€“ fullstÃ¤ndig specifikation
A) Enkel fÃ¶rklaring (fÃ¶r ickeâ€‘tekniker)

Onboarding guiden hjÃ¤lper dig att:

Ange ditt fÃ¶retagsnamn och eâ€‘post fÃ¶r aviseringar.

Ansluta till lokal MySQL (eller annat DBâ€‘val) och automatiskt skapa alla tabeller.

(Valfritt) Starta syntetiska testsajter i Docker sÃ¥ du kan Ã¶va utan risk.

Skapa ditt fÃ¶rsta projekt/kÃ¤lla sÃ¥ du kan bÃ¶rja crawla/scrapa direkt.
Guiden kÃ¶r hÃ¤lsokontroller, visar grÃ¶na bockar nÃ¤r nÃ¥got funkar, och skickar dig till Dashboard nÃ¤r allt Ã¤r klart.

B) Detaljerad UI/UXâ€‘spec
0. FÃ¶rutsÃ¤ttningskontroll (preâ€‘flight)

Syfte: fÃ¥ngar problem innan du fyller i nÃ¥got.

Visuellt: Tunn â€œchecklistâ€‘bannerâ€ hÃ¶gst upp, med 4 punkter och ikon (â³ â†’ âœ…/âŒ):

Python â‰¥ 3.11 (hittad/version)

Docker + Docker Compose (hittad/version, Compose V2)

Node.js LTS + npm (hittad/version)

MySQL klientbibliotek (drivrutin installerad serverâ€‘sidan)

TillstÃ¥nd & UX

Om nÃ¥got saknas: visa lÃ¤nk till snabbguide; â€œFortsÃ¤tt Ã¤ndÃ¥â€ tillÃ¥ts men â€œTesta databasanslutningâ€ inaktiveras tills DBâ€‘drivrutin finns.

Tooltip pÃ¥ varje punkt visar exakt krav och miniversion.

TillgÃ¤nglighet (a11y)

aria-live="polite" fÃ¶r uppdaterade statusar.

Ikoner har aria-label (â€œPython version OKâ€).

1. Organisationsuppgifter

FÃ¤lt

Organisationsnamn (text, obligatorisk, max 80 tecken)

Eâ€‘post fÃ¶r aviseringar (valfri, valideras mot eâ€‘postregex)

Samtycke till aviseringar (checkbox, valfri, default av)

Mikrokopi (hjÃ¤lptext)

â€œEâ€‘posten anvÃ¤nds fÃ¶r driftlarm (misslyckade jobb, lÃ¥g proxyhÃ¤lsa).â€

Validering

Tomt orgnamn â†’ rÃ¶d kant + feltext: â€œAnge organisationsnamnâ€.

Felaktig eâ€‘post â†’ â€œOgiltig eâ€‘postadressâ€.

Knappar

NÃ¤sta (inaktiverad tills orgnamn giltigt)

Avbryt onboarding (Ã¶ppnar dialog: bekrÃ¤fta â†’ Ã¥terstÃ¤lls/kan Ã¥terupptas senare)

2. Databasval & anslutning

Radioval

PostgreSQL / MySQL (lokal) / Annan

Default: MySQL (lokal) (enligt din inriktning)

Panel â€œMySQLâ€‘anslutningâ€ (visas vid MySQL)

Host (text, default 127.0.0.1)

Port (tal, default 3306)

Databas (text, default crawler)

AnvÃ¤ndare (text, ex root eller crawler)

LÃ¶senord (password, med â€œvisa/dÃ¶ljâ€)

SSL (checkbox) â†’ nÃ¤r pÃ¥: visa SSLâ€‘mode (dropâ€‘down: DISABLED|PREFERRED|REQUIRED|VERIFY_CA|VERIFY_IDENTITY), CAâ€‘cert (filuppladdning)

Avancerat (accordion):

TeckenuppsÃ¤ttning (default utf8mb4) + Collation (default utf8mb4_0900_ai_ci)

Tidszon (default â€œSystem/Europe/Stockholmâ€)

Poolstorlek (default 10) & Idle timeout (sek)

sql_mode (checkboxlista: STRICT_TRANS_TABLES, ERROR_FOR_DIVISION_BY_ZERO, NO_ENGINE_SUBSTITUTION â€“ default pÃ¥: STRICT_TRANS_TABLES, NO_ENGINE_SUBSTITUTION)

Automatiska migrationer (checkbox, default pÃ¥)

Spara lÃ¶senord sÃ¤kert (checkbox, default pÃ¥; fÃ¶rklarar att servern krypterar med KMS/nyckel)

Knappar

Testa databasanslutning

NÃ¤sta (lÃ¥st tills test lyckats eller man vÃ¤ljer â€œHoppa Ã¶verâ€ â€“ se policy nedan)

Hoppa Ã¶ver (tillÃ¥tet; varning popover: â€œUtan DB kan inga data sparasâ€)

Status & feedback

Vid â€œTestaâ€¦â€ â†’ spinner i knappen + progressrad (â€œPingarâ€¦â€, â€œLÃ¤ser versionâ€¦â€, â€œTestar rÃ¤ttigheterâ€¦â€).

Positivt: GrÃ¶n bock + text: â€œMySQL 8.0.3 upptÃ¤ckt. Migration redo.â€

Negativt: RÃ¶d banner Ã¶ver panelen + specifik orsak + Ã¥tgÃ¤rdsfÃ¶rslag:

ECONNREFUSED: â€œKontrollera host/port och att MySQL kÃ¶r.â€

AUTH_FAILED: â€œFel anvÃ¤ndare/lÃ¶sen. Testa â€œrootâ€ lokalt eller skapa dedikerad anvÃ¤ndare.â€

NO_DB: â€œDatabasen â€˜crawlerâ€™ saknas. Markera â€˜Skapa databasâ€™ (checkbox dyker upp vid NO_DB) och testa igen.â€

SSL_ERROR: â€œOgiltigt certifikat. VÃ¤lj â€˜VERIFY_CAâ€™ och ladda korrekt CA.â€

SÃ¤kerhet

LÃ¶senord maskeras i UI.

Serverlogg maskerar sekretessfÃ¤lt.

Inga hemligheter skrivs till browserkonsolen.

TillgÃ¤nglighet

Alla fÃ¤lt labelâ€‘kopplade; Enter triggar â€œTestaâ€¦â€ nÃ¤r fokus i formulÃ¤r.

Fel inline med role="alert".

3. Syntetiska testsajter (Docker)

Checkbox: â€œStarta syntetiska testsajter i Dockerâ€ (default pÃ¥)
Underpanel (visas om pÃ¥):

Portar (editable):

Statisk lista: 8081

OÃ¤ndlig scroll (JS): 8082

FormflÃ¶de: 8083

Docker nÃ¤tverk (dropdown, default bridge)

Autoâ€‘fix portar (checkbox): om port upptagen â†’ vÃ¤lj nÃ¤rmaste lediga

Knappar

Starta testsajter

Visa status

Statuskort (3 kolumner, ett per sajt):

Badge: Stopped / Starting / Healthy

LÃ¤nk: Ã–ppna i ny flik (http://localhost:port)

HÃ¤lsoprob: visar senaste GET /healthz med tid + ms

Felhantering

Docker saknas â†’ rÃ¶d banner: â€œDocker ej hittad; fÃ¶lj guiden (lÃ¤nk).â€

Compose v1 â†’ varning: â€œVi rekommenderar Compose V2; fortsÃ¤tter Ã¤ndÃ¥.â€

Portupptaget â†’ gul varning: â€œ8081 upptagen, fÃ¶reslÃ¥r 8085â€ + knapp â€œAnvÃ¤nd 8085â€.

TillgÃ¤nglighet

Kortens status uppdateras i aria-live="polite".

4. Skapa fÃ¶rsta projektet (miniformulÃ¤r)

FÃ¤lt

Projektnamn (obligatoriskt)

Startâ€‘URL (text; validera som URL)

Renderingspolicy (dropdown: Auto / HTTP / Browser)

Robots/ToSâ€‘lÃ¤ge (checkbox: â€œRespektera robots.txtâ€ â€“ rekommenderat)

Rate limit (RPS) (nummer, default 1.5)

Geografi (dropdown: SE default)

Skapa crawlâ€‘plan (checkbox; om pÃ¥: visar miniregler fÃ¶r paginering: â€œnÃ¤staâ€‘selektorâ€ eller queryâ€‘param)

Knappar

Testa Ã¥tkomst (kÃ¶r snabb diagnostik)

Skapa projekt

Feedback

Vid test: â€œ200 OK, titel: â€¦, laddtid 480msâ€ (grÃ¶n).

Block/403: gul varning med tips (sÃ¤nk rps, Ã¤ndra headers, vÃ¤lj Browser).

5. Standardpolicy & sammandrag

Sektion â€œDefaultinstÃ¤llningarâ€

Acceptâ€‘Language (sv-SE,sv;q=0.9,en;q=0.7)

Userâ€‘Agent profil (Desktop/Chrome)

Politeness delay (ms, slumpjitter pÃ¥)

Consentâ€‘cookie strategi (auto/ignorera â€“ upplysning om juridik)

Dataskydd (retention) (dagar, default 90)

Aviseringar (kritiska fel, banâ€‘rate trÃ¶skel)

Sammandrag

Lista Ã¶ver: Org, DB, Testsajter, Projekt, Policy.

Editâ€‘lÃ¤nkar till respektive steg.

Knappar

SlutfÃ¶r (primÃ¤r)

Tillbaka

6. KÃ¶rning & resultat

Progressvisning (sekventiellt, med retryâ€‘ikon):

Skapa workspace

Verifiera DBâ€‘anslutning

KÃ¶ra migrationer

Starta testsajter (om valt)

Skapa projekt & crawlâ€‘plan

Spara defaultpolicy

Skapa systemanvÃ¤ndare/APIâ€‘nyckel (om kryssat)

Varje delrad visar: ikon, tid, ev. lÃ¤nk till â€œvisa loggâ€. Fel Ã¶ppnar â€œÃ…tgÃ¤rda & fÃ¶rsÃ¶k igenâ€.

Avslut

Stor grÃ¶n panel: â€œAllt klart ğŸ‰â€ + knappar:

GÃ¥ till Dashboard

Ã–ppna Projektet

Starta ett fÃ¶rsta jobb nu

C) Exakta Ã¥tgÃ¤rder, backend, verifiering & tester
Backendâ€‘API (exempel, REST)

POST /api/onboarding/preflight â†’ { python, docker, compose, node, mysql_driver }

POST /api/onboarding/test-db â†’ body: { type, host, port, user, pass, db, ssl, advancedâ€¦ }

svar: { ok, server: {version, tz, sql_mode}, can_migrate: bool, needs_db_create: bool }

POST /api/onboarding/apply â†’ kÃ¶r alla steg (idempotent)

svar: { steps: [{name, ok, took_ms, log_id}], final_status }

POST /api/synthetic/start â†’ startar compose + healthcheck

GET /api/synthetic/health â†’ status per sajt + URL

POST /api/projects â†’ skapar projekt

POST /api/crawl-plans â†’ skapar plan

POST /api/policies/defaults â†’ sparar systempolicy

SÃ¤kerhet

LÃ¶senord skickas Ã¶ver HTTPS; krypteras serverâ€‘sidigt (t.ex. AESâ€‘GCM med serverâ€‘nyckel).

â€œVisa lÃ¶senordâ€ i UI pÃ¥verkar bara fÃ¤ltet, ej logg.

Databas â€“ MySQL parkoppling (garanterad vÃ¤g)

Driver: mysqlclient eller PyMySQL (rekommenderar mysqlclient fÃ¶r prestanda; fall tillbaka till PyMySQL).
DSNâ€‘format: mysql+mysqlclient://user:pass@host:port/db?charset=utf8mb4
Initâ€‘SQL (vid â€œTestaâ€):

SELECT VERSION()    AS server_version;
SELECT @@global.time_zone AS tz, @@sql_mode AS sql_mode;


Skapa DB vid behov:

CREATE DATABASE IF NOT EXISTS `crawler`
  /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci */;


Migrationer (Alembic, MySQLâ€‘dialekt):

KÃ¶rs pÃ¥ â€œSlutfÃ¶râ€ om â€œAutomatiska migrationerâ€ Ã¤r av.

Rollback: per steg; vid fel rullas endast den misslyckade delmigrationen tillbaka, och wizard visar â€œfÃ¶rsÃ¶k igenâ€.

Verksamhetsprov (efter kÃ¶rning):

-- 1) Alla kÃ¤rntabeller ska finnas
SHOW TABLES LIKE 'jobs';
SHOW TABLES LIKE 'extracted_items';

-- 2) Skriv/lÃ¤s runda
INSERT INTO health_check (ts, note) VALUES (NOW(), 'onboarding_ok');
SELECT COUNT(*) FROM health_check WHERE note='onboarding_ok';

Kommandon fÃ¶r anvÃ¤ndaren (valfria, fÃ¶r manuell verifiering)

Windows (PowerShell)

# Kolla MySQL server
mysql --host=127.0.0.1 --port=3306 -u root -p -e "SELECT VERSION();"

# Docker & Compose
docker --version
docker compose version

# Starta testsajter manuellt (om UI inte gjort det)
docker compose -f docker/synthetic-sites/docker-compose.yml up -d
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"


macOS/Linux (bash)

mysql -h 127.0.0.1 -P 3306 -u root -p -e "SELECT VERSION();"
docker --version && docker compose version
docker compose -f docker/synthetic-sites/docker-compose.yml up -d


Tolka svar

SELECT VERSION() ger en strÃ¤ng t.ex. 8.0.34.

docker ps visar tre containrar â€œhealthyâ€.

WebblÃ¤sare: Ã¶ppna http://localhost:8081, 8082, 8083 â†’ ser testsidor.

Felmatris & Ã¥tgÃ¤rdsfÃ¶rslag (DB)
Felkod	Vad betyder det	UIâ€‘meddelande	FÃ¶reslagen Ã¥tgÃ¤rd
ECONNREFUSED	Port stÃ¤ngd / server nere	â€œKunde inte ansluta till 127.0.0.1:3306â€	Starta MySQL, kontrollera brandvÃ¤gg, rÃ¤tt port
ER_ACCESS_DENIED_ERROR	Fel anvÃ¤ndare/lÃ¶senord	â€œAutentisering misslyckadesâ€	Verifiera creds; testa root lokalt
NO_DB	Databas saknas	â€œDatabas â€˜crawlerâ€™ saknasâ€	Bocka â€œSkapa databasâ€ och fÃ¶rsÃ¶k igen
SSL_ERROR	Certifikatproblem	â€œSSLâ€‘fel: verifiering misslyckadesâ€	Byt SSLâ€‘mode till VERIFY_CA och ladda korrekt CA
MODE_MISMATCH	sql_mode inkompatibel	â€œsql_mode saknar STRICTâ€¦â€	LÃ¥t wizarden lÃ¤gga till STRICT_TRANS_TABLES
UXâ€‘detaljer som maximerar anvÃ¤ndbarhet

Autospara varje steg till servern (sÃ¥ onboarding kan Ã¥terupptas).

Skelettladdning (shimmer) fÃ¶r statuskort; inga hopp i layout.

PrimÃ¤rknappen alltid pÃ¥ samma plats (hÃ¶ger) â†’ â€œNÃ¤staâ€ â†’ â€œSlutfÃ¶râ€.

Klartâ€‘signaler: GrÃ¶n bock + kort sammanfattning per del.

Guidade fel: Inâ€‘place Ã¥tgÃ¤rdsfÃ¶rslag + â€œProva igenâ€.

TillgÃ¤nglighet: Fullt tangentbordsstÃ¶d (Tabâ€‘ordning), aria-describedby fÃ¶r fel.

I18n: alla texter via i18n/sv-SE.yml; fallback en-US.

Acceptanskriterier (DoD)

Onboarding kan slutfÃ¶ras med MySQL lokalt â†’ tabeller skapade, Dashboard laddas.

â€œTesta databasanslutningâ€ visar exakt felorsak och fÃ¶rslag.

Syntetiska sajter kan startas/stoppas, och UI visar Healthy + klickbara lÃ¤nkar.

FÃ¶rsta projektet skapas och syns i Projektlistan.

Avbryter man i steg 3 och Ã¥terkommer, Ã¥terupptas i rÃ¤tt steg med sparade vÃ¤rden.

Inga hemligheter loggas i klientlogg; serverlogg maskerar.

SkÃ¤rmlÃ¤sare (NVDA/VoiceOver) kan annonsera fel och statusbyten.

E2Eâ€‘test (Playwright) tÃ¤cker: lyckad vÃ¤g, DBâ€‘fel, Dockerâ€‘saknas, portkrock, Ã¥terupptag.

E2Eâ€‘testfall (Playwright, kortfattat)

TCâ€‘001 Lyckad onboarding MySQL + testsajter + projekt â†’ landar pÃ¥ Dashboard, tre services Healthy.

TCâ€‘002 Fel lÃ¶senord â†’ UI visar AUTH_FAILED, Ã¥tgÃ¤rd ger OK.

TCâ€‘003 Docker ej installerat â†’ varning, men onboarding kan slutfÃ¶ras utan testsajter.

TCâ€‘004 Port 8081 upptagen â†’ â€œAutoâ€‘fixâ€ vÃ¤ljer 8085; status Healthy.

TCâ€‘005 Avbryt i steg 2, Ã¥terÃ¶ppna app â†’ wizard hoppar direkt till steg 2 med vÃ¤rden kvar.

TCâ€‘006 Migration fel (simulerad) â†’ wizard erbjuder â€œVisa loggâ€, â€œFÃ¶rsÃ¶k igenâ€; efter fix blir grÃ¶n.

Minimal datamodell (server) fÃ¶r onboarding state

onboarding_state

id (singleton), step (int), org_name, notify_email,

db_config (json, krypterat password),

synthetic_config (json),

first_project (json),

created_at, updated_at, completed_at.

Loggning & spÃ¥rbarhet

Audit event skrivs fÃ¶r: testâ€‘db (utan hemligheter), kÃ¶r migration, start synthetic, skapa projekt/policy.

Korrelationâ€‘ID fÃ¶ljer hela onboardingâ€‘kÃ¶rningen i logg.

D) Snabb â€œhur kontrollerar jag att det fungerar?â€

Efter â€œTesta databasanslutningâ€

Du ser â€œMySQL X.Y.Zâ€ + grÃ¶n bock.

KÃ¶r (frivilligt) i terminal:

mysql -h 127.0.0.1 -P 3306 -u <user> -p -e "SELECT VERSION();"


Efter â€œStarta testsajterâ€

Tre kort visar Healthy.

Ã–ppna http://localhost:8081 (statisk), :8082 (infinite scroll), :8083 (formflÃ¶de).

Efter â€œSlutfÃ¶râ€

Du landar pÃ¥ Dashboard.

I InstÃ¤llningar â†’ Databaser stÃ¥r: â€œAnsluten: MySQL â€¦ Migration: headâ€.

I DB:

SELECT COUNT(*) FROM jobs; -- ska ge â‰¥ 0 utan fel

E) Checklista (allt som nu finns med)

 Alla fÃ¤lt/knappar frÃ¥n din ursprungliga lista.

 Preâ€‘flight kontroller & versionskrav.

 Avancerade MySQLâ€‘instÃ¤llningar (charset, collation, sql_mode, pool).

 SSLâ€‘lÃ¤gen & certifikatuppladdning.

 Felhantering med konkreta Ã¥tgÃ¤rdsfÃ¶rslag.

 Syntetiska sajter med hÃ¤lsoâ€‘kort, portâ€‘autoâ€‘fix och direkta lÃ¤nkar.

 FÃ¶rsta projektet med miniplan och Ã¥tkomsttest.

 Defaultpolicy (Acceptâ€‘Language, UA, politeness, retention, aviseringar).

 Sekventiell â€œapplyâ€ med perâ€‘steg logg + retry.

 SÃ¤ker sekretesshantering (maskning, kryptering).

 Ã…terupptagbar onboarding (autospara).

 TillgÃ¤nglighet, i18n, keyboardâ€‘navigering.

 Acceptanskriterier & e2eâ€‘testfall.

 Garanterad parkoppling till lokal MySQL inkl. migrationsvÃ¤g och manuella verifieringar.










2) Dashboard / Hem â€“ komplett specifikation
A) Enkel fÃ¶rklaring (fÃ¶r ickeâ€‘tekniker)

Dashboarden Ã¤r â€œhemmetâ€ dÃ¤r du ser hur systemet mÃ¥r just nu:

vilka jobb som kÃ¶r,

hur mÃ¥nga fel som skett nyligen,

hur mycket data som produceras,

hur proxypoolen mÃ¥r (snabb/lÃ¥ngsam, felprocent),

vilka scheman (planerade kÃ¶rningar) som snart startar,

och aviseringar som krÃ¤ver din uppmÃ¤rksamhet.

Du kan starta nya jobb, skapa mallar och kÃ¤llor, samt klicka vidare in pÃ¥ detaljer fÃ¶r att felsÃ¶ka.

B) Detaljerad UI/UXâ€‘spec
Layout & navigation

Filterrad (Ã¶verst): Tidsspann, Team, KÃ¤lla/Projekt, Jobbtyp, Status, MiljÃ¶ (dev/stage/prod), snabbval (Senaste 15 min/1 h/24 h/7 d), manuellt datumintervall (med tidszon Europe/Stockholm).

Knapp: â€œSpara vyâ€ (sparar val + widgetordning per anvÃ¤ndare), â€œDela vyâ€ (lÃ¤nk med queryâ€‘params).

Widgetâ€‘grid (12â€‘kolumn rutnÃ¤t) med dragâ€‘&â€‘slÃ¤pp fÃ¶r att arrangera kort.

Alla kort har: titel, uppdateradâ€‘fÃ¶râ€‘Xâ€‘sek sedan, uppdateraâ€‘ikon, â€œâ€¢ â€¢ â€¢â€ meny (export/Ã¶ppna i ny flik/ta skÃ¤rmdump).

Tomt tillstÃ¥nd (om inget jobb/ingen data): vÃ¤nliga CTAâ€‘knappar â€œNytt jobbâ€, â€œSkapa fÃ¶rsta mallâ€, â€œLÃ¤gg till datakÃ¤llaâ€.

Realtidsuppdatering

WebSocket push (1â€“5 s).

Fallback till polling: sammanfattning cachead i 15â€“60 s (instÃ¤llning).

Flik inaktiv > 60 s â†’ autopaus av realtid (sÃ¤nker nÃ¤tverk/CPU), stor grÃ¥ â€œPausadâ€ badge i varje kort; â€œFortsÃ¤tt uppdateraâ€ Ã¥teraktiverar.

TillgÃ¤nglighet (A11y)

Tangentbordsnavigering via Tab/Shift+Tab; Enter aktiverar primÃ¤rÃ¥tgÃ¤rd i fokus.

Liveâ€‘omrÃ¥den (aria-live="polite") fÃ¶r KPIâ€‘nummer & statuschips.

FÃ¤rg + ikon + text fÃ¶r status (inte enbart fÃ¤rg).

Alla grafer har tabellâ€‘alternativ (â€Visa som tabellâ€).

Widget 1: Aktiva jobb

Syfte: Se alla pÃ¥gÃ¥ende jobb, deras progress, ETA, Ã¤gare samt agera snabbt.

InnehÃ¥ll

Tabellkolumner:

Jobbnamn (lÃ¤nk â†’ Jobbdetaljer)

Typ (Crawl / Crawl+Scrape / Scrape / Export)

KÃ¤lla/Projekt (chips, flerâ€‘val)

Statuschip (Pending/Running/Paused/Degraded/Retrying)

Progress (procent + â€œx/y URL:erâ€)

ETA (berÃ¤knad, t.ex. â€œ12mâ€)

Startad (relativ + tooltip exakt tid)

Ã„gare (avatar + namn)

Workers (antal)

Renderingspolicy (Auto/HTTP/Browser)

Proxyprofil (Auto/Sticky/Geoâ€‘SE â€¦)

RadÃ¥tgÃ¤rder (ikonknappar)

Pausa / Ã…teruppta

Skala (â€‘1/+1 worker)

Ã–ppna loggar (sidopanel med tail, filtrerbar)

Avsluta (med bekrÃ¤ftelse)

Ã–ppna i Jobbdetaljer

Filter & sort

SÃ¶kfÃ¤lt Ã¶ver tabellen (namn, id).

Sortera pÃ¥ startad, ETA, progress, status.

Paginering med â€œvisa 10/25/50â€.

States

Loading (skeleton) 3 skelettâ€‘rader.

Tomt: â€œInga aktiva jobbâ€ + â€œStarta nytt jobbâ€.

Fel: rÃ¶d banderoll â€œKunde inte lÃ¤sa jobblistanâ€ + â€œFÃ¶rsÃ¶k igenâ€.

Widget 2: Feltrender (senaste 24 h)

Syfte: Snabb Ã¶verblick av fel (per klass) Ã¶ver tid.

InnehÃ¥ll

Miniâ€‘linjediagram (stackad eller multiâ€‘serie) med bucketâ€‘storlek auto (1m/5m/15m).

Serier: Transient (tidsouts/nÃ¤t), Policy (403/429 m.m.), Permanent (404/410).

Interaktioner

Hover â†’ tooltip (tid, klass, antal)

Penselmarkering â†’ zooma intervall

Klick pÃ¥ legendpunkt â†’ visa/dÃ¶lj serie

LÃ¤nk: â€œÃ–ppna felanalysâ€ (leder till DQ/Analysâ€‘sida med fÃ¶rfyllda filter)

States

Tom data â†’ grÃ¥ text: â€œInga fel i valt intervallâ€.

Widget 3: Dataproduktion

Syfte: MÃ¤ngd och takt pÃ¥ extraherad data.

InnehÃ¥ll

KPIâ€‘kort:

Totalt extraherat (i filterintervall)

Takt (1â€‘min medel) (items/min)

Validerade OK vs KarantÃ¤n (med procent)

Miniâ€‘barserie: items/min per 5 min bucket

Topp 5 mallar (lista): mallnamn, bidrag %, lÃ¤nk till mallversion

Interaktioner

Klick pÃ¥ mall â†’ fÃ¶rfiltrera Datalager pÃ¥ den mallen i samma intervall.

Widget 4: ProxyhÃ¤lsa

Syfte: Upstreamâ€‘nÃ¤tverkets kondition.

InnehÃ¥ll

Latency p50/p95 (ms)

Failâ€‘rate (%) (misslyckade fÃ¶rfrÃ¥gningar p.g.a. nÃ¤t/block)

Poolstatus: antal aktiva proxies / svartlistade senaste 1 h

Top 5 instabila endpoints: endpoint, geo, failâ€‘rate, senaste felkod

Ã…tgÃ¤rder

Svartlista endpoint (med anledning)

Validera nu (kickar ett snabbtestjobb)

Ã–ppna Proxyâ€‘panel (full sida)

States

GrÃ¶n/gul/rÃ¶d fÃ¤rgkod baserat pÃ¥ trÃ¶sklar (konfig i Policies).

Tooltip fÃ¶r trÃ¶skelvÃ¤rden.

Widget 5: Kommande scheman

Syfte: Se vad som startar snart.

InnehÃ¥ll

Lista (kommande 24â€“72 h):

Tid (lokal, Europe/Stockholm)

Jobbmall (preset), KÃ¤lla, Typ

NÃ¤sta kÃ¶rning + repetition (CRONâ€‘etikett)

Ã…tgÃ¤rder

KÃ¶r nu

Skippa nÃ¤sta

Redigera schema (Ã¶ppnar Scheduler-sidan)

Pausa schema

Widget 6: Aviseringar

Syfte: HÃ¤ndelser som krÃ¤ver uppmÃ¤rksamhet.

InnehÃ¥ll

Lista (senaste 50): tid, severity (Info/Warning/Critical), kÃ¤lla (job, proxy, policy), text, lÃ¤nk

Filter inne i kortet: severity, kÃ¤lla

Ã…tgÃ¤rder

Kvittera (acknowledge)

Tysta (mute 1 h/24 h)

Skapa runbook (fÃ¶rifylld mall)

Globala komponenter

Snabbknappar (hÃ¶ger topp):

Nytt jobb â†’ Job Launcher

Ny mall â†’ Template Wizard

Ny datakÃ¤lla â†’ Projekt/KÃ¤llor

Proxyâ€‘panel â†’ Proxy & NÃ¤tverk

Global sÃ¶k (Cmd/Ctrl+K): jumpa till jobb/mall/projekt genom att skriva namn/id.

Export i varje kort: CSV/JSON och PNG (fÃ¶r grafer).

Microcopy & visuella riktlinjer

Konsistenta statuschips:

Running (blÃ¥), Paused (grÃ¥), Degraded (orange), Failed (rÃ¶d), Completed (grÃ¶n).

Alla tider visas relativt + tooltip absolut med datum/tid i Europe/Stockholm.

Tomt tillstÃ¥nd beskriver vad du kan gÃ¶ra hÃ¤rnÃ¤st (CTA).

Prestanda & robusthet

Dashboard â€œtimeâ€‘toâ€‘interactiveâ€ â‰¤ 1.5 s pÃ¥ normalt dataset.

Datatabeller anvÃ¤nder virtuell scroll vid > 200 rader.

WebSocket autoâ€‘reconnect med jitter; fallback till polling.

Alla kort isolerar fel (ett korts fel fÃ¥r inte krascha hela sidan).

SÃ¤kerhet & roller

RBAC:

LÃ¤sare: ser allt, inga Ã¥tgÃ¤rdsknappar.

OperatÃ¶r: paus/Ã¥teruppta/skalning pÃ¥ jobb.

Admin: alla Ã¥tgÃ¤rder + schemaÃ¤ndringar.

Knappar visas/inaktiveras efter roll och context (t.ex. â€œAvslutaâ€ dÃ¶ljs fÃ¶r LÃ¤sare).

C) Exakta kommandon & kontrakt (backend/API/SQL/Verifiering)

Jag antar en RESTâ€‘stil + WebSocket. Anropa med Authorization: Bearer <token> dÃ¤r relevant.

1. Sammanfattning (allt i ett)

Endpoint

GET /api/dashboard/summary?from=2025-08-21T08:00:00Z&to=2025-08-21T10:00:00Z
                       &team=core&project_id=123&env=dev


Svar (exempel)

{
  "filters": { "from":"2025-08-21T08:00:00Z","to":"2025-08-21T10:00:00Z","team":"core","project_id":123,"env":"dev" },
  "now":"2025-08-21T10:00:12Z",
  "active_jobs": [
    {"id":"job_901","name":"Crawl Volvo","type":"crawl","project":"Vehicles","status":"running","progress":0.42,"eta_sec":720,"started_at":"2025-08-21T09:40:00Z","owner":"elin","workers":3,"rendering":"auto","proxy_profile":"geo-se"},
    {"id":"job_902","name":"Scrape Owners","type":"scrape","project":"Owners","status":"paused","progress":0.77,"eta_sec":3600,"started_at":"2025-08-21T09:10:00Z","owner":"amir","workers":2,"rendering":"browser","proxy_profile":"sticky"}
  ],
  "errors_timeseries": {
    "bucket_sec": 300,
    "series": {
      "transient":[["2025-08-21T09:00:00Z",3],["2025-08-21T09:05:00Z",2]],
      "policy":[["2025-08-21T09:00:00Z",1],["2025-08-21T09:05:00Z",1]],
      "permanent":[["2025-08-21T09:00:00Z",0],["2025-08-21T09:05:00Z",1]]
    }
  },
  "production": {
    "total": 18420,
    "rate_per_min": 142,
    "validated_ok": 17850,
    "quarantine": 570,
    "by_template":[{"template":"vehicle_detail_v1","count":8200},{"template":"owner_v2","count":6200}]
  },
  "proxy_health":{
    "latency_ms":{"p50":220,"p95":840},
    "fail_rate":0.023,
    "active_endpoints":342,
    "blacklisted_last_hour":5,
    "top_unstable":[
      {"endpoint":"se.resi.12","geo":"SE","fail_rate":0.12,"last_error":"429"},
      {"endpoint":"fi.resi.07","geo":"FI","fail_rate":0.09,"last_error":"timeout"}
    ]
  },
  "upcoming_schedules":[
    {"id":"sched_77","name":"Nightly Crawl","when":"2025-08-21T22:00:00+02:00","job_preset":"crawl+scrape","project":"Vehicles","repeat":"0 22 * * *"},
    {"id":"sched_80","name":"Owners incremental","when":"2025-08-21T11:00:00+02:00","job_preset":"scrape","project":"Owners","repeat":"@hourly"}
  ],
  "alerts":[
    {"id":"al_1","ts":"2025-08-21T09:58:00Z","severity":"warning","source":"proxy","message":"Fail-rate > 5% on pool se-resi"},
    {"id":"al_2","ts":"2025-08-21T09:30:00Z","severity":"critical","source":"job:job_901","message":"Error spike (policy) > 20%"}
  ],
  "ttl_sec": 30
}


Kommandon (verifiera med curl)

# HÃ¤mta sammanfattning 1h bakÃ¥t:
SINCE=$(date -u +"%Y-%m-%dT%H:%M:00Z" -d "-1 hour")
NOW=$(date -u +"%Y-%m-%dT%H:%M:00Z")
curl -s "http://localhost:8000/api/dashboard/summary?from=$SINCE&to=$NOW" | jq .


Vad som ska hÃ¤nda

JSON returneras inom < 300 ms (med cache), nycklar enligt ovan.

UI visar siffror, grafer och listor baserat pÃ¥ svaret.

Hur du kontrollerar resultatet

Siffror i Dataproduktion matchar SQLâ€‘rÃ¤kning (se MySQLâ€‘sektionen nedan).

â€œAktiva jobbâ€ matchar jobs.status IN ('running','paused','pending').

2. WebSocket fÃ¶r realtid

Endpoint

GET /ws/dashboard?project_id=123


Meddelanden (exempel)

{ "type":"job.updated", "job_id":"job_901", "status":"running", "progress":0.44, "eta_sec":690 }
{ "type":"metric.bump", "metric":"production.rate_per_min", "value":151, "ts":"2025-08-21T09:59:00Z" }
{ "type":"alert.new", "id":"al_3", "severity":"critical", "message":"p95 > 2s", "ts":"2025-08-21T09:59:10Z" }


Kommandon (snabbt test med websocat)

websocat ws://localhost:8000/ws/dashboard


FÃ¶rvÃ¤ntat

Meddelanden kommer nÃ¤r jobb uppdateras/alerts skapas.

UI uppdaterar rader och KPI:er utan full reload.

3. Ã…tgÃ¤rdsâ€‘endpoints (exempel)
POST /api/jobs/{id}/pause
POST /api/jobs/{id}/resume
POST /api/jobs/{id}/scale { "delta": +1 }
POST /api/proxies/{endpoint}/blacklist { "reason":"high fail rate" }
POST /api/schedules/{id}/run-now
POST /api/alerts/{id}/ack
POST /api/alerts/{id}/mute { "duration":"1h" }


Kommandon (curl)

curl -X POST http://localhost:8000/api/jobs/job_901/pause
curl -X POST http://localhost:8000/api/proxies/se.resi.12/blacklist -H "Content-Type: application/json" -d '{"reason":"error rate"}'


Verifiering

Jobbstatus Ã¤ndras i Aktiva jobb pÃ¥ sekunder.

Proxy fÃ¶rsvinner frÃ¥n listan â€œaktivaâ€ och dyker upp i svartlistâ€‘historik.

4. MySQL â€“ vyer & frÃ¥gor (garanterad koppling)

Nedan SQL fungerar mot lokal MySQL och stÃ¶djer dashboardens datapunkter.

Index (prestanda)

CREATE INDEX IF NOT EXISTS idx_jobs_status ON jobs(status);
CREATE INDEX IF NOT EXISTS idx_jobs_started_at ON jobs(started_at);
CREATE INDEX IF NOT EXISTS idx_items_created_at ON extracted_items(created_at);
CREATE INDEX IF NOT EXISTS idx_job_logs_ts ON job_logs(ts);
CREATE INDEX IF NOT EXISTS idx_job_logs_class ON job_logs(error_class);


Feltrender (aggregering i 5â€‘min buckets)

SELECT
  FROM_UNIXTIME(FLOOR(UNIX_TIMESTAMP(ts)/300)*300) AS bucket,
  error_class,
  COUNT(*) AS cnt
FROM job_logs
WHERE ts BETWEEN @from AND @to
GROUP BY bucket, error_class
ORDER BY bucket ASC;


Dataproduktion (antal & takt)

-- total i intervallet
SELECT COUNT(*) AS total
FROM extracted_items
WHERE created_at BETWEEN @from AND @to;

-- takt per minut sista 5 min
SELECT COUNT(*)/5.0 AS rate_per_min
FROM extracted_items
WHERE created_at >= NOW() - INTERVAL 5 MINUTE;

-- validerade OK vs karantÃ¤n
SELECT
  SUM(CASE WHEN dq_status='ok' THEN 1 ELSE 0 END) AS validated_ok,
  SUM(CASE WHEN dq_status='quarantine' THEN 1 ELSE 0 END) AS quarantine
FROM extracted_items
WHERE created_at BETWEEN @from AND @to;

-- toppmallar
SELECT template_id, COUNT(*) AS cnt
FROM extracted_items
WHERE created_at BETWEEN @from AND @to
GROUP BY template_id
ORDER BY cnt DESC
LIMIT 5;


ProxyhÃ¤lsa

-- latency percentiler ungefÃ¤rligt (MySQL 8: anvÃ¤nd window functions om ni lagrar alla mÃ¤tningar)
-- hÃ¤r exempelvis p95 via approx-tabell 'proxy_metrics' (preagg)
SELECT p50_ms, p95_ms, fail_rate, active_endpoints, blacklisted_last_hour
FROM proxy_metrics
WHERE ts = (SELECT MAX(ts) FROM proxy_metrics);

-- topp instabila
SELECT endpoint, geo, fail_rate, last_error
FROM proxy_endpoints
ORDER BY fail_rate DESC
LIMIT 5;


Kommande scheman

SELECT id, name, next_run_at, job_preset, project
FROM schedules
WHERE next_run_at BETWEEN NOW() AND NOW() + INTERVAL 3 DAY
ORDER BY next_run_at ASC
LIMIT 50;


Aviseringar

SELECT id, ts, severity, source, message
FROM alerts
WHERE ts >= NOW() - INTERVAL 24 HOUR
ORDER BY ts DESC
LIMIT 50;


Kommandon (kÃ¶r och jÃ¤mfÃ¶r med UI)

SET @from = NOW() - INTERVAL 1 HOUR;
SET @to   = NOW();
-- KÃ¶r frÃ¥gorna ovan och jÃ¤mfÃ¶r vÃ¤rden mot dashboarden.


Vad som ska hÃ¤nda

Siffror i UI â‰ˆ resultat frÃ¥n SQL (smÃ¥ avvikelser kan finnas p.g.a. cache 15â€“60 s).

NÃ¤r nya poster skrivs till extracted_items ser du â€œDataproduktionâ€ ticka upp.

5. Export frÃ¥n widgets

Kommandon (curl)

# Exportera feltrender som CSV
curl -s "http://localhost:8000/api/metrics/errors.csv?from=$SINCE&to=$NOW&bucket=300" -o errors.csv

# Exportera aktiva jobb som JSON
curl -s "http://localhost:8000/api/jobs?status=running" -o active_jobs.json


Verifiering

Fil finns pÃ¥ disk, Ã¶ppningsbar i Excel/valfri editor; rader matchar vyn.

D) Acceptanskriterier, testfall & edge cases
Definition of Done (funktionalitet)

Dashboard laddar < 1.5 s (kall cache < 2.5 s) med standarddata.

WebSocket uppdaterar Aktiva jobb, Dataproduktion och Aviseringar i realtid; polling fallback fungerar.

Varje widget har Loading, Tomt och Felâ€‘tillstÃ¥nd.

Filterrad pÃ¥verkar alla widgets konsekvent; â€œSpara vyâ€ fungerar per anvÃ¤ndare; â€œDela vyâ€ Ã¥terstÃ¤ller filtret.

RBAC gÃ¶mmer/avaktiverar Ã¥tgÃ¤rder som anvÃ¤ndaren ej fÃ¥r utfÃ¶ra.

Export (CSV/JSON/PNG) fungerar fÃ¶r alla widgets.

Alla tider visas i Europe/Stockholm i UI (tooltip visar UTC).

MySQL queries reproducerar dashboardvÃ¤rden (Â± cache).

E2Eâ€‘testfall (Playwright)

TCâ€‘DASHâ€‘01: Ladda dashboard â†’ skeleton â†’ data visas; filter â€œSenaste 1 hâ€ aktivt.

TCâ€‘DASHâ€‘02: Starta jobb (via Job Launcher) â†’ Aktiva jobb visar raden inom 2 s.

TCâ€‘DASHâ€‘03: Stoppa webbâ€‘socket server â†’ dashboard vÃ¤xlar till polling; data fortsÃ¤tter uppdateras.

TCâ€‘DASHâ€‘04: Roll â€œLÃ¤sareâ€ ser inga Ã¥tgÃ¤rdsknappar i â€œAktiva jobbâ€.

TCâ€‘DASHâ€‘05: â€œProxyhÃ¤lsaâ€ visar rÃ¶d status nÃ¤r failâ€‘rate > trÃ¶skel; kvittera alert â†’ fÃ¶rsvinner frÃ¥n listan.

TCâ€‘DASHâ€‘06: â€œSpara vyâ€ â†’ logga ut/in â†’ layout och filter Ã¥terstÃ¤lls.

TCâ€‘DASHâ€‘07: Ã–ppna â€œFeltrenderâ€ â†’ klicka â€œVisa som tabellâ€ â†’ exportera CSV â†’ fil innehÃ¥ller rÃ¤tt buckets.

TCâ€‘DASHâ€‘08: Filter â€œProjekt=Vehiclesâ€ pÃ¥verkar alla widgets; â€œKommande schemanâ€ visar bara relevanta.

Edge cases

Massiva datamÃ¤ngder: tabellâ€‘virtualisering, serverâ€‘paginering, tidsintervall begrÃ¤nsas.

Klockdrift: backend sÃ¤tter now i svaret; UI berÃ¤knar relativa tider utifrÃ¥n detta.

Partial failures: om ProxyhÃ¤lsaâ€‘API faller, bara det kortet visar fel; andra kort fungerar.

Inga proxies: ProxyhÃ¤lsa kort â†’ â€œIngen proxypool konfigureradâ€ + lÃ¤nk â€œSkapa poolâ€.

Extra: UXâ€‘polish som gÃ¶r skillnad

Inlineâ€‘kommandon i â€œAktiva jobbâ€: hÃ¥ll mus Ã¶ver â€œWorkersâ€â€cellen â†’ smÃ¥ +/â€‘ knappar visas.

Kopieraâ€‘tillâ€‘urklipp ikon bredvid jobbid/templateid.

Animerad uppdatering: KPIâ€‘tal rÃ¤knar mjukt uppÃ¥t/nedÃ¥t.

FÃ¤rgblindvÃ¤nligt tema: alternativ fÃ¤rgpalett i profilmenyn.

Omâ€‘layout pÃ¥ mobil: widgets staplas; aggregation minskar granulat.









3) Datalager / Katalog
A) Enkel fÃ¶rklaring (ickeâ€‘tekniker)

HÃ¤r ser du alla extraherade dataposter. Du kan:

SÃ¶ka och filtrera (t.ex. vilka poster som kom frÃ¥n en viss kÃ¤lla/mall eller skapades ett visst datum),

FÃ¶rhandsvisa innehÃ¥llet, se var det kom ifrÃ¥n (jobb, URL, policy),

se datakvalitet (DQ), varfÃ¶r nÃ¥got hamnat i karantÃ¤n,

exportera ett urval till fil eller annan destination,

och radera data enligt integritetspolicy.

B) Detaljerad UI/UXâ€‘spec
B.1 Sidlayout & navigation

Toppfilterrad (leftâ†’right):

SÃ¶k (fri text; mot fÃ¤ltvÃ¤rden, id, url)

KÃ¤lla/Projekt (multiâ€‘select)

Mall (multiâ€‘select; visar namn (version) med pillâ€‘badges)

Taggar (multiâ€‘select; fritext + autosuggest)

Status (checkboxâ€‘grupp): validerad, karantÃ¤n, tombstone (raderad)

Datumintervall (snabbval 24h/7d/anpassat; lokaltid Europe/Stockholm)

Avancerat (accordion): â€œHar bilaga/snapshotâ€, â€œDQâ€‘regel matchar â€¦â€, â€œMinimal fÃ¤ltfyllnad %â€

Ã…terstÃ¤ll filter (ikon)

HuvudomrÃ¥de:

Resultattabell (vÃ¤nster, responsiv) med serverâ€‘paginering

SidofÃ¤lt (hÃ¶ger, tvÃ¥ flikar): Linage/Proveniens och DQ

Verktygsrad ovan tabellen:

Bulkâ€‘vÃ¤lj (checkbox i rubrik)

Exportera urval

Flagga/karantÃ¤n (bulk)

Radera enligt policy (bulk)

Visa/Ã¤ndra kolumner (kolumnvÃ¤ljare)

Visa som kort / tabell (toggle)

B.2 Resultattabell (serverâ€‘paginering)

Kolumner (default):

id (kort hash/nummer; kopieraâ€‘ikon)

mall (namn + versionchip)

FÃ¤ltpreview (de 3 viktigaste fÃ¤lten enligt mallens prioritet; t.ex. title, reg_number, date)

status (chip: validerad = grÃ¶n, karantÃ¤n = orange, tombstone = grÃ¥)

skapad_tid (relativ tid + tooltip exakt)

Sortering: pÃ¥ skapad_tid (default desc), mall, status.

Paginering: 25 / 50 / 100 per sida + â€œGÃ¥ till sida â€¦â€.

Radhovring: visar quickâ€‘actions:

Ã–ppna post (detaljvy i modal eller ny sida)

Flagga/karantÃ¤n

Radera (softâ€‘delete/tombstone; med bekrÃ¤ftelse)

Tomt tillstÃ¥nd: â€œInga poster matchar dina filter â€“ prova att tÃ¶mma sÃ¶k eller Ã¤ndra datumâ€.

B.3 SidofÃ¤lt â€“ â€œLinage/Proveniensâ€

Visas nÃ¤r en rad markeras:

Rubrik: â€œProveniens fÃ¶r idâ€

InnehÃ¥ll:

Jobb: id + lÃ¤nk till Jobbdetaljer + typ (Crawl/Scrape/â€¦)

KÃ¤lla/Projekt (namn)

URL (klickbar, Ã¶ppnas i ny flik)

Mall (namn + version)

Policyprofil (namn + id)

RenderingslÃ¤ge som anvÃ¤ndes (HTTP/Browser)

Proxyendpoint (om loggat), geo, UAâ€‘profil

Snapshot:

â€œVisa HTML snapshotâ€ (ny flik eller embedded viewer)

â€œVisa skÃ¤rmdumpâ€ (om finns)

Tidslinje: skapad â†’ validerad â†’ ev. export â†’ ev. radering

Ã…tgÃ¤rder: â€œKopiera hÃ¤rkomst som JSONâ€, â€œÃ–ppna i Browserpanelâ€ (fÃ¶r att Ã¥terskapa vy, om mÃ¶jligt)

B.4 SidofÃ¤lt â€“ â€œDQ (Data Quality)â€

Valideringsregler som kÃ¶rts (lista; namn, regeltyp, resultat âœ“/âœ—, tid)

Felorsaker (om karantÃ¤n): regel â†’ beskrivning â†’ felvÃ¤rde â†’ fÃ¶rslag

FÃ¤lttÃ¤ckning: % fÃ¤lt med data (progressbar)

Ã…tgÃ¤rder:

â€œMarkera som valideradâ€ (om felet Ã¤r manuellt Ã¥tgÃ¤rdat)

â€œLÃ¤gg till kommentar/etikettâ€

â€œÃ–ppna felposter med samma regelâ€ (lÃ¤nk till fÃ¶rfiltrerad vy)

B.5 Detaljvy (modal eller separat sida)

Flikar:

Data (formatterad JSON + fÃ¤ltnamn som rubriker; kopiera/expandera)

RÃ¥kÃ¤lla (HTML snapshot i viewer + â€œHÃ¤mta som .htmlâ€)

Bild(er) (om skÃ¤rmdump/bilagor finns)

HÃ¤rkomst (samma som sidofÃ¤lt, men stÃ¶rre)

Ã„ndringshistorik (statusbyten, kommentarer, exporthÃ¤ndelser)

Snabbknappar: â€œExportera denna postâ€, â€œRadera (tombstone)â€, â€œÃ–ppna relaterade posterâ€ (samma item_key i annan kÃ¶rning)

B.6 Statushantering

Validerad: passerat alla blockerande regler; exportbar.

KarantÃ¤n: blockerande DQâ€‘regel slog; exkluderas frÃ¥n â€œOKâ€ exportprofiler.

Tombstone: mjuk radering (behÃ¥ller audit/diff), visas endast om â€œvisa raderadeâ€ Ã¤r pÃ¥.

B.7 ExportflÃ¶de (urval)

Exportera urval Ã¶ppnar dialog:

Format: CSV / JSON / Parquet / DBâ€‘tabell / Webhook

FÃ¤ltschema: vÃ¤lj kolumner, alias, ordning

Filuppdelning: max rader/fil

Destination: lokal fil (nedladdning) / lagring / DBâ€‘tabell (MySQL)

Postfilter: endast validerad (default) / inkludera karantÃ¤n (checkbox)

Starta export â†’ skapar Exportâ€‘jobb (asynkront, lÃ¤nk till Exporthistorik)

Exportprogress: liten toaster + badge i toppnavigering.

B.8 Radera enligt policy (bulk)

Ã–ppnar dialog: â€œBekrÃ¤fta raderingâ€ + visar policytext (retention, tombstone)

Alternativ: tombstone (soft), permanent (om policy tillÃ¥ter, krÃ¤ver Admin)

KrÃ¤ver bekrÃ¤ftelse (â€œSkriv RADERAâ€)

KÃ¶rs asynkront; progress i notifieringar.

B.9 TillgÃ¤nglighet & UXâ€‘polish

Tabâ€‘navigering genom tabell; Enter Ã¶ppnar detalj.

â€œVisa som tabell/kortâ€: kortlÃ¤ge visar 6â€“8 nyckelfÃ¤lt per post.

â€œVisa som tabellâ€ â†’ â€œVisa som tabell (kompakt)â€ (tÃ¤ta rader).

KolumnvÃ¤ljare sparas per anvÃ¤ndare/vy.

Snabbfilterchips under sÃ¶k: status:karantÃ¤n, mall:vehicle_detail_v1 etc.

C) Kommandon (curl/SQL) â€“ kÃ¶rbara exempel
C.1 Lista poster (med serverâ€‘paginering)
# 25 senaste, endast validerade, mall=vehicle_detail_v1, projekt=12
curl -s "http://localhost:8000/api/items?project_id=12&template=vehicle_detail_v1&status=validated&limit=25&offset=0&sort=created_at:desc" | jq

C.2 Fri textsÃ¶k
# SÃ¶k efter "Volvo" i fÃ¤ltvÃ¤rden och url, 7 dagar bakÃ¥t
FROM=$(date -u -d "-7 days" +"%Y-%m-%dT%H:%M:%SZ")
TO=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
curl -s "http://localhost:8000/api/items/search?q=Volvo&from=$FROM&to=$TO" | jq

C.3 Ã–ppna en post (detalj)
curl -s "http://localhost:8000/api/items/it_123456" | jq

C.4 Flagga/karantÃ¤n (enstaka)
curl -s -X POST "http://localhost:8000/api/items/it_123456/quarantine" \
  -H "Content-Type: application/json" \
  -d '{"reason":"missing_reg_number","note":"manuell granskning"}' | jq

C.5 Exportera urval (starta exportjobb)
curl -s -X POST "http://localhost:8000/api/exports" \
  -H "Content-Type: application/json" \
  -d '{
    "format":"csv",
    "filter":{"project_id":12,"status":["validated"],"template":["vehicle_detail_v1"]},
    "columns":["id","payload.reg_number","payload.title","created_at"],
    "destination":{"type":"file","path":"exports/vehicles.csv"},
    "split":{"max_rows":500000}
  }' | jq

C.6 Radera enligt policy (bulk â€“ tombstone)
curl -s -X POST "http://localhost:8000/api/items/bulk-delete" \
  -H "Content-Type: application/json" \
  -d '{"filter":{"project_id":12,"status":["quarantine"]}, "mode":"tombstone"}' | jq

D) Vad som hÃ¤nder (backend & DB)
D.1 SÃ¶k & filtrering

Serverâ€‘paginering: limit/offset (eller cursor) mot MySQL.

Fri text: fulltextsÃ¶kning pÃ¥ uppmappade fÃ¤lt (payload_json â†’ genererade â€œsÃ¶kâ€‘kolumnerâ€), url, item_key.

Filter: byggs till SQLâ€‘villkor; tidsfilter mot created_at.

D.2 MySQLâ€‘schema (relevant)

extracted_items(id, job_id, project_id, template_id, template_version, item_key, payload_json, status ENUM('validated','quarantine','tombstone'), created_at, snapshot_path, screenshot_path, url, policy_id, render_mode, proxy_endpoint, ua_profile, tags JSON)

dq_violations(id, item_id, rule, message, field, created_at)

jobs(id, type, project_id, status, started_at, finished_at, â€¦)

templates(id, name, version, â€¦)

policies(id, name, â€¦)

exports(id, filter_json, status, path, created_at, finished_at, â€¦)

D.3 Index (prestanda)
CREATE INDEX IF NOT EXISTS idx_items_created ON extracted_items(created_at);
CREATE INDEX IF NOT EXISTS idx_items_status ON extracted_items(status);
CREATE INDEX IF NOT EXISTS idx_items_project ON extracted_items(project_id, created_at);
CREATE INDEX IF NOT EXISTS idx_items_template ON extracted_items(template_id, template_version, created_at);
CREATE INDEX IF NOT EXISTS idx_items_url ON extracted_items(url(191));
-- Valfritt: generera sÃ¶kbara kolumner (t.ex. reg_number) och indexera dem

D.4 Exportjobb

Skapas i exports med status pending â†’ worker plockar â†’ skriver fil/DB â†’ status completed + checksumma.

D.5 Radering

Tombstone: sÃ¤tter status='tombstone' + skriver audit_event.

Permanent (om policy tillÃ¥ter): raderar rad + skriver tombstoneâ€‘rad i audit (utan payload).

E) Verifiering (sÃ¥ kontrollerar du att allt stÃ¤mmer)
E.1 Antal rader matchar filter
-- RÃ¤kna i DB vad UI visar
SELECT COUNT(*) 
FROM extracted_items 
WHERE project_id=12 AND status='validated'
  AND created_at BETWEEN NOW() - INTERVAL 7 DAY AND NOW();


StÃ¤m av mot radsiffror i UI (ta hÃ¤nsyn till vald paginering).

E.2 Export i Exporthistorik
SELECT id, status, path FROM exports ORDER BY created_at DESC LIMIT 5;


FÃ¶rvÃ¤ntat: ditt exportjobb finns med completed, path pekar pÃ¥ filen; UI visar samma rad.

E.3 DQâ€‘orsak (karantÃ¤n)
SELECT item_id, rule, message 
FROM dq_violations 
WHERE item_id='it_123456';


FÃ¶rvÃ¤ntat: samma regel & text syns i sidofÃ¤ltet â€œDQâ€.

F) Acceptanskriterier & E2Eâ€‘testfall
DoD â€“ funktion

SÃ¶k/filtrering returnerar resultat pÃ¥ < 500 ms fÃ¶r 1M+ rader (med index).

Serverâ€‘paginering konsekvent; sortering stabil.

Ã–ppna post visar data, snapshot/screenshotâ€‘knappar och full proveniens.

DQâ€‘flik listar regler, orsak(er) och ger Ã¥tgÃ¤rder.

Exportera urval startar jobb, visas i Exporthistorik, filen laddas ner/lagras.

Radera enligt policy uppdaterar status eller raderar; audit skrivs.

RBAC: LÃ¤sare kan inte radera/flagga; OperatÃ¶r kan; Admin kan permanentâ€‘radera.

TillgÃ¤nglighet: alla kontrollers etiketter, tabâ€‘order korrekt; â€œVisa som tabellâ€.

E2E (Playwright â€“ kort)

TCâ€‘DATAâ€‘01: Filtrera pÃ¥ projekt, mall, 24h â†’ tabell visar rÃ¤tt rader (stÃ¤m av counts).

TCâ€‘DATAâ€‘02: Ã–ppna post â†’ Data/Proveniens/DQ flikar laddar; snapshot kan Ã¶ppnas.

TCâ€‘DATAâ€‘03: SÃ¤tt karantÃ¤n â†’ statuschip Ã¤ndras; dq_violations fÃ¥r rad.

TCâ€‘DATAâ€‘04: Exportera urval â†’ exportjobb â€œrunning â†’ completedâ€; fil kan Ã¶ppnas; radrÃ¤kning stÃ¤mmer.

TCâ€‘DATAâ€‘05: Tombstone bulk â†’ status uppdateras; â€œvisa raderadeâ€ krÃ¤vs fÃ¶r att se dem.

TCâ€‘DATAâ€‘06: LÃ¤sareâ€‘roll saknar raderingsknapp.

4) KÃ¤llor / Projekt
A) Enkel fÃ¶rklaring (ickeâ€‘tekniker)

HÃ¤r skapar och hanterar du dina datakÃ¤llor (webbplatser). Du anger:

startadresser,

om inloggning krÃ¤vs,

var i vÃ¤rlden du vill framstÃ¥ som (geografi),

hur fort vi fÃ¥r gÃ¥ (rateâ€‘limits),

och hur vi ska lÃ¤sa sidorna (rendering, headers, sprÃ¥k, cookieâ€‘samtycke).

Du kan testa Ã¥tkomst (diagnostik), generera en crawlâ€‘plan/sitemap, och direkt starta ett jobb.

B) Detaljerad UI/UXâ€‘spec
B.1 FormulÃ¤rfÃ¤lt (med validering)

Projektnamn (text, obligatoriskt, unik per konto; max 100 tecken)

Beskrivning (lÃ¥ngtext, valfri)

DomÃ¤n(er) (lista med chipâ€‘inmatning; normaliseras utan http(s)://; validering mot punycode)

Startâ€‘URL:er (lista; mÃ¥ste vara http(s) och tillhÃ¶ra angivna domÃ¤ner; dedup)

BehÃ¶righet / Inloggning

Typ: ingen / sessionscookie / grundlÃ¤ggande

FÃ¶r sessionscookie: fÃ¤lt fÃ¶r cookieâ€‘namn + vÃ¤rde; utgÃ¥ngstid; krypterad lagring

FÃ¶r grundlÃ¤ggande: anvÃ¤ndare/lÃ¶senord (maskeras; krypterad lagring)

Testa inloggning (knapp, visar 200/401 och ev. redirect)

Region/Geoâ€‘preferens (dropdown; default SE; multiâ€‘val OK med prioritet)

Robots/ToSâ€‘lÃ¤ge

Respektera (default)

KrÃ¤v manuellt godkÃ¤nnande per domÃ¤n (checkboxlista â€œjag har lÃ¤st och fÃ¶rstÃ¥ttâ€)

Rateâ€‘limit per domÃ¤n (tabell: domÃ¤n â†’ RPS, burst, min_delay_ms, jitter_ms)

FÃ¶rifyllt â€œdefaultâ€â€‘rad som gÃ¤ller alla listade domÃ¤ner.

Crawlâ€‘regler

Djup (heltal; -1 = obegrÃ¤nsat)

Maxâ€‘sidor (heltal; sÃ¤kring)

UppfÃ¶ljningsregler

Inkluderaâ€‘regex (lista)

Exkluderaâ€‘regex (lista)

BegrÃ¤nsa till subdomÃ¤ner (checkbox)

Paginering: nÃ¤staâ€‘selector (CSS/XPath) eller queryâ€‘param mÃ¶nster (page=\d+)

Renderingspolicy

auto (heuristik) / httpâ€‘endast / browser

Timeout (ms), vÃ¤ntestrategi (load/networkidle/selector), blockera ickeâ€‘kritiska resurser (checkbox)

Headersâ€‘profil

Klientprofil: desktop/mobil

SprÃ¥k: sv-SE,sv;q=0.9,en;q=0.7 (default)

Refererâ€‘policy: auto/explicit (fÃ¤lt)

Consentâ€‘strategi

Cookieâ€‘samtycke: tillÃ¥t/krÃ¤v (visa att cookie sÃ¤tts innan hÃ¤mtning om policy krÃ¤ver)

Taggar (chiplista; anvÃ¤nds i filter/rapporter)

B.2 Knappar & Ã¥tgÃ¤rder

Spara (primÃ¤r) â€“ skapar/uppdaterar projektet

Testa Ã¥tkomst â€“ kÃ¶r diagnostik mot 1â€“3 slumpade startâ€‘URL:er

Generera sitemap â€“ bygger â€Crawl Planâ€ (Ã¶ppnar sida 6 med fÃ¶rifyllt)

Skapa jobb â€“ Ã¶ppnar Job Launcher (sida 7) med projekt valt

Klona projekt â€“ duplicerar instÃ¤llningar (utan hemligheter)

Arkivera projekt â€“ sÃ¤tter archived=true (dÃ¶ljs i listor)

B.3 Diagnostik (Ã¥terkoppling i UI)

Ping varje domÃ¤n (DNS + HTTPS) â†’ statuschips (OK/Varning/Fel)

HÃ¤mta 1 startâ€‘URL (HTTP)

Svarskod, laddtid, HTMLâ€‘lÃ¤ngd, titeltagg

Heuristik: behov av browser (JS tung?)

Antiâ€‘bot indikatorer (textmatch: â€œAccess deniedâ€, â€œAttention Requiredâ€ etc.) â†’ Informativa varningar (ingen bypass)

Robots.txt:

Laddad? tillÃ¥ter Userâ€‘Agent: <vÃ¥r UA>? block? â†’ visa radutdrag

Sitemap.xml: hittad? URL:er funna? â†’ lÃ¤nk till fÃ¶rhandsvisning

Sammanfattning: â€œÃ…tkomst OK / varningarâ€ + rekommendationer (sÃ¤nk RPS, Ã¶ka delay, aktivera browser pÃ¥ listor eller detaljsidor)

B.4 Generera sitemap (Crawl Plan, kort i denna vy)

Preview: antal hittade lÃ¤nkar (unika), domÃ¤nfÃ¶rdelning, detekterade pagineringslÃ¤nkar

Knappar: â€œAnvÃ¤nd som planâ€ (skapar plan) / â€œJustera reglerâ€ (gÃ¥r till sida 6)

B.5 TillgÃ¤nglighet & UXâ€‘polish

Fieldâ€‘level fel inline; â€œSparaâ€ disabled tills kritiska fÃ¤lt giltiga.

Sektioner i accordion (kompakt).

HjÃ¤lpâ€‘ikoner (i) med korta fÃ¶rklaringar (t.ex. vad burst betyder).

â€œTesta Ã¥tkomstâ€ visar resultat i en kompakt loggpnl (kollapsbar).

KÃ¤nsliga fÃ¤lt mÃ¤rkta med nyckelikon; â€œvisa/dÃ¶ljâ€ lÃ¶senord.

C) Kommandon (curl/SQL) â€“ kÃ¶rbara exempel
C.1 Skapa projekt
curl -s -X POST "http://localhost:8000/api/projects" \
  -H "Content-Type: application/json" \
  -d '{
    "name":"Vehicles SE",
    "description":"Svenska fordonslistor och detaljer",
    "domains":["example.se","foo.example.se"],
    "start_urls":["https://example.se/lista","https://foo.example.se/start"],
    "auth":{"type":"none"},
    "geo":["SE"],
    "robots_mode":"respect",
    "rate_limits":[{"domain":"default","rps":1.5,"burst":3,"min_delay_ms":300,"jitter_ms":250}],
    "crawl_rules":{
      "depth":3,"max_pages":5000,
      "include":["https://example.se/lista.*","https://example.se/detalj/.*"],
      "exclude":[".*\\?utm_.*"],
      "pagination":{"mode":"selector","value":"a.next"}
    },
    "rendering":{"mode":"auto","timeout_ms":15000,"wait":"networkidle","block_non_essential":true},
    "headers":{"profile":"desktop","accept_language":"sv-SE,sv;q=0.9,en;q=0.7","referer_policy":"auto"},
    "consent":{"mode":"allow"},
    "tags":["vehicles","se"]
  }' | jq

C.2 Testa Ã¥tkomst (diagnostik)
curl -s -X POST "http://localhost:8000/api/projects/proj_123/diagnose" | jq

C.3 Generera sitemap (plan)
curl -s -X POST "http://localhost:8000/api/projects/proj_123/generate-plan" \
  -H "Content-Type: application/json" \
  -d '{"sample_pages": 200, "follow_external": false}' | jq

C.4 Skapa jobb frÃ¥n projekt
curl -s -X POST "http://localhost:8000/api/jobs" \
  -H "Content-Type: application/json" \
  -d '{"type":"crawl+scrape","project_id":"proj_123","template_id":"tpl_vehicle_v1","plan_id":"plan_789","concurrency":4}' | jq

D) Vad som hÃ¤nder (backend & DB)
D.1 DBâ€‘tabeller (MySQL)

projects(id, name, description, archived, created_at, updated_at)

project_domains(project_id, domain)

project_start_urls(project_id, url)

project_auth(project_id, type, user, password_enc, cookie_json, updated_at)

project_geo(project_id, country_code, priority)

project_rate_limits(project_id, domain, rps, burst, min_delay_ms, jitter_ms)

project_crawl_rules(project_id, depth, max_pages, include_json, exclude_json, pagination_json)

project_rendering(project_id, mode, timeout_ms, wait, block_non_essential)

project_headers(project_id, profile, accept_language, referer_policy)

project_consent(project_id, mode)

project_tags(project_id, tag)

diagnostics(project_id, ts, result_json) (senaste resultat fÃ¶r UI)

crawl_plans(id, project_id, rules_json, created_at)

D.2 Validering & normalisering

DomÃ¤ner normaliseras (lowercase, utan schema).

Startâ€‘URL mÃ¥ste matcha listade domÃ¤ner (annars fel).

Auth lagras krypterat; servern visar aldrig klardata i APIâ€‘svar.

Robots/sitemapâ€‘caches (TTL), med â€œinvalidateâ€ i UI.

D.3 Diagnostik

HÃ¤mtar robots.txt (om robots_mode=respect) â†’ sparar utdrag.

KÃ¶r HEAD/GET mot 1â€“3 startâ€‘URL:er med default headers â†’ loggar kod, tid, ev. nyckelindikatorer.

Om rendering.mode=browser: kÃ¶r en browserâ€‘render pÃ¥ fÃ¶rsta URL:en och mÃ¤ter â€œfirst contentful DOM lengthâ€.

E) Verifiering (sÃ¥ kontrollerar du att allt stÃ¤mmer)
E.1 Projekt skapat?
SELECT id, name FROM projects WHERE name='Vehicles SE';
SELECT domain FROM project_domains WHERE project_id='proj_123';
SELECT url FROM project_start_urls WHERE project_id='proj_123';


FÃ¶rvÃ¤ntat: rader finns; domÃ¤ner/URL:er korrekta.

E.2 Diagnostikresultat
SELECT ts, JSON_EXTRACT(result_json, '$.summary.status') AS status
FROM diagnostics WHERE project_id='proj_123'
ORDER BY ts DESC LIMIT 1;


FÃ¶rvÃ¤ntat: status = ok eller warnings.

E.3 Plan skapad?
SELECT id, created_at FROM crawl_plans WHERE project_id='proj_123' ORDER BY created_at DESC LIMIT 1;


FÃ¶rvÃ¤ntat: en plan_id finns; UI pekar pÃ¥ samma.

F) Acceptanskriterier & E2Eâ€‘testfall
DoD â€“ funktion

Spara skapar/uppdaterar projekt och alla underresurser (domÃ¤ner, startâ€‘URL, regler) i en transaktion.

Testa Ã¥tkomst visar status per domÃ¤n & startâ€‘URL med tydliga fÃ¶rslag (ingen bypass, enbart diagnos).

Generera sitemap producerar en plan som kan anvÃ¤ndas direkt i Job Launcher.

Skapa jobb Ã¶ppnar Job Launcher med alla fÃ¤lt fÃ¶rifyllda.

RBAC: LÃ¤sare kan se projekt, inte Ã¤ndra; OperatÃ¶r kan testa/planera; Admin kan Ã¤ndra auth & radera.

KÃ¤nsliga fÃ¤lt (lÃ¶sen/sessionscookie) visas aldrig i klartext i APIâ€‘loggar/UI (endast â€œuppdaterat fÃ¶r X min sedanâ€).

All tid i UI visas i Europe/Stockholm; API returnerar UTC.

E2E (Playwright â€“ kort)

TCâ€‘PROJâ€‘01: Skapa projekt (utan auth) â†’ diagnostik OK â†’ generera plan â†’ skapa jobb â†’ jobb startar.

TCâ€‘PROJâ€‘02: SÃ¤tt sessionscookie â†’ diagnostik visar 200 med cookie; logga XSSâ€‘sÃ¤ker maskning.

TCâ€‘PROJâ€‘03: Robots Disallow: /detalj/ â†’ diagnostik varnar; UI visar utdrag; â€œrespekteraâ€ lÃ¤get hindrar plan frÃ¥n att innehÃ¥lla detaljsidor.

TCâ€‘PROJâ€‘04: Felaktig startâ€‘URL domÃ¤n â†’ inline fel; spara avbryts.

TCâ€‘PROJâ€‘05: Byt rendering till browser och blockera bilder â†’ diagnostik visar kortare laddtid, men datafÃ¤lten kvar.

TCâ€‘PROJâ€‘06: Klona projekt â†’ ny post utan hemligheter; domÃ¤ner/URLer kopieras.

Snabb â€œhurâ€‘duâ€‘gÃ¶râ€ (sammanhÃ¤ngande demo)

1) Skapa projekt â†’ testa â†’ plan â†’ jobb

# Skapa
curl -s -X POST http://localhost:8000/api/projects -H "Content-Type: application/json" -d '{...}'

# Diagnostik
curl -s -X POST http://localhost:8000/api/projects/proj_123/diagnose | jq

# Generera plan
curl -s -X POST http://localhost:8000/api/projects/proj_123/generate-plan -d '{"sample_pages":200}' -H "Content-Type: application/json" | jq

# Starta jobb
curl -s -X POST http://localhost:8000/api/jobs -d '{"type":"crawl+scrape","project_id":"proj_123","plan_id":"plan_789","template_id":"tpl_vehicle_v1","concurrency":4}' -H "Content-Type: application/json" | jq


2) Se data i Datalager

curl -s "http://localhost:8000/api/items?project_id=proj_123&limit=25" | jq


3) Exportera 7 dagars validerade fordonsdetaljer

FROM=$(date -u -d "-7 days" +"%Y-%m-%dT%H:%M:%SZ")
TO=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
curl -s -X POST "http://localhost:8000/api/exports" -H "Content-Type: application/json" \
  -d "{\"format\":\"csv\",\"filter\":{\"project_id\":\"proj_123\",\"status\":[\"validated\"],\"from\":\"$FROM\",\"to\":\"$TO\"},\"columns\":[\"id\",\"payload.reg_number\",\"created_at\"],\"destination\":{\"type\":\"file\",\"path\":\"exports/last7d.csv\"}}" | jq

Extra UXâ€‘fÃ¶rslag (gÃ¶r det riktigt bra)

Autospara i Projektâ€‘formulÃ¤ret sektion fÃ¶r sektion.

Guidade tips efter diagnos: â€œVi rekommenderar attâ€¦â€ knappar som uppdaterar formulÃ¤ret Ã¥t dig.

Kolumnprofiler i Datalager: â€œAnalytikerâ€‘lÃ¤geâ€ (fler fÃ¤lt), â€œOperatÃ¶râ€‘lÃ¤geâ€ (fÃ¤rre fÃ¤lt, mer status).

Klipp & klistra selektorer/regex med exempel (fÃ¶r paginering/inkluderaâ€‘regler).

Undo snackbar efter karantÃ¤n/radering (30 s Ã¥terstÃ¤llningsfÃ¶nster fÃ¶r misstag).




5) Template Wizard (Extraktionsmallar)
MÃ¥l & Scope

Skapa, testa och versionera extraktionsmallar (schema + selektorer + transformers + validering) fÃ¶r bÃ¥de listâ€‘ och detaljsidor.

Snabb feedback via fÃ¶rhandsvisning (HTTP eller headless browser), selectorâ€‘overlay, och DQT.

Mallar anvÃ¤nds av jobb/kÃ¶rningar och Ã¤r versionslÃ¥sta nÃ¤r de publiceras.

Informationsarkitektur & Layout

VÃ¤nster panel (Steg & Navigation):

Steg 1: Metadata

Steg 2: MÃ¥ltyp & struktur

Steg 3: Lista/Detalj & Loopâ€‘konfiguration

Steg 4: FÃ¤lt & Selektorer

Steg 5: Transformers & Validering

Steg 6: Nycklar & Dubbletter

Steg 7: RenderingslÃ¤ge & Provâ€‘URL

Steg 8: DQT & Regeltester

Steg 9: FÃ¶rhandsvisa & Resultat

Steg 10: Spara & Publicera

Mitten (PrimÃ¤r arbetsyta): formulÃ¤r/konfigurationer per steg, tabbar fÃ¶r FormulÃ¤r | DSLâ€‘vy (readâ€‘only nÃ¤r mall Ã¤r publicerad) | Historik.

HÃ¶ger panel (Liveâ€‘hjÃ¤lp & Status):

Tips (kontekstuell), Valideringsstatus (obligatoriska fÃ¤lt), Snabbkommandon, Missar/varningar, DQTâ€‘summering.

Global header:

â€œÃ–ppna Selector Overlayâ€, â€œFÃ¶rhandsvisa resultatâ€, â€œSparaâ€, â€œPubliceraâ€, â€œRegeltester (DQT)â€.

Autosaveâ€‘indikator (utkast, offlineâ€‘queue).

Steg & FÃ¤lt (med default, validering & UXâ€‘detaljer)
Steg 1: Metadata

Mallnamn (text, obligatoriskt). Validering: 3â€“64 tecken, aâ€‘z0â€‘9â€‘_â€‘blanksteg. Unikt i kombination med mÃ¥ltyp. Inlineâ€‘feedback.

Version (auto Ã¶kas vid publicering). UX: Visas som v1 (utkast), v2 (publicerad) osv.

Beskrivning (textarea, valfritt). FÃ¶r teamets kontext.

Taggar (chips, valfritt) â€” fÃ¶r filtrering/sÃ¶k.

Steg 2: MÃ¥ltyp & struktur

MÃ¥ltyp (radio): Fordon | Person | FÃ¶retag | Annat.

Outputâ€‘schema:

Rootâ€‘typ: object (default).

FÃ¤ltlista (tabell + â€œLÃ¤gg till fÃ¤ltâ€):

FÃ¤ltnamn (obligatoriskt, snakeCase/kebabCase autoâ€‘fÃ¶rslag).

Typ (dropdown): string, number, integer, boolean, date, datetime, array<string|object>, object.

Beskrivning (valfritt).

Obligatorisk? (checkbox).

ExempelvÃ¤rde (valfritt, anvÃ¤nds i DQTâ€‘prober).

UX: Inlineâ€‘ikon nÃ¤r ett fÃ¤ltnamn kolliderar eller typincompatibel transformer valts.

Steg 3: Lista/Detalj & Loopâ€‘konfiguration

Sidor:

Listâ€‘sida (checkbox) med fÃ¤lt:

Selector fÃ¶r listâ€‘items (CSS/XPath).

DetaljlÃ¤nkâ€‘selector (CSS/XPath) â€” kan vara relativ/absolut; normaliseras.

Pagineringstyp: NÃ¤staâ€‘knapp | Queryâ€‘param | Infinite scroll.

Pagineringâ€‘selector/regel (beroende av typ).

Max items per sida (default 100).

Stopâ€‘villkor (regex pÃ¥ URL/DOM, item count stagnation, tidsbudget).

Detaljâ€‘sida (checkbox) med URLâ€‘mÃ¶nster (regex) och ev. â€œfÃ¶lj lÃ¤nkar frÃ¥n listorâ€.

Loopâ€‘parametrar:

Max loopvarv (default 10) â€” skydd mot Ã¤ndlÃ¶st scroll.

Delay mellan varv (ms, jitter mÃ¶jlig).

UX: â€œProva listâ€‘selectorâ€ visar antal hittade noder + highlight i overlay.

Steg 4: FÃ¤lt & Selektorer

FÃ¤ltlista (utÃ¶kad tabell):

FÃ¤ltnamn (lÃ¥st frÃ¥n Steg 2 men kan redigeras innan publicering).

Selector (CSS/XPath) â€” stÃ¶d fÃ¶r fallbackâ€‘kedja (t.ex. primÃ¤r + alternativ).

Scope: listItem | detailPage | global (var hÃ¤mtas).

Attr: text | innerHTML | @href | @src | data-* (dropdown).

Multiple? (arrayâ€‘lÃ¤ge) â‡’ Joinâ€‘policy: concat | first | json.

DefaultvÃ¤rde (om tomt).

Trim? (toggle), Normalize whitespace? (toggle).

Preâ€‘transformers (drarâ€‘ochâ€‘slÃ¤pper i pipeline).

UX:

Inâ€‘cell Testa selector â†’ visar provvÃ¤rde i tooltip + highlight i overlay.

Autocomplete fÃ¶r CSS/XPath (lÃ¤r sig av tidigare mallar).

Steg 5: Transformers & Validering

Transformerâ€‘bibliotek (byggblock som kan kedjas, med konfig):

text.trim, text.regex_extract(pattern, group), text.replace,
date.parse(locale,tz,formats[]), number.parse(locale),
currency.extract(iso?), string.slugify, string.upper/lower/title,
id.luhn_check (validerare eller transformer), json.parse,
url.normalize(base), phone.parse(region), plate.normalize, vin.normalize.

Validering per fÃ¤lt:

Typkontroll (frÃ¥n schema).

RegEx (custom), Enum (lista), Range (min/max), Length (min/max).

Luhn (toggle) fÃ¶r idâ€‘liknande fÃ¤lt.

KorsfÃ¤ltsregler (t.ex. start_date <= end_date).

Felpolicy:

On fail: mark as null | drop field | drop record | warn.

Severity: info | warning | error | blocker (pÃ¥verkar DQT).

UX: â€œKÃ¶r pipeline pÃ¥ provvÃ¤rdeâ€ inline; visar varje steg fÃ¶re/efter.

Steg 6: Postâ€‘unik nyckel & Duplicathantering

PrimÃ¤r nyckelpolicy:

Key spec: vÃ¤lj 1..N fÃ¤lt som ingÃ¥r i nyckeln.

Hashâ€‘algoritm: SHAâ€‘256 (default) | SHAâ€‘1 | MD5 (MD5 varnas).

Salt/Namespace (valfritt).

Normaliseringsregel: sortera fÃ¤ltnamn, |â€‘delim, unicodeâ€‘NFKC.

Dubblettpolicy:

Senaste vinner (timestampfÃ¤lt, default fetched_at).

Ignorera dubbletter (fÃ¶rsta vinner).

Merge (fÃ¤ltvis merge med prioritet: nyaste ickeâ€‘null).

UX: Snabbâ€‘simulering pÃ¥ provdataset: hur mÃ¥nga skulle kollidera?

Steg 7: RenderingslÃ¤ge & Provâ€‘URL

Provâ€‘URL (obligatoriskt fÃ¶r fÃ¶rhandsvisning).

RenderingslÃ¤ge:

Auto (heuristik: om script> X, fetch/ajax, cookies â‡’ Browser).

HTTP (snabb, billig; utan JS).

Browser (headless; Playwright):

Waitâ€‘strategi: DOMContentLoaded | networkidle | selector('â€¦').

Viewport (px), Userâ€‘Agentâ€‘profil, Geolocation/Timezone (valfritt).

Antiâ€‘botâ€‘profil (rotering, stealth), Cookieâ€‘banner autoâ€‘dismiss (toggle).

Screenshot (keep fÃ¶r DQTâ€‘bilagor).

Cache (toggle) fÃ¶r lokala tests, TTL (minuter).

UX: Liten kostnadsindikator (estimerad ms/kr per kÃ¶rning).

Steg 8: DQT & Regeltester

Regeltyper:

Completeness: % ifyllda obligatoriska fÃ¤lt â‰¥ trÃ¶skel.

Uniqueness: ingen nyckelkollision pÃ¥ provmÃ¤ngd.

Validity: regex/enum/luhn pass rate â‰¥ trÃ¶skel.

Schemaâ€‘konformans: typmatchning, array/object form.

Anomali: outliers i numeriska fÃ¤lt (IQR/Ïƒ), ovÃ¤ntade kategorier.

TrÃ¶sklar (per regel och globalt).

Blockerande fel: definierar publiceringsspÃ¤rr.

Rapport: tabell + badges + lÃ¤nkar till konkreta poster, samt evidens (DOMâ€‘snapshot, skÃ¤rmdump, rÃ¥payload, felsteg i pipeline).

Steg 9: FÃ¶rhandsvisning & Resultat

KÃ¶r vald renderingsmotor, applicera selektorer, transformers, validering.

Dataâ€‘grid:

Kolumn per fÃ¤lt, rad per hittad post.

Cellstatus: âœ“ (OK), ! (varning), âœ• (fel), â€¢ (saknas).

Column profiler (hover): nullâ€‘rate, distinctâ€‘count, toppvÃ¤rden.

Exportera provdata (CSV/JSON) fÃ¶r offlinegranskning.

DOMâ€‘overlay synk: klick pÃ¥ cell â‡’ highlight i DOM & selector.

Steg 10: Spara & Publicera

Spara mall: skapar/uppdaterar utkast; versionsnummer Ã¤ndras inte.

Publicera:

KÃ¶r DQT (mÃ¥ste ha 0 blockerande fel och âœ“ pÃ¥ alla obligatoriska fÃ¤lt).

Fryser DSL och skapar ny version (vN).

Releaseâ€‘notes (kort text).

Referensâ€‘ID att anvÃ¤nda i jobb.

Rollback: tillÃ¥ten till tidigare publicerad version (readâ€‘only diffvisning).

Knappar & Interaktioner

Ã–ppna Selector Overlay â†’ Ã¶ppnar sida i inbyggd BrowserPanel, injicerar Ã¶verlÃ¤gg fÃ¶r klickâ€‘attâ€‘kopiera CSS/XPath. Kan skickas tillbaka till fÃ¤lt via â€œsend toâ€¦â€.

FÃ¶rhandsvisa resultat â†’ triggar render + extraktion + tabellprofil.

Spara mall â†’ lokal validering; autosave var 10:e sekund och vid blur.

Publicera â†’ validering + DQT + versionslÃ¥s + releaseâ€‘notes.

Regeltester (DQT) â†’ kÃ¶rs fristÃ¥ende och i publiceringsflÃ¶de.

DSL / Export (exempel, fÃ¶rankrat i UIâ€‘fÃ¤lten)
template:
  name: vehicle_detail
  version: 3
  target: vehicle
  render:
    mode: auto            # http|browser|auto
    wait_for: "networkidle"
    viewport: { width: 1366, height: 768 }
  pages:
    list:
      item_selector: "ul.results > li"
      detail_link: "a.result-link@href"
      pagination:
        type: next_button
        selector: "a.next"
        max_loops: 20
    detail:
      url_pattern: "example.com/vehicles/.*"
  fields:
    - name: vin
      scope: detailPage
      selector:
        anyOf:
          - "span#vin"
          - "//div[@class='vin']/text()"
      attr: text
      required: true
      transforms:
        - text.trim: {}
        - string.upper: {}
      validate:
        regex: "^[A-HJ-NPR-Z0-9]{17}$"
        luhn: false
    - name: price
      scope: detailPage
      selector: ".price"
      transforms:
        - text.trim: {}
        - currency.extract: { iso: "SEK" }
        - number.parse: { locale: "sv-SE" }
      validate:
        range: { min: 1000 }
  primary_key:
    fields: ["vin"]
    hash: { algo: "sha256", salt: "fleet" }
  dedup:
    policy: "latest_wins"
    timestamp_field: "fetched_at"
  dqt:
    thresholds:
      completeness: 0.98
      validity: 0.97
      uniqueness: 1.0

Edge cases & SkyddsrÃ¤cken

Dynamiska DOMâ€‘Ã¤ndringar (MutationObserver i overlay).

Lazyâ€‘load (scrollâ€‘simulering i browserâ€‘lÃ¤ge).

Relativa URL:er, canonical/redirectâ€‘hantering.

FlersprÃ¥kiga datum/tal (locale/tz via renderâ€‘instÃ¤llningar).

Antiâ€‘bot (rate, headers, fingerprint, cookieâ€‘banners).

Sessioner/login (stÃ¶d via Form Flows separat, men mall kan anta inloggat lÃ¤ge).

Strikt sandbox fÃ¶r regex (catastrophic backtrackingâ€‘guard).

Stora tabeller (virt. scroll i DataGrid, deltaâ€‘fetch).

Prestanda & Stabilitet

FÃ¶rhandsvisning kÃ¶rs mot cache (TTL) dÃ¤r mÃ¶jligt.

Browserâ€‘instanser poolas (max samtidiga previews).

Selektorâ€‘kompilation cacheas.

Tidsbudget per preview (t.ex. 15s) + tydliga timeouts.

TillgÃ¤nglighet & SnabbflÃ¶de

Fullt tangentbord:

âŒ˜/Ctrl+S Spara, âŒ˜/Ctrl+Enter FÃ¶rhandsvisa, âŒ¥/Alt+P Publicera.

F fÃ¶r att fokusera selectorâ€‘fÃ¤ltet, O fÃ¶r Overlay.

ARIAâ€‘labels, kontrast, fokusringar, tabâ€‘ordning.

Tooltips med exempel & â€œvisa/snabbklistraâ€ fÃ¶r regex.

RÃ¤ttigheter & SpÃ¥rbarhet

RBAC: â€œEditorâ€ kan spara utkast, â€œPublisherâ€ fÃ¥r publicera.

Audit log: vem Ã¤ndrade vad + diff (fÃ¤lt, selektorer, regler).

Observability

EventspÃ¥rning: template.preview.start|end, template.publish, dqt.run.

Metrix: previewâ€‘latens, error rate, selectorâ€‘trÃ¤ffgrad, DQTâ€‘score.

Testfall & Acceptanskriterier (urval)

Obligatoriska fÃ¤lt: grÃ¶n bock visas nÃ¤r alla req. fÃ¤lt extraheras.

DQT: 0 blockerande fel krÃ¤vs fÃ¶r â€œPubliceraâ€ (knapp disabled annars).

Preview: domâ€‘overlay highlightar korrekt nod vid cellâ€‘klick.

Dedup: kollisioner simuleras korrekt med vald hashpolicy.

RenderingslÃ¤ge: Auto vÃ¤ljer Browser nÃ¤r DOM krÃ¤ver JS (heuristik).

6) Crawl Plan / Sitemapâ€‘studio
MÃ¥l & Scope

Definiera hur URL:er hittas, begrÃ¤nsas och schemalÃ¤ggs fÃ¶r hÃ¤mtning.

Simulera lÃ¤nkupptÃ¤ckt, paginering och fÃ¶rvÃ¤ntad runtime/kostnad innan kÃ¶rning.

Spara plan och kÃ¶r som jobb med valda resurspolicys (politeness).

Informationsarkitektur & Layout

VÃ¤nster: Planmetadata & regler grupperade i sektioner.

Mitten: Form + Simuleringsresultat (graf + tabell).

HÃ¶ger: Policyâ€‘sammanfattning (robots/hosts), Budgetar, Status.

FÃ¤lt & Regler (med validering & UX)
Metadata

Namn (obligatoriskt), Beskrivning (valfritt), Taggar.

Startâ€‘URL:er

Lista (min 1). Validera URLâ€‘format, dubbletter och robots.txtâ€‘status (fÃ¶rhandskoll i bakgrunden).

LÃ¤nkregler

Inkludera (regexlista) â€” matchar normaliserade URL:er (lowercase host, strip trackingâ€‘params enligt lista).

Exkludera (regexlista) â€” prioriterad fÃ¶re inkl.

Djup (max depth frÃ¥n startâ€‘URL) â€” default 3.

DomÃ¤nscope: intern (samma eTLD+1) | subdomÃ¤ner ok | externa tillÃ¥tna.

Canonicals: fÃ¶lj/ignorera rel="canonical" (toggle).

NoFollow: fÃ¶lj nofollow? (default nej, men simulera konsekvens).

UX: Liveâ€‘chip med â€œ% av hittade URL:er som skulle filtreras bortâ€.

Paginering

NÃ¤staâ€‘knapp: selector + maxâ€‘sidor.

Queryâ€‘param: page=N (start, step, stopâ€‘villkor).

Infinite scroll: scrollâ€‘loopar, sentinelâ€‘selector, timeout/stopâ€‘villkor.

UX: â€œTesta pagineringâ€ pÃ¥ en provsida â†’ visar funnen nÃ¤sta eller stopp.

Samtidighet & Politeness

Global samtidighet (default 16).

Perâ€‘vÃ¤rd: samtidiga anslutningar / sekv. delay (ms, jitter).

Rate limits: req/s per vÃ¤rd och globalt.

Backoff: exponential pÃ¥ 429/5xx, max retry, retryâ€‘budget.

Robots.txt respekt (userâ€‘agentâ€‘profil) + crawlâ€‘delay.

Budgetar & Stopp

Max sidor (default 10k).

Timeâ€‘budget (t.ex. 2h).

Bytesâ€‘budget (GB; fÃ¶r bilder/resurser om aktiverat).

Dupeâ€‘budget (max andel duplicerade/canonicals innan stopp).

Ã…terbesÃ¶k & Refresh

Planerad kÃ¶rning: Cron (crontabâ€‘syntax) eller interval (min/h/d).

Change detection: heuristik (Etag/Lastâ€‘Modified, hash av HTML).

Reseed: Ã¥teranvÃ¤nd fÃ¶rra frontier (optional).

Extra policies (avancerat)

URLâ€‘normalisering: lower host, sort params, strip known trackers (utm_*, gclid, fbclid â€¦).

Parampolicy: whitelist/blacklist specifika queryâ€‘params.

Sessionâ€‘stÃ¶d: cookieâ€‘jar per domÃ¤n (valfritt).

HTTPâ€‘headers: UAâ€‘profil, acceptâ€‘lang, accept encoding.

Retryâ€‘klass: pÃ¥ specifika statuskoder, timeouts.

Knappar & FlÃ¶den

Simulera:

TorrkÃ¶rning med begrÃ¤nsande fetch (bara HTML head eller lÃ¤nkextrakt utan full rendering).

Visar antal hittade URL:er, unika per nivÃ¥, hur mÃ¥nga skulle filtreras, berÃ¤knad runtime & kostnad, fÃ¶rvÃ¤ntad pagineringstÃ¤ckning.

Graf: nodâ€‘/kantâ€‘graf (depthâ€‘lager), samt distribution per vÃ¤rd.

Spara plan: lagrar versionerad plan (utkast/publicerad).

KÃ¶r som jobb: Ã¶ppnar Job Launcher med planâ€‘ID fÃ¶r kÃ¶rning nu eller enligt schema.

Vad hÃ¤nder under huven (Simulering)

Linkâ€‘extractor:

Extraherar <a href>, <link>, meta refresh, samt JSâ€‘genererade lÃ¤nkar via lÃ¤tt browserâ€‘probe om aktiverat.

Normaliserar & deâ€‘duperar, fÃ¶ljer base href, hanterar relative â†’ absolute.

RegelutvÃ¤rdering: apply exkludera fÃ¶re inkludera, djupfilter, domÃ¤nscope.

Pagineringstest: kÃ¶r 1â€“2 varv enligt val, rapporterar om â€œnÃ¤staâ€ hittas.

Robotsâ€‘check: snabb HEAD/GET mot robots.txt, visar disallowâ€‘trÃ¤ffar.

Estimering: nURLs / (req/s * parallellism * expected latency), med backofffaktor.

Verifiering & Acceptans

Antal unika URL:er (efter filter) visas.

FÃ¶rvÃ¤ntad runtime och kostnad (om browserâ€‘andel >0, visa separat).

Paginering: â€œNÃ¤sta hittad i X% av provsidorâ€.

Robots: inga blockerande disallow fÃ¶r kritiska paths (annars varning/block).

UXâ€‘detaljer som minimerar friktion

Tomâ€‘tillstÃ¥nd: â€œKlistra in nÃ¥gra startâ€‘URL:er fÃ¶r att bÃ¶rjaâ€.

Regexâ€‘hjÃ¤lp: snabbtest mot exempelâ€‘URL:er, fÃ¤rgkodade matchgrupper.

Massredigering: klistra in 1â€‘perâ€‘rad URL:er; dubblettâ€‘autoâ€‘rensning.

Undo/Redo i formulÃ¤r.

Importera sitemap.xml (parsa, vÃ¤lj namespaces, seed:a startâ€‘mÃ¤ngd).

Exportera URLâ€‘lista (prov) som CSV.

Konfliktvarningar: om externa tillÃ¥tna + djup hÃ¶g + snÃ¤v budget â†’ badge.

Prestanda, Stabilitet & SÃ¤kerhet

Simulering kÃ¶rs med rateâ€‘caps och tidsbudget (t.ex. max 200 sidor/host).

URLâ€‘queue i minne med spill till lokalt lager fÃ¶r stabilitet.

Graceful cancel vid navigering bort/ny simulering.

Inbyggd loopâ€‘detektor (URLâ€‘parametrar som rÃ¤knare â†’ stopp).

TillgÃ¤nglighet & Tangentbord

âŒ˜/Ctrl+Enter Simulera, âŒ˜/Ctrl+S Spara, J KÃ¶r som jobb.

Tabbar och tabeller med ARIAâ€‘roller och liveâ€‘region fÃ¶r â€œSimulering klarâ€.

RÃ¤ttigheter & Audit

RBAC: â€œPlannerâ€ kan skapa/spara, â€œOperatorâ€ kan â€œKÃ¶r som jobbâ€.

Auditâ€‘logg: Ã¤ndringar av regler, simuleringar (param + resultat).

Observability

Event: crawlplan.simulate.start|end, crawlplan.save, crawlplan.run.

Metrics: hittade URL/s, filtreringskvot, robotsâ€‘hits, estimerad vs faktisk runtime (postâ€‘hoc).

Exempel (JSONâ€‘export av plan)
{
  "name": "example_com_listings",
  "start_urls": ["https://example.com/cars"],
  "scope": {"domain": "same_etld1", "max_depth": 3, "externals": false},
  "include": ["^https://example\\.com/cars/.*$"],
  "exclude": ["\\?sort=", ".*(/login|/privacy|/terms).*"],
  "pagination": {"type": "next_button", "selector": "a.next", "max_pages": 20},
  "infinite_scroll": {"enabled": false},
  "concurrency": {"global": 16, "per_host": 4, "delay_ms": 500, "jitter": true},
  "rate_limits": {"global_rps": 8, "per_host_rps": 1.5, "backoff": {"on": [429, 503], "max_retry": 4}},
  "robots": {"respect": true, "user_agent": "CrawlerBot/1.0"},
  "budgets": {"max_pages": 10000, "time_minutes": 120, "bytes_gb": 2},
  "url_normalization": {"strip_params": ["utm_*", "gclid", "fbclid"], "sort_params": true},
  "headers": {"accept_language": "sv-SE,sv;q=0.9", "user_agent_profile": "desktop_chrome"},
  "schedule": {"cron": "0 3 * * *"},
  "estimation": {"enabled": true}
}

Testfall & Acceptanskriterier (urval)

Simulera visar >0 hittade URL:er fÃ¶r giltig startâ€‘URL och lyder filter.

Pagineringstest markeras korrekt (nÃ¤sta funnen/inte funnen).

Robots: disallow pÃ¥ /private syns i varningslistan.

Runtime: estimering ligger inom Â±30% mot liten verklig provkÃ¶rning.

â€œKÃ¶r som jobbâ€ skapar jobb med referens till planâ€‘ID och lÃ¥ser snapshot av planen (immutabel i kÃ¶rningen).

Samspel mellan Template Wizard & Crawl Plan

Crawl Plan producerar URLâ€‘frontier (list/detalj). Template Wizard definierar hur data extraheras pÃ¥ respektive sida.

Vid â€œKÃ¶r som jobbâ€ kan man binda en publicerad mallversion. UI varnar om mall inte matchar mÃ¥ltyp eller om mallens DQT nyligen fÃ¶rsÃ¤mrats (driftdetektion).

Mikrodetaljer fÃ¶r optimal UX

Autosave pÃ¥ utkast (10 s) och vid fÃ¤ltâ€‘blur; offlineâ€‘banner med Ã¥terkÃ¶.

KonfliktlÃ¥sning (optimistisk): varna om annan redigerar samma mall/plan.

SnabbsÃ¶k Ã¶ver fÃ¤lt/selektorer (/ fÃ¶r att sÃ¶ka).

Kopiera som DSL (clipboard) fÃ¶r snabb delning i PR/review.

Diffâ€‘visning mellan versioner (fÃ¤ltâ€‘nivÃ¥ och regelâ€‘nivÃ¥).

Guidade tomtillstÃ¥nd med exempel (â€œLÃ¤gg till VINâ€‘fÃ¤ltâ€¦â€ / â€œKlistra in sitemap.xmlâ€).


7) Job Launcher (Starta Crawl/Extraktion)
MÃ¥l

Starta kÃ¶rningar (crawl, scrape, export, analys) snabbt, sÃ¤kert och Ã¥terupprepbart med tydlig vÃ¤gledning, minsta nÃ¶dvÃ¤ndiga input, bra felmeddelanden och mÃ¶jlighet till fÃ¶rinstÃ¤llningar och torrkÃ¶rning.

UIâ€‘anatomy & layout

Sidtitel + beskrivning: â€œStarta nytt jobbâ€ + kort text om vad jobblÃ¤ge gÃ¶r.

FormulÃ¤r i kort (2 kolumner desktop, 1 kolumn mobil):

Jobbtyp (required): radio eller segmenterade knappar

â€œCrawlâ€, â€œCrawl + Scrapeâ€, â€œScrape frÃ¥n URLâ€‘listaâ€, â€œExportâ€, â€œAnalysâ€.

KÃ¤lla/Projekt (required, dropdown med sÃ¶k): listade projekt/kÃ¤llor anvÃ¤ndaren har rÃ¤ttigheter till.

Tooltip: â€œProjekt anvÃ¤nds fÃ¶r policy, domÃ¤ninstÃ¤llningar, krediter och etikettering.â€

Mall (dropdown, krÃ¤vs fÃ¶r Scrape & Crawl+Scrape): visar endast kompatibla mallar baserat pÃ¥ valt Projekt.

Badge fÃ¶r version och senast uppdaterad.

Previewâ€‘lÃ¤nk Ã¶ppnar modal med fÃ¤lt och testâ€‘exempel.

Crawlâ€‘plan (dropdown, krÃ¤vs fÃ¶r Crawl & Crawl+Scrape): t.ex. sitemap/spiderâ€‘profil.

Visa planens scope (max djup, tillÃ¥tna domÃ¤ner, robotsâ€‘lÃ¤ge).

Prioritet: â€œLÃ¥gâ€, â€œNormalâ€ (default), â€œHÃ¶gâ€.

Tooltip fÃ¶r schemalÃ¤ggningsâ€‘SLA och kÃ¶â€‘position.

Samtidighet (workers): numeriskt steg (1â€¦N med Ã¶vre grÃ¤ns frÃ¥n quota/roll).

Inlineâ€‘hint: â€œRekommenderat: {fÃ¶rslag baserat pÃ¥ planens uppskattade volym}â€.

Renderingsprofil: â€œAutoâ€ (default), â€œHTTPâ€, â€œBrowserâ€.

Auto vÃ¤ljer HTTP och eskalerar till Browser per policy (t.ex. JSâ€‘tung).

Proxyprofil: â€œAutoâ€, â€œStickyâ€, â€œRoterandeâ€; valfri Geo (land/region).

UI visar aktuell poolâ€‘hÃ¤lsa (% ok), klick fÃ¶r detaljer.

Outputâ€‘mÃ¥l: â€œDatabasâ€ (default), â€œFil (CSV/JSON/Parquet)â€, â€œExtern connectorâ€ (Sheets, BigQuery, Snowflake, Elastic, OpenSearch etc.).

Underalternativ exponerar nÃ¶dvÃ¤ndiga fÃ¤lt (bucket/namn/tabell/credentials).

Taggar: chipsâ€‘input med kommatext, autokomplettering av tidigare anvÃ¤nda.

URLâ€‘lista (endast â€˜Scrape frÃ¥n URLâ€‘listaâ€™ & â€˜TorrkÃ¶rningâ€™):

Textarea (en per rad), eller â€œLadda upp .csv/.txtâ€; visa rÃ¤knare (# URL:er).

Avancerat (collapsible):

Rateâ€‘limit overrides (req/s, parallel per domain),

Robots/TOSâ€‘policyâ€‘profil (lÃ¤s/Ã¶verstyr),

Retryâ€‘policy (max attempts, backoff),

Deduplicering (idempotency window, hashâ€‘strategi),

Contentâ€‘lagring (spara rÃ¥ HTML? retentionâ€‘policy),

Max sidor/tidsbudget (hardâ€‘stop),

Postâ€‘processing hooks (t.ex. DQâ€‘checker, PIIâ€‘scanner, deâ€‘identification),

Webhooks (on_start, on_batch, on_complete) med signerad HMAC.

PrimÃ¤ra knappar:

Starta jobb (primary)

TorrkÃ¶rning (secondary; kÃ¶r 5â€“10 URL:er eller 1â€“2 sidor/branch i crawlâ€‘plan)

Spara som fÃ¶rinstÃ¤llning (tertiary)

SekundÃ¤ra element:

FÃ¶rinstÃ¤llningar dropdown (vÃ¤nster om knappar) fÃ¶r att snabbt ladda sparade presets.

Valideringspanel i sidfot som visar sammanfattning â€œ3 saker kvar att fyllaâ€.

Defaults & smarta fÃ¶rslag

Jobbtyp: fÃ¶rifyll baserat pÃ¥ senaste valet per Projekt.

Samtidighet: autoâ€‘fÃ¶rslag = min(rollâ€‘limit, proxyâ€‘kapacitet, crawlâ€‘planens uppskattning).

Renderingsprofil: â€œAutoâ€ med heuristik (domÃ¤npolicy, historik, antiâ€‘bot signaler).

Proxyprofil: â€œAutoâ€ â†’ roterande med hÃ¤lsokontroll + geo nÃ¤ra mÃ¥ldomÃ¤n.

Output: â€œDatabasâ€ till standardâ€‘schema fÃ¶r Projekt; format/connector minns senaste.

Validering (synk & async)

Synk (on change/blur):

Jobbtyp valt (required).

Projekt valt (required, Ã¥tkomstrÃ¤tt).

Mall krÃ¤vs fÃ¶r Scrape & Crawl+Scrape.

Crawlâ€‘plan krÃ¤vs fÃ¶r Crawl & Crawl+Scrape.

Outputâ€‘mÃ¥l uppfyller obligatoriska fÃ¤lt (ex: bucket, tabell, dataset).

Samtidighet inom [1, user/project quota].

URLâ€‘lista: giltiga, unika, normaliserade (scheman, ingen mailto/tel).

Taggar: max 20, varje â‰¤ 40 tecken, aâ€‘z0â€‘9â€‘_.

Async (pÃ¥ â€œStarta jobbâ€):

Policyâ€‘check: robots/TOSâ€‘policy, blocklist, domÃ¤nwhiteâ€‘list.

Krediter/budget: finns tillgÃ¤nglig quota/kostnadsbudget.

Connectorâ€‘hÃ¤lsa: skrivbarhet/credentials.

Mallkompatibilitet: mall â†” projekt â†” renderingsprofil (ex: krÃ¤ver DOM).

Idempotens: finns identiskt jobb i pending/running med samma nycklar?

Misslyckad asyncâ€‘check visar tydlig banner + perâ€‘fÃ¤lt markering + Ã¥tgÃ¤rdsfÃ¶rslag.

â€œSpara som fÃ¶rinstÃ¤llningâ€

Modal: Namn, synlighet (Privat/Team/Org), valbar lÃ¥sningsgrad per fÃ¤lt (ex: lÃ¥s Renderingsprofil och Proxyprofil, lÃ¥t Prioritet och Taggar vara Ã¶ppna).

Spara: POST /api/jobs/presets â†’ returnerar preset_id.

Ladda preset fyller formulÃ¤ret, kÃ¶r om valideringar, visar â€œLaddad: <namn>â€.

â€œTorrkÃ¶rningâ€

FÃ¶r Crawl/Crawl+Scrape: kÃ¶r upp till 10 sidor enligt plan (per gren) eller tidsbudget 60 s, det som kommer fÃ¶rst.

FÃ¶r Scrape frÃ¥n URLâ€‘lista: tar fÃ¶rsta 5â€“10 URL:erna.

Output skrivs till temporÃ¤r sandbox (ej lÃ¥ngvarig retention), med loggâ€‘tagg dry_run:true.

UI visar banner: â€œTorrkÃ¶rning â€” inga data skrivs till produktionsmÃ¥l (endast preview).â€

Redirect till Jobbdetaljer med statuschip â€œDry Runâ€.

Ã…tgÃ¤rder & sidflÃ¶de

Starta jobb:

Skapar job i kÃ¶ â†’ status pending.

Publicerar hÃ¤ndelse till scheduler.

Redirect till Jobbdetaljer (Sida 8) med liveâ€‘logg start.

Spara som fÃ¶rinstÃ¤llning: stannar kvar, toast â€œFÃ¶rinstÃ¤llning sparadâ€.

TorrkÃ¶rning: startar dry_run=true variant, redirect till Jobbdetaljer.

Stateâ€‘maskin (Ã¶versikt)

draft â†’ pending â†’ running â†’ (paused) â†’ completed | failed | canceled

paused endast nÃ¤r anvÃ¤ndaren pausat (eller autoâ€‘throttle med â€œdegradedâ€ indikator).

â€œCrawl+Scrapeâ€ kÃ¶r tvÃ¥ pipelines med koordinerad backpressure.

Backend APIâ€‘kontrakt (exempel)
Start
POST /api/jobs
{
  "type": "crawl|crawl_scrape|scrape_list|export|analysis",
  "project_id": "prj_123",
  "template_id": "tpl_456",           // krÃ¤vs fÃ¶r scrape/crawl_scrape
  "crawl_plan_id": "crp_789",         // krÃ¤vs fÃ¶r crawl/crawl_scrape
  "priority": "low|normal|high",
  "concurrency": 8,
  "rendering": "auto|http|browser",
  "proxy": { "mode": "auto|sticky|rotate", "geo": "SE|EU|US|..." },
  "output": {
    "target": "db|file|connector",
    "format": "csv|json|parquet",
    "connector": "sheets|bigquery|snowflake|elastic|opensearch",
    "options": { "bucket": "...", "path": "...", "table": "...", "dataset": "..." }
  },
  "tags": ["q3", "ad_hoc"],
  "url_list": ["https://..."],        // endast scrape_list/dry_run
  "limits": { "max_pages": 5000, "time_budget_sec": 3600 },
  "policies": { "robots": "respect|ignore_if_allowed", "tos_profile": "default" },
  "retries": { "max": 3, "backoff": "exp", "cap_sec": 60 },
  "dedupe": { "strategy": "url_hash|content_hash", "window_hours": 24 },
  "webhooks": { "on_start": "...", "on_batch": "...", "on_complete": "..." },
  "dry_run": false,
  "idempotency_key": "hash(form_payload)"
}


Svar:

201 Created
{ "job_id": "job_abc", "status": "pending" }

Preset
POST /api/jobs/presets
{ "name":"SE Retail Crawl v2", "scope":"team", "locked_fields":["rendering","proxy"], "payload":{ ... } }

Telemetri & audit

SpÃ¥rning: lÃ¤gg trace_id pÃ¥ job + formularskick (OpenTelemetry).

Audit log: vem startade, med vilka fÃ¤lt, frÃ¥n vilken IP/klientversion.

Produktanalys: event job_start_clicked + utfall job_created_ok|failed_validation.

Ã…tkomst & begrÃ¤nsningar (RBAC/Quota)

Roll styr tillgÃ¥ng till Projekt, max samtida workers, geos, exportmÃ¥l.

Varning/toast om anvÃ¤ndaren Ã¶verskrider perâ€‘projekt eller global daglig budget.

â€œExportâ€ och â€œExtern connectorâ€ krÃ¤ver scopes/credentials.

A11y & i18n

Alla kontroller har label + ariaâ€‘describedby (fel/hint).

Tangentbordsnavigering (Tabâ€‘ordning), Enter = â€œStarta jobbâ€, Ctrl/Cmd+Enter = â€œTorrkÃ¶rningâ€.

TomtillstÃ¥nd & fel

Tomt Projekt: CTA â€œSkapa projektâ€ (modal eller lÃ¤nk).

Mall saknas: CTA â€œSkapa mall i Template Wizardâ€.

Connector ogiltig: markera Outputâ€‘sektionen + lÃ¤nk till â€œLÃ¤gg till anslutningâ€.

8) Jobbdetaljer / Live Run Console
MÃ¥l

Ge en sann realtidsvy, full kontroll och tydlig Ã¥terkoppling. Allt viktat fÃ¶r snabb diagnostik (vad hÃ¤nder nu, funkar det, hur bra, vad ska jag gÃ¶ra om det inte funkar?).

Layout

Header:

Jobbtitel (typ + projekt + kort id), Statuschip (Pending/Running/Failed/Completed/Paused/Dry Run).

PrimÃ¤ra actions: â€œPausa/Ã…terupptaâ€, â€œAvsluta jobbâ€, â€œSkala workers Â±â€, â€œByt proxyprofilâ€, â€œExportera loggâ€.

SekundÃ¤ra: â€œÃ–ppna provâ€‘URL i Browserpanelâ€, â€œKopiera trace_idâ€, â€œKopiera APIâ€‘curlâ€.

Ã–vre KPIâ€‘rad (4â€“5 kort):

Sidor/minut (med minitrend 15 min)

Lyckade % (2xx/OK)

Fel % (klassad: transient/policy/permanent, klick Ã¶ppnar felpanel)

p95â€‘latens (ms)

GenomflÃ¶de ut (rader/min) om Scrape/Export aktivt

Huvudpaneler (tabs):

Liveâ€‘logg (default)

Streamad text i virtuellt listâ€‘fÃ¶nster, filterchips (INFO/WARN/ERROR/DEBUG), sÃ¶k, â€œOnly errorsâ€, â€œOnly policy eventsâ€.

â€œPin latestâ€ toggle; â€œCopy selectionâ€; â€œDownload snapshotâ€.

KÃ¶â€‘status

Gauge fÃ¶r vÃ¤ntande/bearbetas/klara, ETA, backpressureâ€‘indikator.

Perâ€‘partition/domÃ¤n brytning, hotâ€‘spots (vÃ¤rst fel).

Senaste fel

Tabbad lista: Transient (t.ex. timeouts), Policy (robots/TOS/block), Permanent (404/410/parse fail).

Varje rad: URL, felklass, kod, fÃ¶rsta/senaste, count, suggested action.

CTA â€œSkicka provâ€‘URL till Browserpanelâ€.

Resurser

Realtime CPU/RAM fÃ¶r jobbkapslar/containers + Network I/O, Proxyâ€‘hÃ¤lsa.

Visa â€œdegradedâ€ strax fÃ¶re throttling.

Output

RÃ¤knare inskrivna rader, schema preview, senaste batchâ€‘ID, lÃ¤nk till destination (ex. Sheets/BigQueryâ€‘job).

InstÃ¤llningar (readâ€‘only)

Renderingsprofil, Proxyprofil, Limits, Retries, Dedupe, Policy, Webhooks.

Historik

Milstolpar: pendingâ†’running, 10%/50%/90% progress, paus/Ã¥terupplivning, slutfÃ¶rt/avslutat.

Realtid & websocketâ€‘protokoll

Kanal: ws /jobs/{job_id}/stream

Eventtyper:

job.status {status, reason?}

metrics.kpi {pages_per_min, success_rate, error_rate, p95_ms, rows_per_min?}

log.entry {ts, level, source(worker|scheduler|exporter), message, url?, code?, fields?}

queue.update {pending, processing, completed, eta_sec}

errors.aggregate {class: transient|policy|permanent, items:[â€¦]}

resources.update {cpu_pct, mem_pct, net_in/out, proxy_ok_pct}

output.update {rows_total, last_batch_id, destination_ref}

control.ack {action: pause|resume|scale|proxy_switch|terminate, ok:bool, msg?}

UIâ€‘fallback: om WS bryts â†’ backoff + poll GET /api/jobs/{id}/snapshot var 5 s; banner â€œÃ…teransluterâ€¦â€.

Ã…tgÃ¤rder & semantik

Pausa/Ã…teruppta:

Skickar POST /api/jobs/{id}/pause eller /resume.

Pausa sÃ¤tter queue pÃ¥ hold; workers avslutar pÃ¥gÃ¥ende enheter (graceful) och slutar hÃ¤mta nya. Status â†’ paused nÃ¤r alla workers Ã¤r sÃ¤kra.

Ã…teruppta Ã¶ppnar kÃ¶ och fortsÃ¤tter.

Skala workers Â±:

POST /api/jobs/{id}/scale { delta: +N|-N } (scheduler orchestrerar).

BegrÃ¤nsas av projekt/roll kvoter och proxyâ€‘kapacitet.

Byt proxyprofil:

POST /api/jobs/{id}/proxy { mode, geo } â†’ hotâ€‘swap i nÃ¤stkommande fetchâ€‘cykel; logg entry â€œProxy profile switchedâ€.

Avsluta jobb:

POST /api/jobs/{id}/terminate { reason } â†’ graceful stop (timeout â†’ hard kill). Status â†’ canceled.

Ã–ppna provâ€‘URL i Browserpanel:

Skickar POST /api/tools/browser_preview { url, job_id, worker_context? } â†’ Ã¶ppnar sida 9 i ny panel/flik med riktig header/cookieâ€‘profil.

Exportera logg:

GET /api/jobs/{id}/logs?format=ndjson|txt&level>=INFO&since=â€¦ â†’ laddar fil.

State & fÃ¶rvÃ¤ntat beteende

Statuschip uppdateras omedelbart via job.status.

Throughput reagerar inom sekunder pÃ¥ scale eller proxybyte.

Felpanel visar topâ€‘orsaker (Pareto) med lÃ¤nkar till runbooks (â€œ429 spikeâ€, â€œCaptchaâ€‘stormâ€).

KÃ¶â€‘panel visar ETA baserat pÃ¥ glidande medel + perâ€‘domÃ¤n begrÃ¤nsningar.

Felklassificering

Transient: timeouts, 5xx, reset, rate limit (429), proxy fail â€” autoâ€‘retry.

Policy: robots disallow, TOS block, geofencing â€” ingen retry, rekommendera policyjustering.

Permanent: 404/410, ogiltig mallselektor, irreparabel parse â€” skippa.

Observability

Traceâ€‘lÃ¤nkar till APM fÃ¶r job_id och trace_id.

Grafâ€‘kort: smÃ¥ inlineâ€‘sparklines; clickâ€‘through till full Grafana/Explore.

KostnadsmÃ¤tare (valbar): est. kostnad/1000 sidor, budgetâ€‘varningar.

Ã…tkomst, sÃ¤kerhet, integritet

RBAC: endast Ã¤gare/rollen med jobs:control fÃ¥r pausa/skala/terminera/byt proxy.

PIIâ€‘skydd: liveâ€‘logg maskar PII med policy (eâ€‘post, pers.nr).

Audit: varje kontrollÃ¥tgÃ¤rd loggas (vem, nÃ¤r, frÃ¥n var).

Prestanda & UXâ€‘finlir

Virtuella listor fÃ¶r logg (10k+ rader utan lagg).

Intelligent autoscroll (stannar nÃ¤r anvÃ¤ndaren scrollar upp).

Skelettladdare fÃ¶r KPIâ€‘rutor fÃ¶rsta 1â€“2 sek.

Keyboard: P pausa/Ã¥teruppta, +/- skala, / fokus pÃ¥ sÃ¶k i loggen.

Sticky actionâ€‘rad vid scroll.

MÃ¶rkt/ljust tema, fÃ¤rgkodning:

GrÃ¶n throughput/OK, Gul transient, BlÃ¥ policy info, RÃ¶d permanent fel.

Snapshot & export

â€œSpara kÃ¶rningsâ€‘snapshotâ€ (JSON) med config + senaste KPI + felâ€‘topplista.

Exportera outputâ€‘prov (fÃ¶rsta 100 rader) till CSV fÃ¶r snabb delning.

Edgeâ€‘cases & hur UI ska bete sig

WS av: visa banner och degradera till polling; behÃ¥ll kontroller aktiva.

Zero progress: om 0 sidor efter X min â†’ visa diagnosfÃ¶rslag (DNS/Proxy/Policy).

HÃ¶g fel%: CTA â€œSÃ¤nk concurrencyâ€ och â€œByt proxyprofilâ€ (oneâ€‘click actions).

Mallâ€‘drift: upptÃ¤ckt selectorâ€‘drift â†’ badge â€œDrift detectedâ€, lÃ¤nk till selectorâ€‘verktyg.

Output full/skrivfel: markera Outputâ€‘tab rÃ¶d; fÃ¶reslÃ¥ vÃ¤xel till temporÃ¤r fil.

Quota slut: banner â€œBudget nÃ¥dd â€” pausatâ€; knapp â€œBegÃ¤r extra kvotâ€.

Backend APIâ€‘kontrakt (exempel)
LÃ¤s snapshot
GET /api/jobs/{id}/snapshot
{
  "status":"running",
  "kpi":{"ppm":320,"success_rate":0.92,"error_rate":0.08,"p95_ms":840,"rows_per_min":190},
  "queue":{"pending":18200,"processing":64,"completed":7400,"eta_sec":2880},
  "errors":{"transient":{...},"policy":{...},"permanent":{...}},
  "resources":{"cpu_pct":71,"mem_pct":63,"net_in":...,"net_out":...,"proxy_ok_pct":88},
  "output":{"rows_total":154200,"dest_ref":"bq://project.dataset.table"},
  "config":{ ... } // read-only
}

KontrollÃ¥tgÃ¤rder
POST /api/jobs/{id}/pause            -> 202 { "accepted": true }
POST /api/jobs/{id}/resume           -> 202 { "accepted": true }
POST /api/jobs/{id}/scale            -> 202 { "accepted": true, "target_workers": 24 }
POST /api/jobs/{id}/proxy            -> 202 { "accepted": true, "mode":"rotate","geo":"EU" }
POST /api/jobs/{id}/terminate        -> 202 { "accepted": true }
GET  /api/jobs/{id}/logs?level=warn  -> 200 text/plain (stream/snapshot)

Datamodell (kort)

Job: id, type, project_id, template_id?, crawl_plan_id?, priority, concurrency, rendering, proxy(mode, geo), output(target, connector, options), tags[], limits, policies, retries, dedupe, webhooks, dry_run, idempotency_key, created_by, status, created_at, started_at, finished_at.

JobMetrics (timeâ€‘series): job_id, ts, pages, ok, errors (klass), p95_ms, rows_out, cpu, mem, proxy_ok_pct.

JobLog: job_id, ts, level, source, message, url?, code?, fields(jsonb).

JobControlEvent: job_id, ts, action, actor, result.

Kvalitetsâ€‘ & testchecklista (UI/UX)

FormulÃ¤rblockerande fel innan â€œStarta jobbâ€ blir klickbar.

Alla requiredâ€‘fÃ¤lt har inlineâ€‘fel + fokusflytt.

TorrkÃ¶rning alltid sandboxad och tydligt uppmÃ¤rkt.

WSâ€‘strÃ¶mmar Ã¥teransluter; inga dubletter i logg.

Sidor/min och p95 reagerar mÃ¤tbart inom 2â€“5 s vid scale/proxybyte.

Export av logg fungerar Ã¤ven fÃ¶r lÃ¥nga kÃ¶rningar (paginering/chunk).

A11y: kontrast, fokus, live region fÃ¶r uppdaterande KPI.

SammanlÃ¤nkning 7 â†’ 8

NÃ¤r ett jobb skapas (eller torrkÃ¶rs) sker omedelbar redirect till Jobbdetaljer med:

Statuschip initialt Pending, KPIâ€‘kort som skelett tills fÃ¶rsta metrics.kpi.

Notifiering â€œJobb skapat: job_abcâ€ + lÃ¤nk â€œkopiera idâ€.

Om validering i backend misslyckas efter skapande (t.ex. connectorâ€‘fel) â†’ status Failed med prominent orsak och â€œÃ…terÃ¶ppna i launcher med samma parametrarâ€ (prefill).


9) Browserpanel & Selector Tool
A) Enkel fÃ¶rklaring (fÃ¶r ickeâ€‘tekniker)

Det hÃ¤r Ã¤r en inbyggd webblÃ¤sare (osynlig/headless) som laddar sidor â€œsom en mÃ¤nniskaâ€ fÃ¶r att kunna se det som JavaScript renderar. Du kan:

BesÃ¶ka en URL, byta webblÃ¤sarprofil (Userâ€‘Agent), sprÃ¥k och tidszon,

se DOM, nÃ¤tverkstrafik och cookies,

anvÃ¤nda en overlay fÃ¶r att peka pÃ¥ ett element och fÃ¥ en stabil CSS/XPathâ€‘selector som klistras in i din mall,

spela in interaktioner (t.ex. fylla formulÃ¤r, klicka), spara cookies, blockera tunga resurser, ta skÃ¤rmdump och kÃ¶ra eget script i en kontrollerad sandbox.

B) Detaljerad UI/UXâ€‘spec
B.1 Ã–versikt & layouter

Adressrad: URLâ€‘fÃ¤lt + GÃ¥ till (â†©ï¸), Ladda om, Stopp.

ProfilfÃ¤lt (i samma rad):

Userâ€‘Agentâ€‘profil (desktop/mobil; Chrome/Firefox/Safari vardera 2â€“3 moderna versioner).

SprÃ¥k (sv-SE,sv;q=0.9,en;q=0.7) och Tidszon (Europe/Stockholm som default).

Geoâ€‘emulering (valfritt land/latâ€‘lon, kopplas till proxyprofiler).

Paneler (flikar):

DOM (inspektÃ¶r, sÃ¶k, snabbâ€‘copy av selector, â€œrulla till elementâ€)

NÃ¤tverk (waterfall, request/response, headers, cookies, storlekar, status)

Lagring (cookies, localStorage, sessionStorage; import/export cookies)

Konsol (console.log, varningar, fel, utskrift frÃ¥n â€œKÃ¶r scriptâ€)

Overlayâ€‘lÃ¤ge: togglas pÃ¥/av; visar highlight + fÃ¶reslagna CSS/XPath, fallbackâ€‘kedja, kopiera till mall.

Sidokolumn (Ã¥tgÃ¤rder):

Spela in interaktion (start/stop)

Spara cookies i session

Blockera resurser (bilder/video/annons/3:e part; toggles)

Ta skÃ¤rmdump (viewport/hel sida/element)

KÃ¶r script (JSâ€‘editor med sandbox & tidsgrÃ¤ns)

B.2 Overlay â€“ selectorâ€‘upplevelse

Hover pÃ¥ element â†’ overlay visar:

PrimÃ¤r CSS (preferera data-*, id, stabila klasser, undvik index)

Fallback CSS (mer generell)

XPath (med contains() pÃ¥ stabila attribut/text vid behov)

ExempelvÃ¤rde (innerText/attr) + â€œTesta nuâ€ â†’ extraherar och visar resultat i sidofoten.

Regel om â€œrobusthetâ€ (automatiskt):

AnvÃ¤nd id om det inte ser ut som dynamiskt (regex pÃ¥ slumpstrÃ¤ngar).

AnvÃ¤nd data-testid|data-qa|data-* om finns.

Minimerad klasslista (slopa BEMâ€‘suffix/dynamiska hashklasser).

Kliv uppÃ¥t till nÃ¤rmaste stabila container med tydlig roll/tagg.

Som sista utvÃ¤g: nth-of-type() endast om unikhet inte uppnÃ¥s annars.

KvalitetspoÃ¤ng (0â€“100) per selector; overlay fÃ¤rgar grÃ¶n >80, gul 50â€“80, rÃ¶d <50.

â€œKopiera in i mallâ€:

VÃ¤lj fÃ¤lt (dropdown med dina fÃ¤ltnamn) â†’ lÃ¤gger in i Template Wizard aktiva fÃ¤ltet.

Kan skicka primary + fallback (lista).

B.3 Spela in interaktion (formflÃ¶de)

Starta inspelning â†’ overlay loggar:

click(selector), fill(selector, value), selectOption(...), press(...), waitForNavigation(...), waitForSelector(...), scroll(...).

Heuristik fÃ¶r selectors under inspelning (samma robusthetsregler).

Resultat: ett flÃ¶de du kan:

KÃ¶ra om (play), stega, exportera som Playwrightâ€‘script (readâ€‘only), eller spara som â€œForm Flowâ€ (kan bindas till en mall/plan).

Maskning: vÃ¤rden i fÃ¤lt som ser ut som lÃ¶senord/PII maskas innan lagring.

B.4 Spara cookies i session

Cookieâ€‘jar namngiven efter Projekt + AnvÃ¤ndarprofil + Proxyâ€‘geo.

Knappar: â€œSparaâ€, â€œRensaâ€, â€œExportera (.json)â€, â€œImporteraâ€.

Persistens: krypterad lagring. TTL styrs av projektpolicy.

Isolering: cookies frÃ¥n ett projekt/geo Ã¥teranvÃ¤nds inte i annat projekt/geo.

B.5 Blockera resurskategorier

Togglechips: Bilder, Video, Typsnitt, SpÃ¥rare, Annonser, 3:e part.

Mappas till requestâ€‘interception (mÃ¶nsterlistor/URLâ€‘kategorier).

Visar â€œspara X% bandbreddâ€ estimat efter laddning.

B.6 Ta skÃ¤rmdump

Typ: Viewport | Hel sida | Element (via vald selector).

Format: PNG (default) / JPEG (kvalitet slider).

Lagring: filsystem (med pad), samt referens in i extracted_items.attachments.

UI: thumbnail + â€œÃ–ppna stÃ¶rreâ€, â€œKopiera bildâ€‘URLâ€.

B.7 KÃ¶r script (custom JS)

Editor (monaco), readâ€‘only globaler: document, window, ingen nÃ¤tverksÃ¥tkomst via fetch (sandboxpolicy), tidsgrÃ¤ns (t.ex. 2 s).

Console fÃ¥ngas till â€œKonsolâ€â€‘flik.

Security: script kÃ¶rs i isolat (t.ex. Playwright evaluate med kapsling), inga Nodeâ€‘API:er, inga OSâ€‘anrop.

Registrering: script + output kan sparas i diagnostic_runs.

C) Backendâ€‘kontrakt & kommandon
C.1 API (REST)
POST /api/browser/open
{ "url":"https://example.com", "ua_profile":"desktop_chrome_125", "accept_language":"sv-SE,sv;q=0.9,en;q=0.7", "timezone":"Europe/Stockholm", "geo":{"country":"SE"}, "proxy":{"mode":"sticky","geo":"SE"}, "block":{"images":true,"video":true}, "cookie_jar":"proj_12__SE" }

POST /api/browser/overlay/selector
{ "at_point": {"x": 420, "y": 380}, "return":"css|xpath|both" }

POST /api/browser/recording/start
{ "mask_fields": ["password","ssn","card"] }

POST /api/browser/recording/stop
{}

POST /api/browser/screenshot
{ "type":"full|viewport|element", "selector":"...", "format":"png|jpeg", "quality":80 }

POST /api/browser/run-script
{ "code":"/* JS */", "timeout_ms":2000 }

POST /api/browser/cookies/save
{ "cookie_jar":"proj_12__SE" }

POST /api/browser/cookies/export
{ "cookie_jar":"proj_12__SE" }

POST /api/browser/cookies/import
{ "cookie_jar":"proj_12__SE", "cookies":[ ... ] }

C.2 Verifieringskommandon (curl)
# Ã–ppna sida med svensk profil + sticky SE-proxy
curl -s -X POST http://localhost:8000/api/browser/open \
  -H "Content-Type: application/json" \
  -d '{"url":"https://example.com","ua_profile":"desktop_chrome_125","accept_language":"sv-SE,sv;q=0.9","timezone":"Europe/Stockholm","proxy":{"mode":"sticky","geo":"SE"},"block":{"images":true}}' | jq

# Ta helsideskÃ¤rmdump
curl -s -X POST http://localhost:8000/api/browser/screenshot \
  -H "Content-Type: application/json" \
  -d '{"type":"full","format":"png"}' > /tmp/snap.png

# KÃ¶r kort JS och hÃ¤mta console-loggar i svaret
curl -s -X POST http://localhost:8000/api/browser/run-script \
  -H "Content-Type: application/json" \
  -d '{"code":"console.log(document.title); return document.querySelector(\"h1\")?.textContent || null;"}' | jq


FÃ¶rvÃ¤ntat:

open svarar med session_id + â€œloaded:true/falseâ€, latens m.m.

SkÃ¤rmdump sparas, filen gÃ¥r att Ã¶ppna.

run-script returnerar consoleâ€‘loggar + result.

D) MySQLâ€‘schema & verifiering
D.1 Tabeller
-- Sessions & cookies
CREATE TABLE IF NOT EXISTS browser_sessions (
  id            BIGINT PRIMARY KEY AUTO_INCREMENT,
  project_id    BIGINT NOT NULL,
  session_key   VARCHAR(64) NOT NULL UNIQUE,
  ua_profile    VARCHAR(64),
  language      VARCHAR(64),
  timezone      VARCHAR(64),
  geo_country   CHAR(2),
  proxy_mode    ENUM('auto','sticky','rotate'),
  proxy_geo     VARCHAR(8),
  created_at    DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS cookie_jars (
  id            BIGINT PRIMARY KEY AUTO_INCREMENT,
  jar_key       VARCHAR(128) NOT NULL UNIQUE,
  project_id    BIGINT NOT NULL,
  data_encrypted LONGBLOB NOT NULL,
  updated_at    DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Diagnostic runs (overlay/script/recorder)
CREATE TABLE IF NOT EXISTS diagnostic_runs (
  id            BIGINT PRIMARY KEY AUTO_INCREMENT,
  project_id    BIGINT NOT NULL,
  session_key   VARCHAR(64),
  kind          ENUM('overlay','recording','screenshot','script'),
  request_json  JSON,
  result_json   JSON,
  created_at    DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
);

D.2 Kontrollera att session & cookies sparades
SELECT session_key, ua_profile, language, timezone FROM browser_sessions ORDER BY created_at DESC LIMIT 3;
SELECT jar_key, OCTET_LENGTH(data_encrypted) size_bytes FROM cookie_jars ORDER BY updated_at DESC LIMIT 3;


FÃ¶rvÃ¤ntat: poster finns, storlek > 0 pÃ¥ cookies.

E) Robust selectorâ€‘algoritm (Ã¶versikt)

MÃ¥lsÃ¤ttning: generera stabila selectors som Ã¶verlever smÃ¥ DOMâ€‘Ã¤ndringar.

Heuristik (fÃ¶renklad pseudokod):

if element.id && !looks_dynamic(element.id): return '#'+id
if has_data_testid(element): return `[data-testid="${val}"]`
if has_unique_attribute(['data-qa','itemprop','name','aria-label']): return `[attr="val"]`
path = build_path_upwards(element, prefer_tag_names=['main','article','section'])
path = minimize_classes(path, drop_dynamic_hashes=true)
if uniqueness(path) < 1: path = add_nth_of_type_conservatively(path)
return path


Verifiering i UI: â€œTesta nuâ€ ska returnera exakt samma text/attributvÃ¤rde som du markerade.

F) A11y, prestanda & sÃ¤kerhet

A11y: Full tangentbordsstyrning; overlay kan togglas via O; fokus syns starkt.

Prestanda: Browserpool (5â€“10 instanser), Ã¥teranvÃ¤nd stickyâ€‘session under panelen, stÃ¤ng inaktiva sessioner efter 5 min.

SÃ¤kerhet: JSâ€‘sandbox tidsgrÃ¤ns, inga nÃ¤tverksanrop, script & cookies auditeras (loggas) fÃ¶r spÃ¥rbarhet.

G) Acceptanskriterier & E2E

Overlay producerar â‰¥1 selector med kvalitetspoÃ¤ng > 80 fÃ¶r typiska element.

â€œSpela in interaktionâ€ kan reproducera ett enkelt formulÃ¤rflÃ¶de (sÃ¶k â†’ klicka resultat â†’ Ã¶ppna detalj).

â€œSpara cookies i sessionâ€ gÃ¶r att nÃ¤sta sidladdning inte visar cookieâ€‘banner (om consent sattes).

Blockera â€œBilderâ€ minskar total nedladdad bytes (visa i NÃ¤tverk).

SkÃ¤rmdump hamnar i filsystemet och refereras frÃ¥n diagnostic_runs.result_json.

10) Proxy & NÃ¤tverk
A) Enkel fÃ¶rklaring (fÃ¶r ickeâ€‘tekniker)

HÃ¤r styr du IPâ€‘adresserna och nÃ¤tverkskvalitet. Du kan:

lÃ¤gga till proxyleverantÃ¶rer, se hÃ¤lsa (latens/fel),

vÃ¤lja geografi (t.ex. Sverige),

bestÃ¤mma stickyâ€‘fÃ¶nster (hur lÃ¤nge samma IP behÃ¥lls),

svartlista dÃ¥liga IPs, validera nu, och exportera rapporter.

B) Detaljerad UI/UXâ€‘spec
B.1 Pool & leverantÃ¶rer

Pooler: Residential, Datacenter, Mobile (kort med badges: aktiva, p95 latens, failâ€‘rate).

LeverantÃ¶rer (per pool): lista med APIâ€‘nyckelstatus, kvoter, kostnadsindikator.

Knappar:

LÃ¤gg till proxykÃ¤lla (modal: namn, APIâ€‘endpoint, auth, pool, geoâ€‘stÃ¶d).

Validera nu (triggar healthâ€‘run).

Tvinga rotation (flippar alla sticky â†’ nya IP).

Exportera hÃ¤lsorapport (CSV/JSON).

B.2 Geoâ€‘fÃ¶rdelning (vÃ¤rmekarta)

Heatmap per land/region: antal aktiva IP, failâ€‘rate, latensp95.

Filterchips: visa endast SE|Nordics|EU.

Klick i karta â†’ tabell â€œTop endpoints i [land]â€.

B.3 Stickyâ€‘fÃ¶nster & policys

Sticky window (minuter): 0 (= aldrig sticky), 5, 10, 30, custom.

Perâ€‘jobb policy (overrideable i Job Launcher).

Perâ€‘domÃ¤n policy (ex: car.info: sticky=10 min, geo=SE, RPS=1).

B.4 HÃ¤lsa & kvalitetsfilter

HÃ¤lsokort: p50/p95 latens (ms), failâ€‘rate (%) senaste 1 h, svartlistade noder (antal).

Tabell â€œEndpointsâ€: endpoint, pool, geo, hÃ¤lsopoÃ¤ng (0â€“100), senaste felkod, svartlistad tills.

Kvalitetsfilter:

Min krav: p95 < X ms, failâ€‘rate < Y%.

Handling: degradera (lÃ¤gre vikt), svartlista (TTL), uteslut geon.

Ã…tgÃ¤rder per rad: â€œSvartlista (TTL)â€, â€œVitlistaâ€, â€œTesta igenâ€, â€œVisa historikâ€.

C) Tilldelningsalgoritm (urval)

MÃ¥l: fÃ¶r varje request/session vÃ¤lj en endpoint som maximerar sannolikheten fÃ¶r OK svar och minimerar block/fel.

Viktningsmodell (ex): EWMA av (latens, failâ€‘rate), + geoâ€‘match, + leverantÃ¶rskostnad.

Circuit breaker: om endpoint ger 3Ã— fel inom kort fÃ¶nster â†’ Ã¶ppet lÃ¤ge (svartlistas TTL=10 min).

Sticky: hÃ¥ll samma endpoint fÃ¶r en session inom stickyâ€‘fÃ¶nstret; annars rotera (roundâ€‘robin viktad).

Perâ€‘domÃ¤n caps: perâ€‘IP RPS och global RPS.

D) Backendâ€‘kontrakt & kommandon
D.1 API (fÃ¶r UI/Jobs)
GET  /api/proxy/pools
GET  /api/proxy/providers
POST /api/proxy/providers          { "name":"...", "pool":"residential", "auth":{"key":"..."},"geos":["SE","NO"] }
POST /api/proxy/validate-now       { "pool":"residential" }
POST /api/proxy/rotate             { "pool":"residential", "scope":"all|job|session", "job_id":"optional" }
POST /api/proxy/blacklist          { "endpoint":"res://se-123", "ttl_min":60, "reason":"429 storm" }
POST /api/proxy/whitelist          { "endpoint":"res://se-123" }
POST /api/proxy/quality-filter     { "pool":"residential","min_score":70,"max_p95_ms":1200,"max_fail_rate":0.05 }
GET  /api/proxy/health-report.csv?pool=residential

D.2 â€œAllocate/Releaseâ€ (internt API fÃ¶r workers)
POST /api/proxy/allocate
{ "pool":"residential","geo":"SE","sticky":"session|request","session_key":"job_123__worker7" }

POST /api/proxy/release
{ "endpoint":"res://se-123", "session_key":"job_123__worker7", "result":"ok|fail", "status_code":200, "latency_ms":380 }

D.3 Verifieringskommandon (curl)
# LÃ¤gg till leverantÃ¶r
curl -s -X POST http://localhost:8000/api/proxy/providers \
  -H "Content-Type: application/json" \
  -d '{"name":"AcmeResi","pool":"residential","auth":{"key":"acme-xyz"},"geos":["SE","FI","NO"]}' | jq

# Validera nu (starta health-run)
curl -s -X POST http://localhost:8000/api/proxy/validate-now -H "Content-Type: application/json" -d '{"pool":"residential"}' | jq

# Svartlista endpoint 60 min
curl -s -X POST http://localhost:8000/api/proxy/blacklist -H "Content-Type: application/json" \
  -d '{"endpoint":"res://se-123","ttl_min":60,"reason":"p95>2000ms"}' | jq

# HÃ¤mta hÃ¤lsorapport CSV
curl -s "http://localhost:8000/api/proxy/health-report.csv?pool=residential" -o health.csv


FÃ¶rvÃ¤ntat:

Provider skapas; Validera nu startar job (se i â€œHÃ¤lsokortâ€).

Endpoints med hÃ¶g latens/failâ€‘rate degraderas/svartlistas; hÃ¤lsorapport innehÃ¥ller p50/p95/failâ€‘rate.

E) MySQLâ€‘schema, index & kvalitet
E.1 Tabeller
CREATE TABLE IF NOT EXISTS proxy_providers (
  id           BIGINT PRIMARY KEY AUTO_INCREMENT,
  name         VARCHAR(64) UNIQUE,
  pool         ENUM('residential','datacenter','mobile') NOT NULL,
  auth_json    JSON NOT NULL,
  geos_json    JSON,
  created_at   DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS proxy_endpoints (
  id           BIGINT PRIMARY KEY AUTO_INCREMENT,
  provider_id  BIGINT NOT NULL,
  endpoint     VARCHAR(128) UNIQUE,
  pool         ENUM('residential','datacenter','mobile') NOT NULL,
  geo_country  CHAR(2),
  score        FLOAT DEFAULT 50,       -- 0-100
  p50_ms       INT,
  p95_ms       INT,
  fail_rate    FLOAT,                  -- 0..1
  blacklisted_until DATETIME NULL,
  last_error   VARCHAR(32),
  updated_at   DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX (pool, geo_country),
  INDEX (blacklisted_until)
);

CREATE TABLE IF NOT EXISTS proxy_allocations (
  id           BIGINT PRIMARY KEY AUTO_INCREMENT,
  endpoint_id  BIGINT NOT NULL,
  session_key  VARCHAR(128) NOT NULL,
  allocated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  released_at  DATETIME NULL,
  result       ENUM('ok','fail') NULL,
  status_code  INT NULL,
  latency_ms   INT NULL,
  INDEX (session_key),
  INDEX (allocated_at)
);

CREATE TABLE IF NOT EXISTS proxy_health_events (
  id           BIGINT PRIMARY KEY AUTO_INCREMENT,
  endpoint_id  BIGINT NOT NULL,
  ts           DATETIME NOT NULL,
  latency_ms   INT,
  ok           TINYINT(1),
  error_code   VARCHAR(16),
  INDEX (endpoint_id, ts)
);

E.2 Indexâ€‘verifiering
EXPLAIN SELECT endpoint, p95_ms, fail_rate FROM proxy_endpoints WHERE pool='residential' AND geo_country='SE' ORDER BY score DESC LIMIT 50;


FÃ¶rvÃ¤ntat: index pÃ¥ (pool, geo_country) anvÃ¤nds.

E.3 HÃ¤lsoberÃ¤kning (exempel)

Score = 100 âˆ’ z(latens_p95) âˆ’ 100Â·fail_rate, klippt till [0,100].

KÃ¶rs periodiskt (t.ex. var 5:e minut) och uppdaterar proxy_endpoints.score.

F) Healthâ€‘validator & prioritering (vad som hÃ¤nder)

Validera nu â†’ skapar healthâ€‘jobb som:

fÃ¶r varje endpoint: gÃ¶r 1â€“2 snabba HEAD/GET mot kÃ¤nd â€œhÃ¤lsosidaâ€.

mÃ¤ter latens & svarskod; loggar proxy_health_events.

Aggregerar p50/p95, failâ€‘rate, uppdaterar score.

Om score < min_score â†’ degradera (lÃ¤gre vikt) eller svartlista (TTL), enligt kvalitetsfilter.

Tilldelningsalgoritm anvÃ¤nder den uppdaterade vikten pÃ¥ nÃ¤sta allokering.

Verifiering i UI: endpoints med hÃ¶g failâ€‘rate â€œsjunkerâ€ i tabellen (lÃ¤gre vikt/score), nya jobb vÃ¤ljer andra IPs (kolla i Jobbdetaljer â†’ Resurser â†’ Proxyâ€‘hÃ¤lsa).

G) Acceptanskriterier & E2E
DoD (funktion)

â€œLÃ¤gg till proxykÃ¤llaâ€ sparar provider, verifierar auth, och fyller pÃ¥ endpoints (om provider API stÃ¶djer det).

â€œValidera nuâ€ uppdaterar p50/p95/failâ€‘rate och score i â‰¤ 2 min fÃ¶r â‰¥ 100 endpoints.

Kvalitetsfilter pÃ¥verkar urvalet (synligt i â€œNya jobb â†’ proxyvalâ€).

Svartlista tar effekt direkt (endpoint Ã¥teranvÃ¤nds inte inom TTL).

Exportera hÃ¤lsorapport inkluderar alla fÃ¤lt och gÃ¥r att Ã¶ppna i Excel.

Stickyâ€‘fÃ¶nster efterlevs (logg visar samma endpoint fÃ¶r session upp till X min).

E2Eâ€‘testfall (urval)

TCâ€‘PXâ€‘01: LÃ¤gg till provider â†’ endpoints syns â†’ validera â†’ hÃ¤lsosiffror uppdateras.

TCâ€‘PXâ€‘02: Svartlista ett endpoint â†’ starta jobb â†’ endpointen anvÃ¤nds inte (kontrollera logg).

TCâ€‘PXâ€‘03: HÃ¶j min krav (p95/failâ€‘rate) â†’ mÃ¥nga endpoints degraderas; nya jobb fÃ¥r lÃ¤gre latens men ev. fÃ¤rre geon.

TCâ€‘PXâ€‘04: Sticky=10m â†’ samma endpoint i flera requests inom intervallet; dÃ¤refter rotation.

TCâ€‘PXâ€‘05: Exportera CSV â†’ Ã¶ppna externt och verifiera p95/failâ€‘rate matchar UI.

H) Snabbkommandon & kontroll (praktiskt)

HÃ¤mta SEâ€‘residential topp 10 efter score

SELECT endpoint, p95_ms, fail_rate, score
FROM proxy_endpoints
WHERE pool='residential' AND geo_country='SE' AND (blacklisted_until IS NULL OR blacklisted_until < NOW())
ORDER BY score DESC
LIMIT 10;


Kolla stickyâ€‘allokeringar senaste 15 min

SELECT session_key, COUNT(*) cnt, MIN(allocated_at) first, MAX(allocated_at) last
FROM proxy_allocations
WHERE allocated_at > NOW() - INTERVAL 15 MINUTE
GROUP BY session_key
ORDER BY cnt DESC
LIMIT 20;


FÃ¶rvÃ¤ntat: stickyâ€‘sessioner Ã¥teranvÃ¤nder samma endpoint (se i proxy_allocations per session_key).

I) A11y, prestanda & sÃ¤kerhet

A11y: tabbfokus pÃ¥ tabellrader, â€œspaceâ€ fÃ¶r att Ã¶ppna radÃ¥tgÃ¤rder, ariaâ€‘labels pÃ¥ kartan (fÃ¥r tabbar â€œland/antal/endpointsâ€).

Prestanda: tabeller med virtuell scroll, serverâ€‘paginering; vÃ¤rmekartan fÃ¶renklad fÃ¶r >100 lÃ¤nder.

SÃ¤kerhet: APIâ€‘nycklar i providers lagras krypterat; endast Admin kan uppdatera; audit log fÃ¶r lÃ¤sningar/Ã¤ndringar. 







11) Exporter
A) Enkel fÃ¶rklaring (fÃ¶r ickeâ€‘tekniker)

HÃ¤r skapar du exportjobb av dina data: till filer (CSV/JSON/Excel/Parquet), kalkylark (Google Sheets), sÃ¶kmotorer (Elastic/OpenSearch) och datavaror (BigQuery/Snowflake). Du vÃ¤ljer vad som ska med (filter), hur fÃ¤lten ska heta (mappning), hur stora filer ska bli (uppdelning), vart det ska hamna, och om schemavalidering krÃ¤vs. Du kan spara exportprofiler, kÃ¶ra igen, ladda ner senaste filen och fÃ¥ webhook nÃ¤r det Ã¤r klart.

B) Detaljerad UI/UXâ€‘spec
B.1 Layout

Filterpanel (vÃ¤nster): â€œDatakÃ¤lla (queryâ€‘builder)â€, tidsspann, status, mall, taggar.

Konfigpanel (mitt): Exporttyp, Schemaâ€‘mappning, Filuppdelning, Destination, Schemavalidering.

Sidopanel (hÃ¶ger): FÃ¶rhandsâ€‘antal (estimat), kostnadsindikator (valfritt), senaste kÃ¶rningar.

Ã…tgÃ¤rdsrad: â€œKÃ¶r exportâ€, â€œTorrkÃ¶rning 1%â€, â€œSpara exportprofilâ€, â€œLadda ned senasteâ€, â€œSkicka testâ€‘webhookâ€.

B.2 Rutor & fÃ¤lt

Exporttyp (dropdown):

Fil: CSV, JSON Lines, Excel (.xlsx), Parquet (komprimering valbar)

SaaS/DB: Google Sheets, Elastic/OpenSearch (bulk), BigQuery, Snowflake

DatakÃ¤lla (queryâ€‘builder):

Projekt/KÃ¤lla (multiâ€‘select)

Mall(er) (multiâ€‘select + versionfilter)

Status: validerad (default), karantÃ¤n, tombstone

Datumintervall: skapad_tid (snabbval + custom)

FÃ¤ltfilter (avancerat): â€œfÃ¤lt OP vÃ¤rdeâ€ (t.ex. payload.price > 100000)

Limit/Offset eller Cursor (fÃ¶r streamingâ€‘exporter)

Previewâ€‘knapp: visar uppskattat radantal och 20 exempelrader

Schemaâ€‘mappning (fÃ¤ltalias):

Draâ€‘ochâ€‘slÃ¤pp lista Ã¶ver valda fÃ¤lt â†’ mÃ¥lkolumner (med alias)

Konverteringar: string/number/date/datetime/boolean

Nullâ€‘policy: â€œtillÃ¥t nullâ€/â€œersÃ¤tt med defaultâ€

Flatten JSON (fÃ¶r nested payloads)

Konfliktvarningar (dubbel alias, typkrock)

Filuppdelning:

Max rader/fil (t.ex. 500k)

Max filstorlek (MB/GB) (valfritt)

Rullande filnamn (index 00001â€¦)

Destination:

Lokal fil (path + â€œÃ¶ppna mappâ€)

Moln (S3â€‘kompatibel: endpoint, bucket, path, serverâ€‘sideâ€‘encryption val)

DBâ€‘tabell (MySQL mÃ¥l, UPSERTâ€‘policy)

Google Sheets (sheetâ€‘id, tabâ€‘namn, writeâ€‘mode: replace/append)

Elastic/OpenSearch (URL, index, auth, bulkâ€‘storlek)

BigQuery (dataset, tabell, loadâ€‘mode: truncate/append)

Snowflake (stage, tabell, COPY INTOâ€‘options)

Schemavalidering (on/off):

ON â‡’ validera rad mot mÃ¥ltyp (missmatch â†’ karantÃ¤nfil / errorâ€‘log)

Webhook (valfritt):

URL, metod (POST), HMACâ€‘hemlighet (signerar payload)

â€œSkicka provâ€ (testknapp)

B.3 Historik & status

Historiklista: jobb, typ, filtrat (komprimerad strÃ¤ng), radantal, filer, destination, status (Pending/Running/Completed/Failed), tid, varningar.

RadÃ¥tgÃ¤rder: â€œLadda ner fil(er)â€, â€œÃ–ppna loggâ€, â€œKÃ¶r igenâ€, â€œÃ–ppna mÃ¥l (t.ex. Elastic index)â€.

B.4 States & a11y

Skeleton vid laddning, tomt tillstÃ¥nd (â€œSkapa din fÃ¶rsta exportâ€).

Tangentbord: Tab ordning, Enter pÃ¥ â€œKÃ¶r exportâ€, lÃ¤nkar har aria-labels.

FÃ¤rg + text fÃ¶r status (grÃ¶na âœ“ Completed, rÃ¶da âœ• Failed).

C) Kommandon (curl) & APIâ€‘kontrakt
C.1 Starta export
curl -s -X POST http://localhost:8000/api/exports \
  -H "Content-Type: application/json" \
  -d '{
    "type":"file",
    "format":"csv",
    "query":{
      "project_ids":[12],
      "templates":["vehicle_detail_v1"],
      "status":["validated"],
      "from":"2025-08-01T00:00:00Z",
      "to":"2025-08-21T23:59:59Z",
      "filters":[{"field":"payload.price","op":">=","value":100000}]
    },
    "schema":{
      "columns":[
        {"source":"id","alias":"id","type":"string"},
        {"source":"payload.reg_number","alias":"reg","type":"string"},
        {"source":"payload.title","alias":"title","type":"string"},
        {"source":"payload.price","alias":"price","type":"number"}
      ],
      "null_policy":"allow",
      "flatten":true
    },
    "split":{"max_rows":500000},
    "destination":{"kind":"local","path":"exports/vehicles_%Y%m%d"},
    "validate_schema":true,
    "webhook":{"url":"https://example.ngrok.app/export-done","hmac_secret":"shhhhh"},
    "idempotency_key":"exp_vehicles_aug"
  }' | jq


Svar (ex):

{ "export_id":"exp_001", "status":"pending" }

C.2 HÃ¤mta status & filer
curl -s http://localhost:8000/api/exports/exp_001 | jq
curl -s http://localhost:8000/api/exports/exp_001/files | jq
curl -s -L http://localhost:8000/api/exports/exp_001/download?file=vehicles_00001.csv.gz -o vehicles_00001.csv.gz

C.3 Lista historik
curl -s "http://localhost:8000/api/exports?limit=20&status=completed" | jq

C.4 Skicka testâ€‘webhook
curl -s -X POST "http://localhost:8000/api/exports/exp_001/test-webhook" | jq

D) Vad som hÃ¤nder (pipeline)

Planner

RÃ¤knar total rows (estimat + exakt nÃ¤r mÃ¶jligt).

Skapar manifest:

{"export_id":"exp_001","created_at":"...","format":"csv","split":{"max_rows":500000},
 "columns":[{"source":"payload.reg_number","alias":"reg","type":"string"},...],
 "destination":{"kind":"local","path":"exports/vehicles_%Y%m%d"}}


Reader

StrÃ¶mmar rader frÃ¥n extracted_items enligt query (indexerade kolumner).

Chunkar i batchar (t.ex. 10k rader).

Transformer/Validator

Applicerar schemaâ€‘mappning/typer, flatten, nullâ€‘policy.

Vid validate_schema=true: rad med typfel â†’ errorâ€‘sink (.err log).

Writer

CSV/JSONL/Parquet/Excel:

Komprimering: gzip (optâ€‘in), filrotation vid max_rows / max_size.

Checksumma (SHAâ€‘256) per fil + uppdaterad manifest (.sha256).

Sheets: chunkad batchâ€‘skrivning (Append/Replace).

Elastic/OpenSearch: _bulk i 5â€“10 MB chunkar, id frÃ¥n primary_key.

BigQuery: skriv GCS/S3â€‘like staging + LOAD JOB (eller direkt streaming insert).

Snowflake: PUT till stage + COPY INTO <table> med schema/format.

Completer

Status â†’ completed, skriv radantal per fil, total rows, kostnadslogg (valfritt).

Skicka webhook (HMACâ€‘signerad) med payload (export_id, status, filer).

E) MySQLâ€‘schema (exporter) & index
CREATE TABLE IF NOT EXISTS exports (
  id              BIGINT PRIMARY KEY AUTO_INCREMENT,
  export_id       VARCHAR(32) UNIQUE NOT NULL,
  type            ENUM('file','sheets','elastic','bigquery','snowflake','opensearch','mysql') NOT NULL,
  format          ENUM('csv','jsonl','xlsx','parquet') NULL,
  query_json      JSON NOT NULL,
  schema_json     JSON NOT NULL,
  split_json      JSON,
  destination_json JSON NOT NULL,
  validate_schema TINYINT(1) NOT NULL DEFAULT 1,
  status          ENUM('pending','running','completed','failed','canceled') NOT NULL DEFAULT 'pending',
  row_count       BIGINT DEFAULT 0,
  file_count      INT DEFAULT 0,
  manifest_path   VARCHAR(512),
  started_at      DATETIME,
  finished_at     DATETIME,
  error_message   TEXT,
  webhook_json    JSON,
  idempotency_key VARCHAR(64),
  created_by      VARCHAR(64),
  created_at      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX (status, created_at),
  INDEX (idempotency_key)
);

CREATE TABLE IF NOT EXISTS export_files (
  id            BIGINT PRIMARY KEY AUTO_INCREMENT,
  export_id     VARCHAR(32) NOT NULL,
  file_name     VARCHAR(512) NOT NULL,
  storage_path  VARCHAR(1024),
  rows          BIGINT,
  bytes         BIGINT,
  checksum_sha256 CHAR(64),
  created_at    DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX (export_id)
);

CREATE TABLE IF NOT EXISTS export_errors (
  id            BIGINT PRIMARY KEY AUTO_INCREMENT,
  export_id     VARCHAR(32) NOT NULL,
  line_no       BIGINT,
  error_type    VARCHAR(64),
  message       TEXT,
  sample_json   JSON,
  created_at    DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX (export_id)
);

F) Filstruktur & namngivning

Baspath: exports/<project_name>/<YYYY>/<MM>/<DD>/<export_id>/

Filnamn: <alias>_<YYYYMMDD>_<NNNNN>.<ext>[.gz]

Manifest: manifest.json + manifest.sha256

Errorâ€‘log: errors.ndjson (endast om fel fÃ¶rekom)

Signerad nedladdning (valfritt): GET /api/exports/{id}/download?... med tidsbegrÃ¤nsad token.

G) Verifiering (sÃ¥ kontrollerar du att det stÃ¤mmer)
G.1 Radantal
-- FÃ¶rvÃ¤ntat antal rader i exporten:
SET @from='2025-08-01 00:00:00'; SET @to='2025-08-21 23:59:59';
SELECT COUNT(*) AS expected
FROM extracted_items
WHERE project_id=12
  AND template_id=(SELECT id FROM templates WHERE name='vehicle_detail_v1' LIMIT 1)
  AND status='validated'
  AND created_at BETWEEN @from AND @to;


JÃ¤mfÃ¶r expected med exports.row_count och summering av export_files.rows.

G.2 Checksummor
sha256sum vehicles_00001.csv.gz
# jÃ¤mfÃ¶r med export_files.checksum_sha256

G.3 Webhook

Kontrollera mottagande serverâ€‘logg: HMACâ€‘header Xâ€‘Exportâ€‘Signature matchar hmac(secret, body).

H) DoD & E2Eâ€‘testfall
Definition of Done

â€œKÃ¶r exportâ€ skapar exportjobb (pendingâ†’runningâ†’completed/failed).

Manifest + checksumma skapas och gÃ¥r att verifiera lokalt.

Schemavalidering ON stoppar typfel till errorâ€‘log utan att stoppa hela jobbet (om inte â€œblockerandeâ€ valts).

Filuppdelning respekteras (rader/fil och/eller storlek).

Destination skriver korrekt (lokal/S3/DB/Sheets/Elastic/BQ/Snowflake) och returnerar referenser.

Ladda ner senaste fungerar och ger senaste completed fÃ¶r aktuell profil/filtrering.

Exportprofil kan sparas/Ã¥teranvÃ¤ndas.

RBAC: endast rÃ¤ttigheter kan skapa/exportera till externa mÃ¥l.

E2E (Playwright/pytest)

TCâ€‘EXPâ€‘01: Starta CSVâ€‘export (7 dagar, validated). Resultat: Completed, 2 filer, checksummor OK, row_count matchar SQL.

TCâ€‘EXPâ€‘02: Schemaâ€‘mappning typkrock â†’ errors.ndjson innehÃ¥ller felrader; manifest flaggar error_count>0.

TCâ€‘EXPâ€‘03: Elastic bulk (10MB chunk) â†’ index count Ã¶kar; felhantering pÃ¥ bulkâ€‘fail (retry delmÃ¤ngd).

TCâ€‘EXPâ€‘04: BigQuery â†’ load job green; tabell innehÃ¥ller kolumner enligt alias.

TCâ€‘EXPâ€‘05: Webhook mottagen (HMAC verifierad) med status=completed.

I) Edgeâ€‘cases, prestanda, sÃ¤kerhet

Stora exporter: streamâ€‘skrivning, backpressure, --compress, minne < 300 MB.

Excel: max ~1M rader/ark â†’ autoâ€‘rulla till flera ark.

JSON Lines: en rad per post; sÃ¤kert fÃ¶r strÃ¶mmar.

Parquet: kolumnÃ¤rt + snabba nedstrÃ¶msjobb.

Idempotens: idempotency_key hindrar dubbelkÃ¶rning av samma parameterset.

Ã…teruppta: vid avbrott fortsÃ¤tt frÃ¥n senaste kompletta filindex.

SÃ¤kerhet: masking av PII i loggar, krypterad lagring av mÃ¥lcredentials, Ã¥tkomstlogg fÃ¶r filnedladdning.

A11y: alla knappar har tydliga aria-label, fokus, tangentbordsstÃ¶d.

12) Privacy Center (Integritet & Radering)
A) Enkel fÃ¶rklaring (fÃ¶r ickeâ€‘tekniker)

HÃ¤r styr du personuppgifter (PII) och dataskydd:

Skanna data fÃ¶r PII (eâ€‘post, telefon, personnummer, registreringsnummer m.m.).

SÃ¤tt retentionspolicy (hur lÃ¤nge sparas data).

GÃ¶r radering pÃ¥ begÃ¤ran (med spÃ¥rbar logg).

Se Ã¥tkomstlogg (vem hÃ¤mtade vad, nÃ¤r).
Detta hjÃ¤lper dig att jobba laglydigt och kontrollerat.

B) Detaljerad UI/UXâ€‘spec
B.1 Rutor & fÃ¤lt

PIIâ€‘skanningsregler:

Regler (tabell): namn, typ (email|phone|personnummer|license_plate|address|ip|cookie_id|custom_regex), mÃ¥l (fÃ¤ltlista eller â€œhela payloadâ€), regex (fÃ¶r custom), validerare (ex. Luhn), severity (info/warn/block), masking (on/off).

Knapp: â€œKÃ¶r PIIâ€‘skanning nuâ€ (vÃ¤ljer scope: projekt, mall, tidsspann).

Retentionspolicy:

Per mall: dagar (t.ex. vehicle_detail_v1: 180 dagar), Ã¥tgÃ¤rd efter tid: tombstone | anonymize | permanent delete.

Undantag/Legal hold: flagga poster/nycklar som â€œskyddadeâ€ (ej raderas).

Planera rensning (schemalÃ¤ggning: dagligt kl 03:00).

RaderingsflÃ¶de:

ID/nyckel (sÃ¶k: item_id, primary_key/hash, eâ€‘post/telefon m.fl.)

Matchningsmetod: exakt | normaliserad | fuzz (levenshtein â‰¤ 1)

FÃ¶rhandsvisning: lista kandidater, riskbedÃ¶mning (hur sÃ¤ker match), relationer (proveniens/derivat).

Ã…tgÃ¤rd: tombstone | anonymize | permanent delete, krÃ¤ver tvÃ¥â€‘stegs bekrÃ¤ftelse (â€œSkriv RADERAâ€).

Starta radering (skapar raderingsjobb).

Ã…tkomstlogg:

Tabell: vem (anvÃ¤ndare/service), vad (dataset/export), hur (UI/API), nÃ¤r, var (IP), Ã¤ndamÃ¥l (fri text), resultat.

Filter (tid, anvÃ¤ndare, projekt, export_id).

B.2 HjÃ¤lprutor & hintar

Statuskort: senaste skanning, antal flaggade, antal raderade senaste 30 d.

Runbooks: â€œSÃ¥ bedÃ¶mer du personuppgiftsriskâ€ (inâ€‘app text).

C) Kommandon (curl) & APIâ€‘kontrakt
C.1 Skanna PII
curl -s -X POST http://localhost:8000/api/privacy/scan \
  -H "Content-Type: application/json" \
  -d '{
    "project_id": 12,
    "templates": ["vehicle_detail_v1"],
    "from":"2025-08-01T00:00:00Z","to":"2025-08-21T23:59:59Z",
    "rules":["email","phone","license_plate","personnummer"]
  }' | jq


Svar (ex):

{ "scan_id":"psc_101","status":"running","estimated":320000 }

C.2 SÃ¤tta retention
curl -s -X POST http://localhost:8000/api/privacy/retention \
  -H "Content-Type: application/json" \
  -d '{
    "policies":[
      {"template":"vehicle_detail_v1","days":180,"action":"tombstone"},
      {"template":"owner_v1","days":90,"action":"anonymize"}
    ]
  }' | jq

C.3 Starta radering (DSR)
# Exakt item-id
curl -s -X POST http://localhost:8000/api/privacy/erase \
  -H "Content-Type: application/json" \
  -d '{"match":{"item_id":"it_123456"}, "action":"tombstone","reason":"DSR-REQ-2025-08-21"}' | jq

# Matchning via primÃ¤r nyckel (ex. reg_number)
curl -s -X POST http://localhost:8000/api/privacy/erase \
  -H "Content-Type: application/json" \
  -d '{"match":{"field":"payload.reg_number","value":"ABC123","normalize":"upper"}, "action":"permanent"}' | jq

C.4 Visa Ã¥tkomstlogg
curl -s "http://localhost:8000/api/privacy/access-log?from=2025-08-01T00:00:00Z&to=2025-08-21T23:59:59Z&user=elin" | jq

D) Vad som hÃ¤nder (motorik)
D.1 PIIâ€‘skanning

KÃ¶rs batchâ€‘vis mot extracted_items.payload_json (via sÃ¶kbara projekterade kolumner nÃ¤r mÃ¶jligt).

Detektorer (inbyggda):

email: robust regex + domÃ¤nkontroll

phone: landsprofil (SE/EU), normalisering

personnummer (SE): format YYMMDD-XXXX eller YYYYMMDDXXXX, mod11/Luhnâ€‘liknande kontroll

license_plate (SE): ^[A-ZÃ…Ã„Ã–]{3}\s?\d{2,3}[A-ZÃ…Ã„Ã–]?$ (exempel), normalisering (mellanslag/streck)

ip, mac, cookie_id (uuid4/ulid), vin

custom_regex (admin tillÃ¥ten)

Policy:

severity=block â†’ items â†’ karantÃ¤n (uppdatera status + dq_violations)

masking=on â†’ maskera i loggar/exporter (om exportpolicy krÃ¤ver)

Resultat:

privacy_findings (tabell) + DQâ€‘poster; dashboards uppdateras.

D.2 Retention

Schemalagd rensare lÃ¤ser retention_policies:

Poster Ã¤ldre Ã¤n days â†’ utfÃ¶r action

tombstone: statusâ†’tombstone, strippar payload (sparar minsta audit)

anonymize: maskerar fÃ¤lt (hash/supprimera); bevarar ickeâ€‘PII

permanent delete: DELETE i primÃ¤ra tabeller + tombstoneâ€‘kvitto i audit

Legal hold flagg: hoppa Ã¶ver poster med hold.

D.3 RaderingsflÃ¶de (DSR)

Matchning (exakt/normaliserad/fuzz) genererar raderingsmanifest:

Lista av item_id + referenser (bilagor, snapshots, hÃ¤rkomst)

GenomfÃ¶r Ã¥tgÃ¤rd:

Uppdaterar/tejpar bort primÃ¤rdata

Tar bort attachmentfiler (skÃ¤rmdumpar/HTML) eller ersÃ¤tter med â€œredactedâ€

LÃ¤gger blockâ€‘list entry i do_not_process fÃ¶r ny insamling pÃ¥ samma nyckel (om policy krÃ¤ver)

Kvitto:

Genereras receipt_id med signatur + sammanfattning (antal poster, tabeller, tidsstÃ¤mpel).

D.4 Ã…tkomstlogg

Interception i API/UI/Export: varje lÃ¤sning/export av data loggas:

who (user/service), what (dataset/export_id), why (purpose), when, where (ip/user-agent), result.

Appendâ€‘only (inte raderbar), WORMâ€‘flagga (writeâ€‘onceâ€‘readâ€‘many) om stÃ¶ds.

E) MySQLâ€‘schema (privacy)
CREATE TABLE IF NOT EXISTS privacy_rules (
  id         BIGINT PRIMARY KEY AUTO_INCREMENT,
  name       VARCHAR(64) UNIQUE,
  type       ENUM('email','phone','personnummer','license_plate','ip','cookie_id','vin','custom_regex') NOT NULL,
  target     JSON NOT NULL,       -- fÃ¤ltlista eller ["*"] fÃ¶r payload
  regex      TEXT,
  severity   ENUM('info','warn','block') DEFAULT 'warn',
  masking    TINYINT(1) DEFAULT 1,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS privacy_findings (
  id         BIGINT PRIMARY KEY AUTO_INCREMENT,
  item_id    VARCHAR(32) NOT NULL,
  rule_id    BIGINT NOT NULL,
  field      VARCHAR(128) NULL,
  snippet    VARCHAR(256) NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX (item_id), INDEX (rule_id), INDEX (created_at)
);

CREATE TABLE IF NOT EXISTS retention_policies (
  id         BIGINT PRIMARY KEY AUTO_INCREMENT,
  template   VARCHAR(128) NOT NULL,
  days       INT NOT NULL,
  action     ENUM('tombstone','anonymize','delete') NOT NULL,
  exceptions JSON,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY (template)
);

CREATE TABLE IF NOT EXISTS erase_requests (
  id           BIGINT PRIMARY KEY AUTO_INCREMENT,
  request_id   VARCHAR(40) UNIQUE,
  match_json   JSON NOT NULL,
  action       ENUM('tombstone','anonymize','delete') NOT NULL,
  reason       VARCHAR(256),
  status       ENUM('pending','running','completed','failed') DEFAULT 'pending',
  actor        VARCHAR(64),
  created_at   DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  finished_at  DATETIME
);

CREATE TABLE IF NOT EXISTS erase_manifests (
  id           BIGINT PRIMARY KEY AUTO_INCREMENT,
  request_id   VARCHAR(40) NOT NULL,
  item_id      VARCHAR(32) NOT NULL,
  action       ENUM('tombstone','anonymize','delete') NOT NULL,
  status       ENUM('planned','done','skipped','failed') DEFAULT 'planned',
  message      TEXT,
  created_at   DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX (request_id), INDEX (item_id)
);

CREATE TABLE IF NOT EXISTS do_not_process (
  id         BIGINT PRIMARY KEY AUTO_INCREMENT,
  key_field  VARCHAR(128) NOT NULL,    -- t.ex. payload.reg_number
  key_value  VARCHAR(256) NOT NULL,    -- normaliserad
  reason     VARCHAR(256),
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY (key_field, key_value)
);

CREATE TABLE IF NOT EXISTS access_log (
  id         BIGINT PRIMARY KEY AUTO_INCREMENT,
  ts         DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  actor      VARCHAR(64) NOT NULL,
  action     ENUM('read','export','download','query') NOT NULL,
  resource   VARCHAR(128) NOT NULL,
  resource_id VARCHAR(64),
  purpose    VARCHAR(256),
  ip         VARCHAR(64),
  user_agent VARCHAR(256),
  result     ENUM('ok','denied','error') DEFAULT 'ok',
  INDEX (ts), INDEX (actor), INDEX (resource)
);

F) Verifiering (praktiska kontroller)
F.1 PIIâ€‘skanning gav karantÃ¤n?
SELECT COUNT(*) FROM privacy_findings WHERE created_at > NOW() - INTERVAL 1 DAY;
SELECT COUNT(*) FROM extracted_items WHERE status='quarantine' AND created_at > NOW() - INTERVAL 1 DAY;


FÃ¶rvÃ¤ntat: findings Ã¶kar; items i karantÃ¤n speglar blockerande regler.

F.2 Retention rensade?
SELECT COUNT(*) FROM extracted_items
WHERE template_id=(SELECT id FROM templates WHERE name='vehicle_detail_v1' LIMIT 1)
  AND created_at < NOW() - INTERVAL 180 DAY;


FÃ¶rvÃ¤ntat: 0 (om action=tombstone/delete).
Kontrollera Ã¤ven audit/tombstoneâ€‘kvitton (om implementerat separat).

F.3 Radering (DSR)
SELECT status FROM erase_requests WHERE request_id='REQ123';
SELECT status, COUNT(*) FROM erase_manifests WHERE request_id='REQ123' GROUP BY status;
SELECT COUNT(*) FROM do_not_process WHERE key_field='payload.reg_number' AND key_value='ABC123';


FÃ¶rvÃ¤ntat: completed, planned=0, done>0, blocklist har posten.

F.4 Ã…tkomstlogg
SELECT actor, action, resource, ts 
FROM access_log 
WHERE actor='elin' AND ts > NOW() - INTERVAL 1 DAY;


FÃ¶rvÃ¤ntat: rader som motsvarar dina UI/APIâ€‘lÃ¤sningar och exporter.

G) DoD & E2Eâ€‘testfall
Definition of Done

PIIâ€‘regler kan sparas/kÃ¶ras; findings skapas; blockerande regler sÃ¤tter karantÃ¤n.

Retention kÃ¶r enligt schema och utfÃ¶r tombstone/anonymize/delete korrekt.

Radering (DSR) matchar enligt vald metod, tvÃ¥â€‘stegs bekrÃ¤ftelse, skapar manifest, genomfÃ¶r Ã¥tgÃ¤rd och skriver kvitto.

Ã…tkomstlogg fÃ¥ngar UI/APIâ€‘lÃ¤sningar, exporter och nedladdningar.

RBAC: Endast Admin/Privacy Officer fÃ¥r skapa/Ã¤ndra regler och radering; LÃ¤sare kan se policys och findings men inte agera.

Maskning i loggar och exporter enligt policy (vid â€œmasking=onâ€).

Blockâ€‘list hindrar Ã¥terinsaml-ing av raderade nycklar (om policy aktiv).

E2E (urval)

TCâ€‘PRIVâ€‘01: LÃ¤gg till â€œemailâ€ + â€œpersonnummerâ€ regler; kÃ¶r skanning 7 dagar; items flaggas; karantÃ¤n Ã¶kar.

TCâ€‘PRIVâ€‘02: SÃ¤tt vehicle_detail_v1: 180 dagar â†’ tombstone; kÃ¶r rensare; gamla poster fÃ¥r status tombstone.

TCâ€‘PRIVâ€‘03: DSR via payload.reg_number=ABC123 â†’ delete; manifest visar 3 poster; attachments raderas; do_not_process innehÃ¥ller regnumret.

TCâ€‘PRIVâ€‘04: Export efter maskpolicy â†’ kÃ¤nsliga fÃ¤lt maskade (****/hash).

TCâ€‘PRIVâ€‘05: Accessâ€‘log visar â€œexportâ€ och â€œdownloadâ€ med korrekt aktÃ¶r och resultat.

H) Edgeâ€‘cases, prestanda, sÃ¤kerhet

Falska positiver i PII: stÃ¶d fÃ¶r whitelist (fÃ¤lt/regex) och â€œacknowledge findingâ€.

Anonymisering: stÃ¶der hash (saltad), mask (delvis), generalisering (kâ€‘anon, binning) fÃ¶r numeriska fÃ¤lt.

Backups: vid â€œpermanent deleteâ€ â€“ skapa â€œproofâ€‘ofâ€‘deleteâ€â€‘kvitto; sÃ¤kerstÃ¤ll att Ã¥terstÃ¤llning inte Ã¥teruppstÃ¥r raderade poster (policy: â€œselective restoreâ€ eller â€œlegal tombstoneâ€).

Prestanda skanning: kÃ¶r i batchar med index; anvÃ¤nd projekterade kolumner (t.ex. payload_reg_number) om ofta efterfrÃ¥gat.

A11y: tydliga varningar/etiketter; tangentbord genom hela flÃ¶det; â€œraderaâ€ krÃ¤ver textbekrÃ¤ftelse.

SÃ¤kerhet: alla privacyâ€‘Ã¥tgÃ¤rder krÃ¤ver stepâ€‘up auth (t.ex. OTP/U2F); auditâ€‘logg Ã¤r appendâ€‘only.

Snabb â€œhurâ€‘duâ€‘gÃ¶râ€ (sammanhÃ¥llet exempel)

1) Skanna PII (senaste 30 dagar)

FROM=$(date -u -d "-30 days" +"%Y-%m-%dT%H:%M:%SZ")
TO=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
curl -s -X POST http://localhost:8000/api/privacy/scan \
  -H "Content-Type: application/json" \
  -d "{\"project_id\":12,\"from\":\"$FROM\",\"to\":\"$TO\",\"rules\":[\"email\",\"personnummer\"]}" | jq


2) SÃ¤tt retention & kÃ¶r rensning nu

curl -s -X POST http://localhost:8000/api/privacy/retention -H "Content-Type: application/json" \
  -d '{"policies":[{"template":"vehicle_detail_v1","days":180,"action":"tombstone"}]}' | jq
curl -s -X POST http://localhost:8000/api/privacy/run-retention | jq


3) Radera pÃ¥ begÃ¤ran (regnummer)

curl -s -X POST http://localhost:8000/api/privacy/erase -H "Content-Type: application/json" \
  -d '{"match":{"field":"payload.reg_number","value":"ABC123","normalize":"upper"}, "action":"delete","reason":"DSR-REQ-2025-08-21"}' | jq


4) Visa accessâ€‘logg fÃ¶r dagens exporter

curl -s "http://localhost:8000/api/privacy/access-log?from=$(date -u +"%Y-%m-%d")T00:00:00Z&action=export" | jq


Med detta har vi Exporter och Privacy Center definierade in i minsta detalj:

komplett UI/UX,

APIâ€‘kontrakt och kÃ¶rbara kommandon,

MySQLâ€‘scheman och index,

pipelines (planerare/reader/validator/writer),

verifieringssteg, DoD, E2Eâ€‘testfall, samt prestandaâ€‘, A11yâ€‘ och sÃ¤kerhetskrav.









13) Policies (Policystudion)
A) Enkel fÃ¶rklaring

Det hÃ¤r Ã¤r kontrollrummet fÃ¶r hur vi beter oss mot en domÃ¤n: hastighet, renderingslÃ¤ge, headers/Referer, cookieâ€‘consent, robots/ToS, och felreaktioner (circuit breakers). Du sparar en policy fÃ¶r exempel.se (eller mÃ¶nster som *.exempel.se) och alla jobb mot den domÃ¤nen fÃ¶ljer samma regler â€” konsekvent, sÃ¤kert och lÃ¤tt att Ã¤ndra. Du kan ocksÃ¥ simulera â€œhur skulle en fetch se ut?â€ och utrulla Ã¤ndringar live till pÃ¥gÃ¥ende jobb.

B) UI/UX â€“ sidor, rutor, knappar
B.1 Ã–versiktssida â€œPolicystudionâ€

SÃ¶k + filter: domÃ¤n, taggar, status (utkast/publicerad), uppdaterad av, Ã¤ndrat senaste X dagar.

Tabell: domÃ¤nmÃ¶nster, version, sammanfattning (RPS/render/headers), senast Ã¤ndrad, â€œpÃ¥verkar N jobbâ€.

RadÃ¥tgÃ¤rder: Ã–ppna / Duplicera / Arkivera / Historik (diff mellan versioner).

Knappar: â€œNy policyâ€, â€œImportera frÃ¥n YAML/JSONâ€, â€œExportera valdâ€.

B.2 Redigerare fÃ¶r en policy

Sektioner (accordion):

Bas

DomÃ¤nmÃ¶nster (text, req): t.ex. car.info eller *.car.info

Beskrivning (text)

Taggar (chips)

Hastighet & Politeness

RPS (Requests/sek) (tal, ex 1.2)

Burst (tal)

Jitterintervall (ms, ex 200â€“1200)

Perâ€‘vÃ¤rd samtidighet (tal)

Crawlâ€‘delay (ms)

Time budget per request (ms, timeout)

Retrypolicy (max, backoff: linjÃ¤r/exponentiell med cap)

Renderingsstrategi

Strategi: Auto / HTTP / Browser

Autoâ€‘heuristik (toggles): â€œJSâ€‘indikatorerâ€, â€œAJAXâ€‘signalerâ€, â€œtom DOMâ€

Browserâ€‘detaljer:

Wait: domcontentloaded | networkidle | selector(...)

Viewport (px), UAâ€‘profil, Timezone, Geo

Stealthâ€‘nivÃ¥ (bas | avancerad)

Blockera resurser (bilder/video/annons/3:e part)

Sticky session (minuter)

Headers & Referer

Headerâ€‘profil: desktop/sv-SE | mobil/sv-SE | custom

Acceptâ€‘Language (ex sv-SE,sv;q=0.9,en;q=0.7)

Accept/Cacheâ€‘Control/Upgradeâ€‘Insecureâ€‘Requests (templates)

Refererâ€‘policy:

Auto (sÃ¤tter fÃ¶regÃ¥ende URL)

Explicit (textfÃ¤lt)

Ingen (tom)

DNT/SECâ€‘CH toggles (slumpad per session valbart)

Consent & Cookies

Consentâ€‘strategi:

Klicka â€œGodkÃ¤nnâ€ via selector (CSS)

FÃ¶rsÃ¶k sÃ¤tta consentâ€‘cookie fÃ¶re load (nyckel=vÃ¤rde; TTL)

Hoppa Ã¶ver (om inte visad)

Cookieâ€‘jar per domÃ¤n (Ã¥teranvÃ¤nd/persistens)

SameSite/secure enforcement (valfritt)

Robots/ToS

Robotsâ€‘lÃ¤ge:

Respektera (default)

Respektera + Crawlâ€‘delay

Ignorera (krÃ¤ver manuellt godkÃ¤nnande med checkbox)

ToSâ€‘krav:

â€œKrÃ¤v granskning & godkÃ¤nnande fÃ¶re kÃ¶rningâ€ (med lÃ¤nkfÃ¤lt)

â€œVisa varning i Job Launcherâ€

Felbeteende (Circuit breakers)

TrÃ¶sklar:

429â€‘frekvens > X% (fÃ¶nster N min) â‡’ sÃ¤nk RPS 50%, byt proxy

403/5xx > Y% â‡’ paus domÃ¤n i Z min

CAPTCHA detekterad â‡’ eskalera till Browser + Sticky + lÃ¤ngre vÃ¤ntan

P95â€‘latens > T ms â‡’ minska samtidighet

Ã…tgÃ¤rdstabell: villkor â†’ Ã¥tgÃ¤rder (ordnade, fÃ¶rsta trÃ¤ff vinner)

Poison queue: ï¬‚ytta URL vid >M misslyckade fÃ¶rsÃ¶k

Knappar (topâ€‘bar):

Spara policy (utkast â†’ publicerad)

Simulera mot URL

Applicera pÃ¥ befintliga jobb (modal med lista Ã¶ver pÃ¥verkade jobb)

Policyâ€‘hÃ¤lsa (visar varningsregler, senaste triggers)

Microâ€‘UX:

Inbyggd validering (t.ex. domÃ¤nmÃ¶nster, rimlig RPS).

Konfliktvarningar (om flera policies matchar samma domÃ¤n â€“ se prioritet nedan).

Diffâ€‘visning mellan versioner (â€œvad Ã¤ndrades?â€).

Tangentbord: Ctrl/Cmd+S Spara, Ctrl/Cmd+Enter Simulera.

C) Policymodell â€“ arv, prioritet, versioner

Hierarki & arv (hÃ¶gst â†’ lÃ¤gst):

Explicit domÃ¤npolicy (sub.domain.tld)

Wildcard (*.domain.tld)

Projektpolicy (default fÃ¶r projektet)

Global default

Prioritet: mest specifik match vinner; vid lika specifik:

hÃ¶gst version vinner (om bÃ¥da publicerade)

annars senast uppdaterad vinner

Versionering:

Utkast â†’ Publicera (skapar vN)

Rollback till tidigare publicerad version

Auditâ€‘logg: vem Ã¤ndrade vad

RÃ¤ckvidd:

Policy binds till domÃ¤n och subdomÃ¤ner enligt mÃ¶nster

Kan Ã¤ven bindas till scheman (http/https) om behov

D) Backendâ€‘API (kontrakt)
POST /api/policies
{ "domain_pattern":"*.car.info","description":"SE profile",
  "tags":["se","cars"],
  "speed":{"rps":1.5,"burst":3,"jitter_ms":[200,1200],"per_host_concurrency":2,"crawl_delay_ms":800,"timeout_ms":15000,
           "retry":{"max":3,"backoff":"exp","cap_ms":60000}},
  "render":{"mode":"auto","wait_for":"networkidle","viewport":{"w":1366,"h":768},
            "ua_profile":"desktop_chrome_125","timezone":"Europe/Stockholm","geo":"SE",
            "stealth":"advanced","block":{"images":true,"video":true},"sticky_minutes":10},
  "headers":{"profile":"desktop_sv","accept_language":"sv-SE,sv;q=0.9,en;q=0.7","referer":"auto","dnt":"random"},
  "consent":{"mode":"click","selector":"button#accept","pre_cookie":{"name":"consent","value":"yes","ttl_days":365}},
  "robots":{"mode":"respect","crawl_delay_ms":800},
  "tos":{"require_approval":true,"link":"https://car.info/terms"},
  "failover":{"rules":[
      {"if":{"code":"429","rate_gt":0.05,"window_min":5},"then":{"rps_factor":0.5,"proxy":"rotate"}},
      {"if":{"code":"403|503","rate_gt":0.1},"then":{"pause_domain_min":10}},
      {"if":{"captcha":true},"then":{"render":"browser","sticky_minutes":15,"delay_ms":1500}}
  ]},
  "status":"draft"
}

POST /api/policies/{id}/publish         -> {version: 3}
POST /api/policies/{id}/simulate
{ "url":"https://www.car.info/sv-se/license-plate/S/GDT620" }

POST /api/policies/{id}/apply-to-jobs
{ "job_ids":["job_abc","job_def"] }    -> 202 accepted

GET  /api/policies?domain=car.info
GET  /api/policies/{id}
GET  /api/policies/{id}/history


Pub/Sub utrullning till workers

POST /api/policies/broadcast
{ "policy_id":123, "version":3, "op":"update" } -> workers lyssnar och laddar ny profil

E) MySQLâ€‘schema (policies)
CREATE TABLE IF NOT EXISTS policies (
  id              BIGINT PRIMARY KEY AUTO_INCREMENT,
  domain_pattern  VARCHAR(255) NOT NULL, -- ex *.car.info
  description     VARCHAR(255),
  tags            JSON,
  speed_json      JSON NOT NULL,
  render_json     JSON NOT NULL,
  headers_json    JSON NOT NULL,
  consent_json    JSON,
  robots_json     JSON,
  tos_json        JSON,
  failover_json   JSON,
  status          ENUM('draft','published','archived') NOT NULL DEFAULT 'draft',
  current_version INT NOT NULL DEFAULT 0,
  priority        INT NOT NULL DEFAULT 100, -- lÃ¤gre = viktigare (override)
  created_by      VARCHAR(64),
  updated_by      VARCHAR(64),
  created_at      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY (domain_pattern, status, priority)
);

CREATE TABLE IF NOT EXISTS policy_versions (
  id             BIGINT PRIMARY KEY AUTO_INCREMENT,
  policy_id      BIGINT NOT NULL,
  version        INT NOT NULL,
  snapshot_json  JSON NOT NULL,
  published_by   VARCHAR(64),
  published_at   DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY (policy_id, version),
  INDEX (published_at)
);

CREATE TABLE IF NOT EXISTS policy_applied (
  id             BIGINT PRIMARY KEY AUTO_INCREMENT,
  job_id         VARCHAR(32) NOT NULL,
  domain         VARCHAR(255) NOT NULL,
  policy_id      BIGINT NOT NULL,
  version        INT NOT NULL,
  applied_at     DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX (job_id), INDEX (domain), INDEX (applied_at)
);


Indexâ€‘verifiering

EXPLAIN SELECT * FROM policies WHERE domain_pattern='*.car.info' AND status='published' ORDER BY priority ASC LIMIT 1;

F) Kommandon & Verifiering

Skapa och publicera policy

# Skapa
curl -s -X POST http://localhost:8000/api/policies \
  -H "Content-Type: application/json" \
  -d @policy_car_info.json | jq

# Publicera
curl -s -X POST http://localhost:8000/api/policies/123/publish | jq


FÃ¶rvÃ¤ntat: version: 1, status i DB published.

Simulera mot URL

curl -s -X POST http://localhost:8000/api/policies/123/simulate \
  -H "Content-Type: application/json" \
  -d '{"url":"https://www.car.info/sv-se/license-plate/S/GDT620"}' | jq


FÃ¶rvÃ¤ntat i svar: vilken renderingsstrategi, headers, proxy/geo, RPS, consentâ€‘Ã¥tgÃ¤rd som skulle gÃ¤lla, plus â€œhur en request skulle se utâ€.

Applicera pÃ¥ jobb

curl -s -X POST http://localhost:8000/api/policies/123/apply-to-jobs \
  -H "Content-Type: application/json" \
  -d '{"job_ids":["job_abc"]}' | jq


FÃ¶rvÃ¤ntat: accepted:true, och i Jobbdetaljer â†’ InstÃ¤llningar syns policy: car.info v1.

SQLâ€‘kontroll

SELECT job_id, domain, policy_id, version, applied_at
FROM policy_applied
ORDER BY applied_at DESC LIMIT 5;


FÃ¶rvÃ¤ntat: nya rader efter utrullning.

G) Vad hÃ¤nder i systemet

Spara policy: skrivs som utkast. â€œPubliceraâ€ â†’ snapshot i policy_versions, status published, current_version++.

Broadcast: UI kallar /broadcast; workers laddar ny policy i minne; pÃ¥gÃ¥ende jobb uppdaterar perâ€‘domÃ¤n kontext innan nÃ¤sta request.

Simulera: kÃ¶r httpâ€‘headless torrâ€‘hÃ¤mtning (ej full fetch) + heuristik â†’ returnerar vilken vÃ¤g som skulle vÃ¤ljas.

Applicera pÃ¥ befintliga jobb: skriv controlâ€‘meddelande till scheduler â†’ varje worker â€œhotâ€‘swaparâ€ policy fÃ¶r matchande domÃ¤ner.

H) Acceptanskriterier (DoD) & E2E

DoD

Mest specifik policy matchar (wildcard/explicit) och visas i Jobbdetaljer.

RPS/jitter/render/header/consent/robots tillÃ¤mpas i realtid (nÃ¤sta request).

Circuitâ€‘breakers triggar och syns som event i Jobbdetaljer (med Ã¥tgÃ¤rd).

Simulering visar samma beslut som verklig kÃ¶rning (fÃ¶r en testâ€‘URL).

Audit & versioner Ã¤r fullstÃ¤ndiga (diff & rollback fungerar).

E2Eâ€‘fall (urval)

POLâ€‘01: Skapa *.car.info, publish â†’ starta jobb â†’ Jobbdetaljer visar policy v1.

POLâ€‘02: SÃ¤nk RPS i policy â†’ broadcast â†’ throughput minskar inom 10s.

POLâ€‘03: 429â€‘spike â†’ circuit breaker sÃ¤nker RPS och byter proxy; logg visar Ã¥tgÃ¤rd.

POLâ€‘04: Simulera car.infoâ€‘URL â†’ render=browser; kÃ¶r torrjobb â†’ verklig kÃ¶rning anvÃ¤nder browser.

Edgeâ€‘cases

Konflikt mellan tvÃ¥ wildcard â†’ lÃ¤gre priority vinner.

Manuellt godkÃ¤nnande krÃ¤vs fÃ¶r robots: ignore â†’ Job Launcher varnar och blockerar utan checkbox.

HÃ¶g latens + sticky â†’ fallback: minska samtidighet, fÃ¶rlÃ¤ng timeout.

14) DQ & Analys (Data Quality)
A) Enkel fÃ¶rklaring

Det hÃ¤r Ã¤r hÃ¤lsokollen fÃ¶r dina data. Du ser:

Fyllnadsgrad (hur ofta fÃ¤lt Ã¤r ifyllda),

Valideringsfel (regex/typ/Luhn m.m.),

Selectorâ€‘drift (nÃ¤r en malls selektorer slutar trÃ¤ffa),

Trender Ã¶ver tid.
Du kan skapa varningsregler (t.ex. â€œom VINâ€‘fyllnad < 98% i 1h â†’ skicka aviseringâ€), Ã¶ppna felposter och lÃ¤gga till regressionstester som kÃ¶rs automatiskt pÃ¥ mallar.

B) UI/UX â€“ sidor, widgets, interaktion
B.1 Ã–versikt â€œData Qualityâ€

Filterrad: Projekt, Mall (version), Tidsintervall, Status, Taggar.

Widgets:

Fyllnadsgrad per fÃ¤lt (topâ€‘N, staplar)

Valideringsfel per regel (donut/heatmap)

Selectorâ€‘driftâ€‘score per mall (0â€“100)

JÃ¤mfÃ¶relse Ã¶ver tid (sparkline: completeness/validity/uniqueness)

DQâ€‘hÃ¤lsa trafikljus (grÃ¶n/gul/rÃ¶d) med sammanlagd score

Tabbar: â€œÃ–versiktâ€ | â€œFÃ¤ltâ€ | â€œReglerâ€ | â€œDriftâ€ | â€œHistorikâ€

B.2 Flik â€œFÃ¤ltâ€

Tabell: fÃ¤lt, typ, completeness %, nullâ€‘rate, distinct, exempelvÃ¤rden, trend (upp/ner), senaste Ã¤ndring (mallversion).

Klick Ã¶ppnar fÃ¤ltâ€‘detalj (distribution, boxplot/outliers, exempelposter, export felprov).

B.3 Flik â€œReglerâ€

Valideringsregler: regex/enum/range/luhn/relationsregler.

Heatmap Ã¶ver failâ€‘rate per regel Ã¶ver tid.

RadÃ¥tgÃ¤rder: â€œVisa felposterâ€, â€œJustera regelâ€, â€œSkapa varningsregelâ€.

B.4 Flik â€œDriftâ€

Selectorâ€‘drift (per selector i mall):

Driftâ€‘score 0â€“100 (100 = stabil) baserat pÃ¥:

Matchâ€‘rateâ€‘Ã¤ndring (Î” trÃ¤ffar/100 sidor)

DOMâ€‘hashâ€‘skillnad kring element (SimHash/ssdeep)

TextlÃ¤ngdsâ€‘/mÃ¶nsterfÃ¶rÃ¤ndring

Tidsserie + â€œSenaste DOMâ€‘snapshotâ€ & skÃ¤rmdump vid drift.

Ã…tgÃ¤rdsknappar: â€œÃ–ppna i Selector Toolâ€, â€œSkapa regressionstestâ€.

B.5 Flik â€œHistorikâ€

DQâ€‘milstolpar: publiceringar, regressionsinfÃ¶randen, regelÃ¤ndringar, incidenter (larm).

B.6 Ã…tgÃ¤rdsknappar (globalt)

Skapa varningsregel (modal)

Ã–ppna felposter (tar dig direkt till Datalager med filtrering)

LÃ¤gg till regressionstest (binder testâ€‘URL:er till mall/selector)

A11y & microcopy: varningar har tydlig text + ikon + lÃ¤nk â€œLÃ¤s merâ€. Kortkommandon: / fÃ¶r att sÃ¶ka fÃ¤lt/regler, R fÃ¶r att skapa varningsregel.

C) DQâ€‘motor â€“ vad mÃ¤ts och hur
C.1 MÃ¥tt & definitioner

Completeness (per fÃ¤lt) = 1 âˆ’ null_rate

Validity (per regel) = giltiga / kontrollerade

Uniqueness (per nyckel) = 1 âˆ’ (dubbletter / totala)

Freshness = andel nya poster senaste X timmar

Selector matchâ€‘rate = trÃ¤ffade noder / fÃ¶rvÃ¤ntade

Driftâ€‘score = 100 âˆ’ w1Â·Î”match_rate âˆ’ w2Â·DOM_diff âˆ’ w3Â·text_diff (klippt [0,100])

C.2 Aggregering

Batching (var 1â€“5 min): sammanstÃ¤ll senaste kÃ¶rningar (Jobbdetaljer â†’ Output).

Retention: behÃ¥ll DQâ€‘tidsserier 90â€“365 dagar.

C.3 Larm/Regler

Villkor: trÃ¶sklar Ã¶ver tidsfÃ¶nster (t.ex. â€œVIN completeness < 0.98 under 30 minâ€).

Notifieringar: eâ€‘post, webhook (HMAC), Slack/Teams.

Hysteresis: undvik â€œfladdrandeâ€ larm (krÃ¤v 2â€“3 datapunkter).

D) Backendâ€‘API (kontrakt)
GET  /api/dq/overview?project=12&template=vehicle_detail_v1&from=...&to=...
GET  /api/dq/fields?template=vehicle_detail_v1
GET  /api/dq/rules?template=vehicle_detail_v1
GET  /api/dq/drift?template=vehicle_detail_v1
POST /api/dq/alerts
{ "name":"VIN under 98%","project_id":12,"template":"vehicle_detail_v1",
  "condition":{"metric":"completeness","field":"vin","op":"<","value":0.98,"window_min":30},
  "notify":{"email":["dq@company.se"],"webhook":{"url":"https://...","hmac":"secret"}},
  "enabled":true }

POST /api/dq/regression-tests
{ "template":"vehicle_detail_v1","urls":["https://.../car1","https://.../car2"], "expected":{"vin":"regex:^[A-HJ-NPR-Z0-9]{17}$"} }

POST /api/dq/run-regression
{ "template":"vehicle_detail_v1","test_id":"rt_123" }

E) MySQLâ€‘schema (DQ)
CREATE TABLE IF NOT EXISTS dq_metrics (
  id           BIGINT PRIMARY KEY AUTO_INCREMENT,
  project_id   BIGINT NOT NULL,
  template     VARCHAR(128) NOT NULL,
  field        VARCHAR(128) NULL,
  metric       ENUM('completeness','validity','uniqueness','freshness','match_rate','drift_score') NOT NULL,
  value        DOUBLE NOT NULL,
  window_min   INT NOT NULL,
  ts           DATETIME NOT NULL,
  INDEX (project_id, template, metric, ts),
  INDEX (template, field, metric, ts)
);

CREATE TABLE IF NOT EXISTS dq_rules (
  id         BIGINT PRIMARY KEY AUTO_INCREMENT,
  template   VARCHAR(128) NOT NULL,
  rule_type  ENUM('regex','enum','range','luhn','relation') NOT NULL,
  field      VARCHAR(128),
  config     JSON NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS dq_alerts (
  id         BIGINT PRIMARY KEY AUTO_INCREMENT,
  name       VARCHAR(128) NOT NULL,
  project_id BIGINT NOT NULL,
  template   VARCHAR(128),
  condition  JSON NOT NULL,    -- metric/op/value/window
  notify     JSON NOT NULL,    -- email/webhook/slack
  enabled    TINYINT(1) DEFAULT 1,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS dq_alert_events (
  id         BIGINT PRIMARY KEY AUTO_INCREMENT,
  alert_id   BIGINT NOT NULL,
  triggered_at DATETIME NOT NULL,
  status     ENUM('firing','resolved') NOT NULL,
  snapshot   JSON NOT NULL,    -- vÃ¤rden som orsakade larmet
  INDEX (alert_id, triggered_at)
);

CREATE TABLE IF NOT EXISTS selector_drift (
  id           BIGINT PRIMARY KEY AUTO_INCREMENT,
  template     VARCHAR(128) NOT NULL,
  selector_key VARCHAR(128) NOT NULL, -- t.ex. field_name eller path-id
  match_rate   DOUBLE NOT NULL,
  dom_simhash  BIGINT NOT NULL,
  text_simhash BIGINT NOT NULL,
  drift_score  DOUBLE NOT NULL,
  ts           DATETIME NOT NULL,
  INDEX (template, selector_key, ts)
);

CREATE TABLE IF NOT EXISTS dq_regressions (
  id          BIGINT PRIMARY KEY AUTO_INCREMENT,
  test_id     VARCHAR(32) UNIQUE NOT NULL,
  template    VARCHAR(128) NOT NULL,
  urls_json   JSON NOT NULL,
  expected_json JSON,
  created_at  DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS dq_regression_runs (
  id          BIGINT PRIMARY KEY AUTO_INCREMENT,
  test_id     VARCHAR(32) NOT NULL,
  run_id      VARCHAR(32) NOT NULL,
  status      ENUM('running','passed','failed') NOT NULL,
  result_json JSON,
  started_at  DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  finished_at DATETIME,
  INDEX (test_id, started_at)
);


Indexâ€‘verifiering

EXPLAIN SELECT * FROM dq_metrics WHERE template='vehicle_detail_v1' AND metric='completeness' AND ts BETWEEN NOW()-INTERVAL 7 DAY AND NOW();

F) Kommandon & Verifiering

Skapa varningsregel

curl -s -X POST http://localhost:8000/api/dq/alerts \
  -H "Content-Type: application/json" \
  -d '{
    "name":"VIN completeness < 98%",
    "project_id":12,"template":"vehicle_detail_v1",
    "condition":{"metric":"completeness","field":"vin","op":"<","value":0.98,"window_min":60},
    "notify":{"email":["dq@acme.se"],"webhook":{"url":"https://example.ngrok.app/dq","hmac":"shhhhh"}},
    "enabled":true
  }' | jq


FÃ¶rvÃ¤ntat: svar med id, syns i UI under â€œVarningsreglerâ€.

LÃ¤gga regressionstest

curl -s -X POST http://localhost:8000/api/dq/regression-tests \
  -H "Content-Type: application/json" \
  -d '{"template":"vehicle_detail_v1","urls":["https://site/car/1","https://site/car/2"],"expected":{"vin":"regex:^[A-HJ-NPR-Z0-9]{17}$"}}' | jq


FÃ¶rvÃ¤ntat: test_id, syns under â€œRegressionstesterâ€.

KÃ¶ra regression

curl -s -X POST http://localhost:8000/api/dq/run-regression \
  -H "Content-Type: application/json" \
  -d '{"template":"vehicle_detail_v1","test_id":"rt_123"}' | jq


FÃ¶rvÃ¤ntat: run_id, senare status=passed|failed.

SQLâ€‘kontroller

-- Se completeness fÃ¶r VIN senaste dygnet
SELECT AVG(value) avg_comp
FROM dq_metrics
WHERE template='vehicle_detail_v1' AND field='vin' AND metric='completeness'
  AND ts > NOW() - INTERVAL 1 DAY;

-- Senaste drift-score per selector
SELECT selector_key, drift_score
FROM selector_drift
WHERE template='vehicle_detail_v1'
ORDER BY ts DESC LIMIT 20;

-- Larm som utlÃ¶sts
SELECT a.name, e.triggered_at, e.status
FROM dq_alert_events e JOIN dq_alerts a ON a.id=e.alert_id
ORDER BY e.triggered_at DESC LIMIT 20;

G) Algoritmer â€“ selectorâ€‘drift (fÃ¶renklad)

Matchâ€‘rateâ€‘Î”: jÃ¤mfÃ¶r senaste 100 sidor vs tidigare 100 (zâ€‘score)

DOMâ€‘hash: bygg text av fÃ¶rÃ¤ldranoder (taggar/klasser) Â±2 nivÃ¥er, SimHash â†’ Hammingâ€‘distans

Textâ€‘hash: normaliserad innerText, SimHash â†’ Hammingâ€‘distans

Driftâ€‘score:
100 âˆ’ (w1*scaledÎ” + w2*dom_dist + w3*text_dist) (klipp [0,100])
T.ex. w1=0.5, w2=0.3, w3=0.2

TrÃ¶sklar (fÃ¶rslag):

Varning om score < 80 (2 datapunkter i rad)

Kritisk om score < 60 â†’ autoskapa rekommendation att kontrollera mallen

H) Vad hÃ¤nder (hÃ¤ndelseflÃ¶de)

Ingest: Efter varje batch extraktion skickas rÃ¥ statistik â†’ DQâ€‘aggregator.

Aggregera: RÃ¤kna completeness/validity/uniqueness; berÃ¤kna drift per selector.

Skriv: dq_metrics, selector_drift.

Larmmotor: utvÃ¤rderar regler var 1â€“5 min; skickar notifieringar; loggar i dq_alert_events.

UI: Widgets pollar (eller via WS) DQâ€‘serierna; drillâ€‘down Ã¶ppnar Datalager.

I) Acceptanskriterier (DoD) & E2E

DoD

Widgets visar korrekta mÃ¥tt; filtrering pÃ¥verkar direkt.

â€œSkapa varningsregelâ€ utlÃ¶ser notiser nÃ¤r villkor uppfylls.

â€œÃ–ppna felposterâ€ landar i Datalager med rÃ¤tt filter.

â€œLÃ¤gg till regressionstestâ€ kÃ¶rs i CI (kan kÃ¶ras manuellt) och spÃ¤rrar publicering om test fallerar (valbar spÃ¤rr).

Selectorâ€‘drift markerar verkliga DOMâ€‘Ã¤ndringar (visar snapshot/screenshot).

E2Eâ€‘fall

DQâ€‘01: SÃ¤nk medvetet VINâ€‘trÃ¤ff â†’ completeness < trÃ¶skel â†’ larm inom 5 min.

DQâ€‘02: DOMâ€‘Ã¤ndring pÃ¥ targetâ€‘site â†’ driftâ€‘score faller â†’ varning â†’ Ã¶ppna Selector Tool.

DQâ€‘03: LÃ¤gg regression â†’ Ã¤ndra mallen (introducera fel) â†’ regression â€œfailedâ€ â†’ publicering blockeras (om spÃ¤rr aktiv).

DQâ€‘04: Ã–ka valideringsfel (regex) â†’ â€œÃ–ppna felposterâ€ visar exakta rader.

Edgeâ€‘cases

SmÃ¥ datamÃ¤ngder â†’ visa konfidensintervall och undertryck larm om n<50.

Batchâ€‘ryckighet â†’ anvÃ¤nd glidande medel och hysteresis.

Multiâ€‘version mall â†’ segmentera metrik per version.

J) Snabb â€œhurâ€‘duâ€‘gÃ¶râ€

1) Skapa policy fÃ¶r car.info och publicera

Enkelt: Vi sÃ¤tter lÃ¥g RPS, browserâ€‘lÃ¤ge, svensk UA, SEâ€‘geo, consentâ€‘klick.

Kommandon: (se â€œPolicyâ€‘APIâ€ ovan)

Vad hÃ¤nder: policy publiceras, broadcastas; workers laddar ny profil.

Verifiera: Jobbdetaljer â†’ InstÃ¤llningar visar policy car.info v1; throughput sjunker till vald RPS.

2) Skapa DQâ€‘varning fÃ¶r VIN

Enkelt: Larma om VIN saknas i >2% av posterna i en timme.

Kommandon: (alert POST ovan)

Vad hÃ¤nder: larm triggas nÃ¤r villkor uppfylls, mail/webhook gÃ¥r ut.

Verifiera: dq_alert_events innehÃ¥ller firing, och UI visar banner.


15) Scheduler & Aviseringar
MÃ¥l & principer

MÃ¥l: TillfÃ¶rlitlig, fÃ¶rutsÃ¤gbar kÃ¶rning av jobb med tydlig kalenderÃ¶versikt, smart prioritering och brusfria aviseringar.

Principer: UTC i backend, lokaltid i UI; idempotens i alla kÃ¶rningar; â€œsafe by defaultâ€ (ingen Ã¶verlappning om inte uttryckligen tillÃ¥tet); observability fÃ¶rst.

DomÃ¤nobjekt (Ã¶versikt)

Job: definition (typ, parametrar, versionsâ€‘hash, Ã¤gare).

Schedule: cronâ€‘liknande uttryck eller intervall + start/stop + tidszon.

Window: offâ€‘peak (uppmuntra kÃ¶rning) / blackout (fÃ¶rbjud) / maintenance (begrÃ¤nsa).

PriorityRule: vikt, SLA, kÃ¶namn, fairnessâ€‘policy.

Dependency: requires (DAG), mutex (Ã¶msesidig uteslutning), throttle (rate limit per nyckel).

Run: en kÃ¶rning med status, attempts, tidsstÃ¤mplar, worker, cost, loggreferenser.

NotificationRule: villkor (on_success|on_failure|on_sla_breach|on_queue_delay|digest), kanal(er), mall.

Channel: eâ€‘post, Slack, webhook (signerad), + ev. MS Teams.

RetryPolicy: max fÃ¶rsÃ¶k, backoff (exponentiell med jitter), timeouts, deadâ€‘letter.

CalendarException: helgdagar, DSTâ€‘policy, lokala undantag.

UI/UX
Rutor

1) Jobbkalender

Vy-lÃ¤gen: Dag, Vecka, MÃ¥nad, â€œListaâ€ (kommande 100 kÃ¶rningar), samt â€œHeatmapâ€ (belastning per timme).

FÃ¤rgkoder:

GrÃ¶n = planerad/ok, BlÃ¥ = kÃ¶rs, Orange = vÃ¤ntar p.g.a. fÃ¶nster/beroenden, RÃ¶d = misslyckad/sla-breach, GrÃ¥ = pausad.

Detaljpanel (hÃ¶ger): nÃ¤r du klickar en hÃ¤ndelse visas: jobbnamn, schema, nÃ¤sta 10 kÃ¶rningar, uppskattad kÃ¶rtid/kostnad, senaste 5 utfall, aktiva fÃ¶nster och regler som pÃ¥verkar.

Dragâ€‘&â€‘drop: justera en enskild kÃ¶rning (skapar override), eller dra ett schemaâ€‘block (uppdaterar Schedule). â€œÃ…ngraâ€ direkt i toast.

Ã–verlÃ¤gg: Visa offâ€‘peak (grÃ¶nt skimmer), blackout (skraffering), maintenance (gul kant). Tooltip fÃ¶r orsak.

Konfliktindikatorer: iconâ€‘chips (âš ï¸) dÃ¤r kÃ¶rning skulle bryta mot fÃ¶nster/konkurrens/beroende. Klick Ã¶ppnar â€œlÃ¶s konfliktâ€-guiden.

2) Prioritetsregler

Rule builder: IF (kÃ¶ == X/label == Y/SLA < N/Ã¤gare == teamZ/avg runtime > T/â€¦ ) THEN set priority = N; queue = K; preemption = true/false; concurrency cap = M; fairness = weighted roundâ€‘robin( vikt ).

Simulering: mata in â€œsyntetiskt dygnâ€ â†’ se kÃ¶â€‘latens och starttider fÃ¶re/efter regel.

Ordning & Ã„rftlighet: visa staplad utvÃ¤rderingsordning; konfliktdetektion (â€œregel A skuggar regel Bâ€).

3) FÃ¶nster (offâ€‘peak)

Typer: Offâ€‘peak (rekommenderad kÃ¶rning), Blackout (blockera), Maintenance (tillÃ¥t endast jobb med tag maintenance_ok).

Tidszon: definieras per fÃ¶nster (orgâ€‘default fÃ¶rslag). UI varnar om DSTâ€‘Ã¶vergÃ¥ng pÃ¥verkar nÃ¤sta kÃ¶rning.

Undantag: â€œtillÃ¥t trots fÃ¶nsterâ€ fÃ¶r specifika jobb eller datumspann. Loggas och krÃ¤ver motivering.

FÃ¶rhandsvisning: overlay i kalender + lista med â€œpÃ¥verkade kÃ¶rningarâ€.

4) Aviseringskanaler

Kanaler: Eâ€‘post (SMTP/SES), Slack (webhook/app), Webhook (HMACâ€‘signering), valbar Teams.

Mallâ€‘editor: Markdown + variabler ({{job.name}}, {{run.id}}, {{error.summary}}, {{metrics.runtime_ms}}, lÃ¤nk till loggar).

Bruskontroll: hysteresis (t.ex. max 1 felnotis per 15 min), digest (sammanfattning varje timme), eskalering efter N fel (till onâ€‘call).

Tyst lÃ¤ge: tysta notiser under definierade timmar, men tagga allvarliga SLAâ€‘brott som â€œgenombrytandeâ€.

Knappar & flÃ¶den

â€œSchemalÃ¤ggâ€

Ã–ppnar wizard (3â€“5 steg):

VÃ¤lj jobbtyp (med parameterform + validering),

VÃ¤lj schema (cron builder med â€œexempelâ€ + next 5 runs),

Regler (prioritet, concurrency, retry policy),

Aviseringar (regler + kanaler + mall),

Sammanfattning (diff + kostnadsestimat + konflikter).

Valideringar: cron giltig; tidszon satt; kollisioner med blackout; concurrency â‰¤ kapacitet; beroenden acykliska.

Resultat: skapar/uppdaterar Schedule, genererar nÃ¤sta kÃ¶rningar, triggar â€œtorrkÃ¶rningâ€ (simulerad queuing).

â€œPausa fÃ¶nsterâ€

Snabbâ€‘toggle per fÃ¶nster eller â€œglobal pausâ€ (med TTL).

Banner i kalender (â€œPaus aktiv till 14:00â€) + lista Ã¶ver vilka jobb som hÃ¥lls tillbaka.

KrÃ¤v motivering & auditlogga.

â€œTesta aviseringâ€

VÃ¤lj kanal(er) + mall â†’ skicka syntetisk run med standardpayload.

UI visar leveransstatus (200/ok, bounce, timeout), signaturâ€‘verifiering fÃ¶r webhook och Slack responseâ€‘text.

LÃ¤nka till â€œRÃ¥ JSONâ€‘payloadâ€.

Vad hÃ¤nder (systembeteende)
Triggers & kÃ¶er

Cron-/intervallâ€‘triggers berÃ¤knas i UTC. FÃ¶r varje â€œdueâ€ â†’ publicera meddelande till scheduler.jobs.due med idempotencyâ€‘nyckel (job_id + scheduled_at).

En arbetsplanerare Ã¶versÃ¤tter regler/fÃ¶nster/dependencies â†’ placerar i rÃ¤tt kÃ¶ (queue.standard, queue.high, queue.maintenance), respekterar fairness och concurrencyâ€‘token per key (t.ex. domÃ¤n).

Workers tar jobb, kÃ¶r, rapporterar Runâ€‘status och metrik. Misslyckanden gÃ¥r via RetryPolicy; uttÃ¶mda fÃ¶rsÃ¶k â†’ dlq.jobs.

Prioritering & preemption

Weighted roundâ€‘robin Ã¶ver kÃ¶er. Preemption stoppar ej pÃ¥gÃ¥ende run men hindrar nya lÃ¤greâ€‘prio start tills SLAâ€‘kritiska kÃ¶er Ã¤r tÃ¶mda.

FÃ¶nster

Vid dueâ€‘time: om i blackout â†’ deferral (nÃ¤sta tillÃ¥tna slot) med orsak. Offâ€‘peak flaggar som â€œgrÃ¶n tidâ€ fÃ¶r packning.

Aviseringar

Eventdrivet: run.succeeded|failed|sla_breach|queue_delayed.

NotificationService tillÃ¤mpar brusregler, renderar mall, signerar webhook (HMACâ€‘SHA256 pÃ¥ body + X-Signature), skickar, loggar â€œoutcomeâ€ och latens.

Datamodell (kort)

jobs(id, name, type, params_json, owner, labels[], created_at, updated_at, active)

schedules(id, job_id, cron|interval_seconds, tz, start_at, end_at, overlap_policy, enabled)

windows(id, type, tz, rrule|cron, applies_to=[job_id|label|*], reason, enabled)

priority_rules(id, match_expr, priority, queue, concurrency_cap, fairness_weight, enabled)

dependencies(from_job_id, to_job_id, type=require|mutex|throttle, key, rate_limit_per_min)

runs(id, job_id, scheduled_at, started_at, finished_at, status, attempts, worker_id, cost, error, metrics_json)

notification_rules(id, job_id|label|*, on_events[], channels[], template_id, noise_policy, enabled)

channels(id, type, config_json{smtp/slack/webhook_url, secret}, owner)

audit_log(id, actor, action, target_type, target_id, before, after, ip, ua, ts)

API (exempel)

POST /api/schedules â€“ skapa/uppdatera schema
Body: { job_id, cron, tz, start_at?, end_at?, overlap_policy, retry_policy{max, backoff, jitter}, notification_rule_ids[] }

GET /api/calendar?from=&to=&tz= â€“ genererad kalender (inkl. overlayâ€‘fÃ¶nster, konflikter)

POST /api/windows â€“ skapa fÃ¶nster

POST /api/notifications/test â€“ testa kanal/mall

POST /api/jobs/{id}/run â€“ manuell omkÃ¶rning (respekt fÃ¶r mutex/deps)

GET /api/runs?job_id=&status=&from=&to= â€“ lista historik

POST /api/schedules/{id}/pause (TTL, reason) / /resume

Fel & validering

409 vid cykliska beroenden; 422 vid ogiltig cron; 429 om concurrencyâ€‘cap nÃ¥dd; 423 vid blackout (med next_allowed_at i respons).

TillgÃ¤nglighet & UXâ€‘detaljer

Fullt tangentbordsstÃ¶d: fokusramar, ARIAâ€‘labels fÃ¶r kalenderhÃ¤ndelser.

Tidzonâ€‘selector â€œpinnarâ€ den som Ã¤r senast anvÃ¤nd. Tooltips med nÃ¤sta 5 kÃ¶rningar.

Tomâ€‘state med â€œSkapa ditt fÃ¶rsta schemaâ€ + miniâ€‘guide (60 sek).

SÃ¤kerhet

RBACâ€‘vakt runt alla POST/PUT/DELETE.

Hemliga fÃ¤lt i kanalâ€‘config lagras krypterat; webhook signeras; Slack OAuthâ€‘token fÃ¶rvaras i secretsâ€‘valv.

PII i payload maskas enligt policy; auditlogg fÃ¶r alla Ã¤ndringar/kÃ¶rningar/override.

Observability

Metrics: scheduler.due.count, queue.latency.p95, run.duration.p95, failure.rate, sla.breach.count, notify.delivery.latency, notify.error.rate.

Loggar: korrelerade med run_id, job_id, traceâ€‘id.

Larm: â€œQueue latency > SLA X minâ€, â€œFailure rate > Y% 15minâ€, â€œNotifier errors > Z/minâ€.

Kantfall (checklista)

DST â€œspring forwardâ€ (hoppar Ã¶ver timmar) och â€œfall backâ€ (dubbel timme) â€“ policy: â€œrun nearest futureâ€ respektive â€œdedupeâ€.

Missad kÃ¶rning p.g.a. driftstopp â†’ â€œmisfire policyâ€ (kÃ¶r en, kÃ¶r alla, eller skippa).

Ã–verlappningspolicy: blockera/queua/â€cancel previousâ€ fÃ¶r samma key.

Backpressure: vÃ¤xla till degraded mode (sÃ¤nk concurrency, paus ickeâ€‘kritiska kÃ¶er).

Delvis lyckade batchjobb â€“ skicka success with warnings (och trigga digest).

Aviseringsâ€‘loopar: dedupe pÃ¥ run_id + event.

Verifiering (acceptanskriterier & test)

Acceptans

Kommande kÃ¶rning syns i kalendern (alla vyer) inom â‰¤1s efter skapad schedule.

â€œTesta aviseringâ€ ger leveransstatus i UI inom 3s; webhook signerad och verifierbar.

Blackout hindrar start; tooltip visar orsak och â€œnÃ¤sta tillÃ¥tnaâ€.

Prioritetsregel pÃ¥verkar kÃ¶ordning â€“ visat i simuleringsgrafen.

Tester

Enhet: cronâ€‘parser, nextâ€‘runs, DST, retry/backoff, HMACâ€‘signatur.

Integration: schemalÃ¤ggning â†’ kÃ¶ â†’ worker â†’ notifier; DLQâ€‘flÃ¶de; fÃ¶nster/beroenden.

E2E: skapa schema, dra i kalender, paus globalt, simulera misslyckande â†’ avisering.

Last: 10k samtidiga planerade kÃ¶rningar â†’ kÃ¶latens < SLA.

Chaos: dÃ¶da workerâ€‘pool, se recovery; sabotera Slackâ€‘webhook (5xx) â†’ backoff + larm.

16) AnvÃ¤ndare & Roller
MÃ¥l & principer

MÃ¥l: Enkel hantering av Ã¥tkomst med minsta mÃ¶jliga privilegium, bra spÃ¥rbarhet och smidig integration (APIâ€‘nycklar/SSO).

Principer: Rollâ€‘baserat (RBAC) + scopes; â€œview asâ€ fÃ¶r att prova rÃ¤ttigheter; allt loggas och kan exporteras.

Roller (fÃ¶rslag, kan utÃ¶kas)

Admin: Full hantering (systeminstÃ¤llningar, roller, anvÃ¤ndare, nycklar, kanaler).

OperatÃ¶r: Skapa/Ã¤ndra jobb, scheman, fÃ¶nster; kÃ¶ra om; se loggar/metrics; hantera notifieringar.

LÃ¤sare: LÃ¤srÃ¤tt i UI & API; exportera rapporter; ej Ã¤ndra.

Integrationsâ€‘konto (Service Account): Headless, styrs av APIâ€‘nycklors scopes.

Auditor (valfritt): LÃ¤s + full auditlogg + export.

RÃ¤ttighetsmatris (exempel)
Modul/Aktion	Admin	OperatÃ¶r	LÃ¤sare	SA (via scope)
Jobb (CRUD)	âœ“	create/update	read	jobs:read/write
SchemalÃ¤ggning	âœ“	create/update/pause	read	schedules:*
FÃ¶nster	âœ“	create/update/pause	read	windows:*
Aviseringskanaler	âœ“	manage templates	read	notifications:*
KÃ¶rningar (retry/cancel)	âœ“	retry/cancel	read	runs:retry
AnvÃ¤ndare/roller	âœ“	â€“	â€“	â€“
APIâ€‘nycklar	âœ“	create own	view own	apikeys:*
Integritet/Privacy	âœ“	manage	read	privacy:*
Proxy/InstÃ¤llningar	âœ“	manage â€“ delmÃ¤ngd	read	scopeâ€‘styrt

UI visar â€œlÃ¥stâ€‘ikonâ€ istÃ¤llet fÃ¶r disabled; hover ger microcopy: â€œKrÃ¤ver OperatÃ¶r eller scope schedules:writeâ€.

UI/UX
Rutor

1) AnvÃ¤ndarlista

Kolumner: Namn, Eâ€‘post, Roller (chips), Senast aktiv, 2FAâ€‘status, SSOâ€‘status, Status (Aktiv/Inaktiverad).

Filter & sort: roll, team, status, senaste aktivitet, saknar 2FA/SSO.

Radmeny: Visa, â€œView asâ€, Ã„ndra roller, Inaktivera/Ã…teraktivera, Ã…terstÃ¤ll 2FA, Skicka om inbjudan.

Detaljsida: profil, grupp/organisation, sessions (aktiva med device/IP), riskhÃ¤ndelser, auditspÃ¥r.

2) Roller (checkbox per modul)

FÃ¶rinstÃ¤llningar: Admin/OperatÃ¶r/LÃ¤sare/Auditor.

Customâ€‘roll builder: checkboxar fÃ¶r read/create/update/delete/execute/manage per modul + scopes fÃ¶r API.

Konfliktvarning: â€œDenna roll har bÃ¥de deny och allow â€“ deny vinnerâ€.

FÃ¶rhandsgranskning: â€œView as denna rollâ€ Ã¶ppnar UI i readâ€‘only sandboxâ€‘lÃ¤ge.

3) APIâ€‘nycklar (nyckel, scope, utgÃ¥ng)

Nyckellista: namn, scopeâ€‘chips, skapad, senast anvÃ¤nd, utgÃ¥ng, IPâ€‘villkor, status (aktiv/revokerad).

Skapa wizard: namn, scopes (multiselect med fÃ¶rklaringar), giltighet (datum eller â€œtillfÃ¤llig 24hâ€), IPâ€‘whitelist (CIDR), miljÃ¶ (dev/stage/prod), rateâ€‘limit per nyckel, tags.

Visning: nyckel visas endast en gÃ¥ng; copyâ€‘knapp, â€œlÃ¤gg till i .envâ€ och â€œSkapa testâ€‘anropâ€ (curl).

Rotation: skapa ny â†’ graceâ€‘period â†’ autoâ€‘revokera gammal; exportera pÃ¥verkningslista (webhooks, CI).

Knappar & flÃ¶den

â€œLÃ¤gg till anvÃ¤ndareâ€:

Val av metod: Eâ€‘postinbjudan / SSOâ€‘provision (SCIM) / Manuell.

Tilldela roll(er), team, krÃ¤va 2FA vid fÃ¶rsta inloggning.

Microcopy: â€œInbjudan Ã¤r giltig i 7 dagarâ€.

â€œSkapa APIâ€‘nyckelâ€:

Wizard ovan + â€œTesta i APIâ€‘konsolâ€ (gÃ¶r ett /whoamiâ€‘anrop).

â€œInaktiveraâ€:

BekrÃ¤ftelsemodal med konsekvenser (sessioner spÃ¤rras, nycklar revokeras? valbart), orsak, TTL fÃ¶r tillfÃ¤llig spÃ¤rr.

Banner pÃ¥ profilsidan: â€œInaktiverad till â€¦ (orsak)â€.

Backend & sÃ¤kerhet
Autentisering

OIDC/OAuth2 (Google, Azure AD, Okta), lokalt konto (valbart) + 2FA (TOTP/WebAuthn).

Sessioner i sÃ¤kra cookies (HttpOnly, Secure, SameSite=Lax), rotering av refreshâ€‘token.

Magic link fÃ¶r engÃ¥ngsinlogg (begrÃ¤nsa till sÃ¤kra domÃ¤ner).

Auktorisering

RBACâ€‘middleware som hÃ¤rleder rÃ¤ttigheter frÃ¥n roller och APIâ€‘scopes.

Finkornig row/fieldâ€‘level kontroll fÃ¶r multiâ€‘tenant (org_id).

â€œBreakâ€‘glassâ€ administratÃ¶r: tidsbegrÃ¤nsad elevation med tvingad motivering + notis till sÃ¤kerhetskanal.

APIâ€‘nycklar

Genereras som prefix_live_xxxâ€¦; prefix sparas i klartext, hemlig del hashas (Argon2id).

Scopes i JWTâ€‘liknande struktur (signeras) eller i DB m. cachning.

Revokering omedelbar via cacheâ€‘invalidation.

Throttling & IPâ€‘filter per nyckel; â€œlast_used_atâ€ fÃ¶r hÃ¤lsa.

Provisionering

SCIM (om tillgÃ¤ngligt): automatisk skapning/inaktivering vid Ã¤ndring i IdP.

SSOâ€‘grupp â†’ rollmappning (policyfiler).

Audit & regelefterlevnad

Full auditlogg (appendâ€‘only, hashkedja) fÃ¶r: rollÃ¤ndring, nyckelâ€‘skapa/visa/revoke, inloggningar, misslyckade fÃ¶rsÃ¶k, policyÃ¤ndringar.

Export (CSV/JSON) med tidsfilter; retentionâ€‘policy (t.ex. 12 mÃ¥nader).

Kantfall (checklista)

Inaktiverad anvÃ¤ndare med aktiva sessioner â†’ omedelbar tokenâ€‘revokering.

SSOâ€‘anvÃ¤ndare utan mappad roll â†’ fallback till â€œLÃ¤sareâ€ eller blockera (konfigurerbart).

APIâ€‘nyckel utgÃ¥ngen mitt i lÃ¥ng kÃ¶rning â†’ pÃ¥gÃ¥ende anrop fullfÃ¶ljs, nya nekas (410).

â€œView asâ€ kan ej anvÃ¤ndas fÃ¶r att eskalera sig sjÃ¤lv; sparar inga Ã¤ndringar.

RollÃ¤ndring under session â†’ policy version i token; trigger â€œpolicy refreshâ€ i UI.

Verifiering (acceptanskriterier & test)

Acceptans

Inlogg/Ã¥tkomst fÃ¶ljer roller/scopes omedelbart (policyversion uppdateras utan omstart).

â€œLÃ¤gg till anvÃ¤ndareâ€ skickar inbjudan och auditlogg registreras.

â€œSkapa APIâ€‘nyckelâ€ visar nyckeln en gÃ¥ng; testanrop lyckas/nekas enligt scope.

â€œInaktiveraâ€ spÃ¤rrar sessioner och APIâ€‘nycklar enligt valt alternativ; UI visar status.

Tester

Enhet: policyutvÃ¤rdering per modul/Ã¥tgÃ¤rd, scopeâ€‘matchning, 2FAâ€‘flÃ¶de, nyckelhash & validering.

Integration: SSO inloggning + gruppâ†’rollâ€‘mappning; SCIM deprovision; rateâ€‘limit per nyckel.

E2E: skapa anvÃ¤ndare, byt roll, â€œview asâ€, fÃ¶rsÃ¶k otillÃ¥ten Ã¥tgÃ¤rd (fÃ¶rvÃ¤ntat 403), skapa nyckel, testa APIâ€‘anrop med/utan rÃ¤tt scope.

SÃ¤kerhet: brute forceâ€‘skydd, session fixation, CSRF pÃ¥ kÃ¤nsliga POST (antiâ€‘CSRFâ€‘token), CORS policy.

Compliance: export av auditlogg, verifiera hashkedja.

Microcopy (exempel)

Pausad fÃ¶nsterâ€‘banner: â€œPlanerade kÃ¶rningar hÃ¥lls tillbaka p.g.a. underhÃ¥llsfÃ¶nster. [Visa detaljer]â€

Denyâ€‘tooltip: â€œBehÃ¶righet saknas. Be en Admin om rollen OperatÃ¶r eller APIâ€‘scope schedules:write.â€

APIâ€‘nyckel visning: â€œVisa och spara nyckeln nu â€” den gÃ¥r inte att visa igen.â€

Prestanda & skalning (sammanfattning)

Scheduler kÃ¶r â€œnext dueâ€ berÃ¤kning inkrementellt (per minut), partitionerat per organisation.

KÃ¶er med backâ€‘pressureâ€‘signaler; autoskala workers via kÃ¶â€‘djup och p95â€‘latens.

Indexering: runs(job_id, scheduled_at), schedules(job_id, enabled), audit_log(ts).

Caching av policy/roller (TTL 60s, eventâ€‘driven invalidation).

17) InstÃ¤llningar (System)
A) Enkel fÃ¶rklaring (fÃ¶r ickeâ€‘tekniker)

HÃ¤r stÃ¤ller du in allt som Ã¤r gemensamt fÃ¶r systemet: vilken databas som anvÃ¤nds (vi stÃ¶der MySQL fullt ut), var filer ska sparas, hur man kopplar externa system (Elastic, BigQuery, Snowflake, Google Sheets), hur loggar & mÃ¤tvÃ¤rden exponeras och grundlÃ¤ggande sÃ¤kerhet (CORS, rateâ€‘limits). Du kan testa anslutningar och kÃ¶ra migrationer hÃ¤r sÃ¥ att databasen fÃ¥r rÃ¤tt tabeller.

B) UI/UX â€“ sektioner & rutor (allt som ska finnas)
B.1 Databaser

PrimÃ¤r lagring (radio): PostgreSQL / MySQL (default: MySQL)

MySQLâ€‘fÃ¤lt (visas nÃ¤r MySQL Ã¤r valt):

Host (text, default 127.0.0.1)

Port (tal, default 3306)

Databas (text, ex crawler)

AnvÃ¤ndare (text)

LÃ¶senord (password, â€œvisa/dÃ¶ljâ€)

SSL (checkbox) â†’ SSLâ€‘mode (dropdown: DISABLED|PREFERRED|REQUIRED)

Extra params (text, t.ex. charset=utf8mb4&connect_timeout=5)

Skriv som primÃ¤r (toggle) â†’ om avstÃ¤ngd skrivs primÃ¤rt till Postgres och MySQL blir readâ€‘side; om pÃ¥slagen Ã¤r MySQL bÃ¥de read/write.

LÃ¤sreplika (toggle) â†’ visar Replica host/port/user/pass (frivilligt)

Knappar:

Testa anslutning â†’ ping + SELECT 1, visar serverversion, tidszon

KÃ¶r migrationer nu â†’ kÃ¶r DBâ€‘migrationer till head

Statusâ€‘etiketter:

â€œAnsluten âœ“ (MySQL 8.0.35)â€

â€œMigrationer: pÃ¥ version headâ€ eller â€œligger efter: 3 stegâ€

B.2 Filâ€‘lagring

Lokal (radio)

Basâ€‘katalog (text, default ./data)

Max filstorlek (MB)

Rensa gamla (dagar)

Moln (radio: S3â€‘kompatibel)

Endpoint (text)

Bucket (text)

Prefix (text)

Access key / Secret key (password)

Kryptera pÃ¥ serverâ€‘sidan (checkbox)

Testa anslutning (knapp)

B.3 Externa connectorer

Elasticsearch / OpenSearch

URL, Indexâ€‘prefix, Auth (user/pass eller APIâ€‘nyckel), SSL verify

Testa anslutning

BigQuery

Project, Dataset, Auth JSON (textarea/filuppladdning)

Testa anslutning

Snowflake

Account, User, Role, Warehouse, Database, Schema, Key/Password

Testa anslutning

Google Sheets

Service account JSON, Impersonated user (valfritt)

Testa anslutning

B.4 Logg/Observability

Prometheus endpoint /metrics (toggle)

OpenTelemetry exporter (OTLP gRPC/HTTP, endpoint, samplingâ€‘rate)

LoggnivÃ¥ (DEBUG/INFO/WARN/ERROR) per modul

Strukturerad logg (JSON) (toggle)

Testa logg (skicka provâ€‘event och visa i UI)

B.5 SÃ¤kerhetsinstÃ¤llningar

CORS

Allowed origins (lista)

Allowed methods (checklist)

Allowed headers (lista)

Rateâ€‘limits (defaultar)

Per IP: req/min (tal)

Per APIâ€‘nyckel: req/min (tal)

Burst (tal)

Svar vid limit (429 text)

Session/Cookie policy (SameSite/HttpOnly/Secure) (visas fÃ¶r UI)

B.6 Licens & Organisation

Licensnyckel (text/password) + Verifiera

Organisationsnamn (text), Kontaktmail (mail)

B.7 Knappar (globalt)

Spara

Testa anslutning (contextual per sektion)

KÃ¶r migrationer nu

C) Vad hÃ¤nder (bakom kulisserna)

Spara
InstÃ¤llningar valideras i UI â†’ POST till /api/system/settings. Hemligheter krypteras i DB. En konfigâ€‘snapshot loggas till Audit (se Â§18).

Testa anslutning (DB)
Backend skapar en tillfÃ¤llig pool med angivna parametrar â†’ SELECT 1, @@version, @@system_time_zone. Resultat visas i UI och loggas (utan lÃ¶senord).

KÃ¶r migrationer nu
Backend kÃ¶r Alembic/SQLaâ€‘migrationer mot den valda primÃ¤ra DB:n.

Om MySQL Ã¤r satt â€œSkriv som primÃ¤râ€ â‡’ migrationer kÃ¶rs mot MySQL.

Om LÃ¤sreplika ifylld â‡’ endast readâ€‘pool byggs fÃ¶r SELECTs.

Vid lyckad migrering uppdateras alembic_version och en healthâ€‘write sker (ex: insert i system_health).

VÃ¤xla read/write repo
Efter sparat val uppdateras ConnectionManager:

write_repo = mysql_primary (om pÃ¥slaget),

read_repo = mysql_replica || mysql_primary.
Pub/Sub signal skickas till workers som â€œhotâ€‘swaparâ€ anslutningar utan att droppa pÃ¥gÃ¥ende jobb.

D) APIâ€‘kontrakt & kommandon
D.1 REST
GET  /api/system/settings
POST /api/system/settings                 -- sparar
POST /api/system/test/db                  -- testar DB (body: mysql/postgres creds)
POST /api/system/migrate                  -- kÃ¶r migrationer fÃ¶r vald primÃ¤r DB
POST /api/system/test/storage             -- testar lokal/S3
POST /api/system/test/connector           -- testar Elastic/BQ/Snowflake/Sheets
POST /api/system/license/verify
GET  /api/system/health                   -- sammanfattning: DB ok, storage ok, metrics ok

D.2 Exempel (curl)

Testa MySQL lokalt

curl -s -X POST http://localhost:8000/api/system/test/db \
  -H "Content-Type: application/json" \
  -d '{"kind":"mysql","host":"127.0.0.1","port":3306,"db":"crawler","user":"crawler","password":"secret","ssl":"DISABLED","params":"charset=utf8mb4"}' | jq


KÃ¶r migrationer nu

curl -s -X POST http://localhost:8000/api/system/migrate | jq


HÃ¤lsa

curl -s http://localhost:8000/api/system/health | jq

E) MySQL â€“ fÃ¶rbered exakt (kommando fÃ¶r kommando)

1) Skapa databas & anvÃ¤ndare

CREATE DATABASE IF NOT EXISTS crawler CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER IF NOT EXISTS 'crawler'@'%' IDENTIFIED BY 'secret';
GRANT ALL PRIVILEGES ON crawler.* TO 'crawler'@'%';
FLUSH PRIVILEGES;


2) Snabbtest med mysqlâ€‘klient

mysql -h127.0.0.1 -uroot -p -e "SELECT @@version, @@system_time_zone;"
mysql -h127.0.0.1 -ucrawler -psecret -e "SELECT 1;" crawler


TolkningshjÃ¤lp: fÃ¥r du en 1â€‘radig tabell med 1 Ã¤r anslutningen ok.

F) Konfigâ€‘fil: config/system.yaml (fullt innehÃ¥ll)

Skapa filen om den inte finns. Denna fil lÃ¤ses vid uppstart och kan skrivas om via UI. Hemligheter kan lagras krypterat i DB; men vi visar allt hÃ¤r fÃ¶r lokal dev.

# config/system.yaml
version: 1

database:
  primary:
    driver: mysql            # mysql | postgres
    host: 127.0.0.1
    port: 3306
    name: crawler
    user: crawler
    password: secret
    ssl: DISABLED            # DISABLED | PREFERRED | REQUIRED
    params: "charset=utf8mb4&connect_timeout=5"
  read_replica:
    enabled: false
    host: 127.0.0.1
    port: 3306
    name: crawler
    user: crawler
    password: secret
    ssl: DISABLED
    params: "charset=utf8mb4"
  write_as_primary: true     # om true: MySQL Ã¤r write/read

storage:
  kind: local                # local | s3
  local:
    base_path: "./data"
    max_file_mb: 1024
    retention_days: 365
  s3:
    endpoint: ""
    bucket: ""
    prefix: ""
    access_key: ""
    secret_key: ""
    sse: false

connectors:
  elastic:
    enabled: false
    url: "https://localhost:9200"
    index_prefix: "spark"
    auth:
      mode: basic
      username: "elastic"
      password: "changeme"
    ssl_verify: true
  bigquery:
    enabled: false
    project: ""
    dataset: ""
    credentials_json: ""     # base64 eller path
  snowflake:
    enabled: false
    account: ""
    user: ""
    role: ""
    warehouse: ""
    database: ""
    schema: ""
    auth:
      mode: password         # password | keypair
      password: ""
      private_key_pem: ""
  sheets:
    enabled: false
    service_account_json: ""
    impersonated_user: ""

observability:
  prometheus:
    enabled: true
    path: "/metrics"
  otlp:
    enabled: false
    endpoint: "http://localhost:4318"
    sampling_rate: 0.2
  logging:
    level:
      root: "INFO"
      api: "INFO"
      worker: "INFO"
      scheduler: "INFO"
    json: true

security:
  cors:
    allowed_origins: ["http://localhost:5173","http://localhost:3000"]
    allowed_methods: ["GET","POST","PUT","DELETE","OPTIONS"]
    allowed_headers: ["Content-Type","Authorization","X-Api-Key"]
  ratelimits:
    per_ip_per_min: 120
    per_key_per_min: 600
    burst: 60
    message: "Rate limit exceeded"
  session:
    same_site: "Lax"
    http_only: true
    secure: false            # true i prod
license:
  organization: "Acme AB"
  key: ""                    # valfritt i dev


Verifiering: Ã¤ndra i UI â†’ spara â†’ Ã¶ppna filen och se att Ã¤ndringen slÃ¥r igenom (eller att DBâ€‘lagringen speglar samma vÃ¤rden i /api/system/settings).

G) Alembic (MySQL) â€“ kÃ¶rning & kontroll

alembic.ini (relevant utdrag)

Vi antar att backend anvÃ¤nder SQLAlchemy. Uppdatera sqlalchemy.url dynamiskt via miljÃ¶ eller CLIâ€‘argument.

# alembic.ini
[alembic]
script_location = db/migrations
sqlalchemy.url = driver://will-be-overridden

[loggers]
keys = root,sqlalchemy,alembic

[logger_alembic]
level = INFO
handlers = console
qualname = alembic


KÃ¶r via CLI (exempel):

export DB_URL="mysql+pymysql://crawler:secret@127.0.0.1:3306/crawler?charset=utf8mb4"
alembic -x db_url="$DB_URL" upgrade head


Kontrollera version:

SELECT version_num FROM alembic_version;


FÃ¶rvÃ¤ntat: exakt en rad med nuvarande â€œheadâ€.

Healthâ€‘skrivning (snabb koll att write fungerar):

CREATE TABLE IF NOT EXISTS system_health (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  probe VARCHAR(32) NOT NULL,
  at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
);
INSERT INTO system_health (probe) VALUES ('write_ok');
SELECT * FROM system_health ORDER BY id DESC LIMIT 1;

H) Verifieringslista (checkboxâ€‘vÃ¤nlig)

 Testa anslutning (MySQL) visar â€œAnsluten âœ“â€ + version.

 KÃ¶r migrationer kÃ¶r till head (kolla alembic_version).

 Skriv som primÃ¤r pÃ¥slaget â†’ insert i system_health fungerar.

 Lagring: skriv testfil (/api/system/test/storage) â†’ fil syns under ./data/test/.

 Observability: curl localhost:8000/metrics ger Prometheusâ€‘text.

 CORS: frontendâ€‘origin i listan â†’ inga CORSâ€‘fel i dev.

I) Kantfall & sÃ¤kerhet

Fel lÃ¶senord/port â†’ â€œTesta anslutningâ€ visar tydligt fel (ER_ACCESS_DENIED_ERROR / timeout) utan att lÃ¤cka hemligheter.

SSLâ€‘krav i moln â†’ visa guidance (â€œsÃ¤tt ssl=REQUIRED och importera CAâ€).

Failover: om primÃ¤r blir otillgÃ¤nglig och lÃ¤sreplika finns, sÃ¤tt read onlyâ€‘lÃ¤ge (UIâ€‘banner) tills primÃ¤r Ã¥terkommer.

Hemligheter: UI aldrig loggar hemligheter; DBâ€‘kryptering (KMS/nyckelfil) och rotationsstÃ¶d.

Rateâ€‘limits: skydda /api/system/* med hÃ¥rdare limits och Adminâ€‘roll.

18) Audit & HÃ¤ndelseloggar
A) Enkel fÃ¶rklaring (fÃ¶r ickeâ€‘tekniker)

Det hÃ¤r Ã¤r svarta lÃ¥dan: allt som hÃ¤nder i systemet loggas hÃ¤r â€” vem gjorde vad, vad Ã¤ndrades, nÃ¤r, och resultat. Du kan sÃ¶ka pÃ¥ jobb/policy/mall/data, se diff mellan versioner och exportera till JSON. Loggen Ã¤r appendâ€‘only (gÃ¥r inte att Ã¤ndra i efterhand) och manipulationsspÃ¥rbar (hashâ€‘kedja).

B) UI/UX â€“ rutor & flÃ¶den
B.1 Filterpanel

Typ (multiâ€‘select): jobb, policy, mall, data, system, auth, export, privacy, proxy, scheduler

Tid (datumintervall, snabbar: 1h, 24h, 7d)

AktÃ¶r (anvÃ¤ndare, service account, APIâ€‘nyckelprefix)

Korrelation: job_id, run_id, policy_id, template, export_id, session_key

Resultat: ok | denied | error

SÃ¶k (fri text pÃ¥ sammanfattning/metadata)

B.2 Resultatlista

Kolumner: Tid, Typ, AktÃ¶r, Sammanfattning, Korrelationâ€‘chips, Resultat.

Radklick: Ã¶ppnar detaljvy med:

Full payload (JSON, pretty)

Diffâ€‘vy (om Ã¤ndring av mall/policy/instÃ¤llning): vÃ¤nster/hÃ¶ger med fÃ¤rgmarkering

Hashâ€‘kedja: prev_hash, event_hash + â€œVerifiera kedjaâ€

Relaterade hÃ¤ndelser (samma korrelationsID)

B.3 Knappar

Exportera logg (JSON) (respekterar filter)

Ã–ppna i Datalager (om hÃ¤ndelsen gÃ¤ller data)

Kopiera referens (permalÃ¤nk)

Verifiera kedja (kÃ¶r hashâ€‘verifiering i UI och visar OK/FAIL)

C) HÃ¤ndelsetyper (minimiâ€‘uppsÃ¤ttning)

policy.changed (skapat/Ã¤ndrat/publicerat/rollback) â€“ innehÃ¥ller diff

template.changed (dito) â€“ innehÃ¥ller diff och versionsnummer

job.created/updated/deleted, job.run.started/succeeded/failed (inkl. orsak)

scheduler.window.changed, priority.rule.changed

system.settings.changed (instÃ¤llningar), system.migration.ran

privacy.scan.started/completed, privacy.erase.requested/completed

export.started/completed/failed

auth.login.success/failure, user.role.changed, apikey.created/revoked

proxy.provider.added/blacklisted/validated

Varje hÃ¤ndelse innehÃ¥ller actor, ip/ua (om UI/API), resource, before/after (vid Ã¤ndring), result.

D) MySQL â€“ tabeller (appendâ€‘only & diff)
CREATE TABLE IF NOT EXISTS audit_event (
  id            BIGINT PRIMARY KEY AUTO_INCREMENT,
  ts            DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  type          VARCHAR(64) NOT NULL,              -- ex: policy.changed
  actor         VARCHAR(128) NOT NULL,             -- user:elin / sa:exporter
  actor_ip      VARCHAR(64) NULL,
  actor_ua      VARCHAR(256) NULL,
  resource_type VARCHAR(64) NULL,                  -- policy/template/job/system/data
  resource_id   VARCHAR(64) NULL,                  -- id fÃ¶r resursen
  correlation_id VARCHAR(64) NULL,                 -- job_id/run_id/export_id...
  summary       VARCHAR(512) NOT NULL,
  result        ENUM('ok','denied','error') NOT NULL DEFAULT 'ok',
  before_json   JSON NULL,
  after_json    JSON NULL,
  meta_json     JSON NULL,                         -- extra detaljer
  prev_hash     CHAR(64) NULL,
  event_hash    CHAR(64) NULL,
  INDEX (ts), INDEX (type), INDEX (actor), INDEX (resource_type, resource_id),
  INDEX (correlation_id), INDEX (result)
);


Hashâ€‘kedja: event_hash = SHA2(CONCAT(ts, type, actor, COALESCE(resource_type,''), COALESCE(resource_id,''), COALESCE(correlation_id,''), summary, COALESCE(JSON_EXTRACT(before_json, '$'),''), COALESCE(JSON_EXTRACT(after_json, '$'),''), COALESCE(prev_hash,'')), 256)
Applikationen lÃ¤ser senaste event_hash och sÃ¤tter prev_hash pÃ¥ nÃ¤sta post.

Diffâ€‘hjÃ¤lp (lagring av textdiff valfritt):

CREATE TABLE IF NOT EXISTS audit_diff_text (
  id          BIGINT PRIMARY KEY AUTO_INCREMENT,
  audit_id    BIGINT NOT NULL,
  side        ENUM('before','after') NOT NULL,
  blob_text   MEDIUMTEXT NOT NULL,
  INDEX (audit_id, side)
);


Indexâ€‘optimering (sÃ¶k):

ALTER TABLE audit_event ADD FULLTEXT INDEX ft_summary (summary);

E) API â€“ sÃ¶k & export
GET  /api/audit?type=policy.changed&from=...&to=...&actor=elin&result=ok&limit=100&cursor=...
GET  /api/audit/{id}
GET  /api/audit/{id}/diff            -- returnerar unified diff om finns
POST /api/audit/verify-chain         -- kÃ¶r hashkedjeâ€‘verifiering (frÃ¥n..till)
GET  /api/audit/export.json?from=...&to=...&type=...   -- streamingâ€‘export
GET  /api/audit/stream               -- SSE/WebSocket fÃ¶r liveâ€‘events


Exempel (curl):

# Lista senaste policy-Ã¤ndringar
curl -s "http://localhost:8000/api/audit?type=policy.changed&limit=20" | jq

# HÃ¤mta ett event + diff
curl -s http://localhost:8000/api/audit/123 | jq
curl -s http://localhost:8000/api/audit/123/diff

# Exportera logg (JSON)
curl -s -L "http://localhost:8000/api/audit/export.json?from=2025-08-01T00:00:00Z&to=2025-08-21T23:59:59Z&type=job.run.failed" -o audit_failed.json

F) Integration (sÃ¥ loggen fylls)

Middleware plockar upp: aktÃ¶r (user/service/apiâ€‘key), ip, userâ€‘agent.

Decorator @audited(type="policy.changed", resource=("policy", id)) runt alla muterande endpoints.

Jobb/Workers emitterar job.run.* & export.* (med korrelationer).

System skriver system.migration.ran efter Alembic, system.settings.changed efter lyckad POST /settings.

Privacy/Proxy/Scheduler skriver sina domÃ¤nâ€‘event.

G) Verifiering â€“ gÃ¶r sÃ¥ hÃ¤r (steg fÃ¶r steg)

1) Ã„ndra en policy (ex via tidigare Policiesâ€‘UI)

Spara â†’ Publicera.

Kontroll:

SELECT id, ts, type, actor, summary, result FROM audit_event
WHERE type='policy.changed'
ORDER BY id DESC LIMIT 1;


FÃ¶rvÃ¤ntat: en rad med ok och summary typ â€œpolicy *.car.info v2 publishedâ€.

2) KÃ¶r migrationer (frÃ¥n Â§17)

Kontroll:

SELECT type, summary FROM audit_event
WHERE type='system.migration.ran' ORDER BY id DESC LIMIT 1;


FÃ¶rvÃ¤ntat: sammanfattning med versionsâ€‘intervall from=a1b2 -> to=head.

3) Starta och stoppa ett jobb

Kontroll:

SELECT type, correlation_id, result
FROM audit_event
WHERE correlation_id='job_abc'
ORDER BY ts DESC;


FÃ¶rvÃ¤ntat: job.run.started fÃ¶ljt av job.run.succeeded|failed.

4) Verifiera hashâ€‘kedja

HÃ¤mta senaste 50 id:n och kÃ¶r POST /api/audit/verify-chain (UIâ€‘knapp â€œVerifiera kedjaâ€).

FÃ¶rvÃ¤ntat: â€œChain OKâ€.

5) Diffâ€‘vy fÃ¶r mall

Ã„ndra en selector i Template Wizard â†’ spara.

Kontroll: Ã¶ppna senaste template.changed i UI â†’ diff visar Ã¤ndrad rad.

H) Kantfall & sÃ¤kerhet

PII i logg: maska kÃ¤nsliga fÃ¤lt (eâ€‘post/telefon/regnr/personnr) i summary/meta_json.

Tamperâ€‘evidens: aktivera hashâ€‘kedja; valfritt att signera blockvis (t.ex. var 10:e event signeras med HMAC).

Retention: exportera till kallâ€‘lagring och trimma tabellen efter t.ex. 365 dagar (om policy tillÃ¥ter).

RBAC: endast Admin/Auditor fÃ¥r se hela audit; OperatÃ¶r ser hÃ¤ndelser i sina projekt; LÃ¤sare fÃ¥r en subset (utan meta).

Prestanda: partitionera tabellen per mÃ¥nad vid hÃ¶g volym (MySQL 8.0: partition by range on ts).

Loopâ€‘risk: audit av audit undviks (middleware hoppar /api/audit/*).

I) â€œSnabb problemlistaâ€ (vad UI ska guida)

Inget syns i audit: kontrollera att middleware Ã¤r aktiv och att audit_event inte saknar rÃ¤ttigheter.

Kedjan FAIL: nÃ¥gon har raderat/Ã¤ndrat event; exportera perioden och slÃ¥ larm.

Stor tabell: slÃ¥ pÃ¥ streamingâ€‘export och partitionering; index pÃ¥ (type, ts) och (resource_type, resource_id).

J) Miniâ€‘checklista (daglig drift)

SystemhÃ¤lsa (Â§17): DB âœ“, storage âœ“, metrics âœ“

Audit (Â§18): senaste timmarna har job.run.* och inga error stormar

Hashkedja: verifikat OK (daglig automatisk kÃ¶rning)

Backup/export: nattlig JSONâ€‘export funkar (filer vÃ¤xer dag fÃ¶r dag)















