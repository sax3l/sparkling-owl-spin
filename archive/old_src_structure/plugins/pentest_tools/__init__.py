#!/usr/bin/env python3
"""
Penetration Testing Plugin Registry f√∂r Sparkling-Owl-Spin
Central registry f√∂r alla penetrationstesting-verktyg
"""

import logging
from typing import Dict, List, Any, Optional
from enum import Enum

# Import alla pentest adapters
from .cloudflare_bypass import CloudflareBypassAdapter
from .captcha_solver import CaptchaSolverAdapter  
from .undetected_browser import UndetectedBrowserAdapter
from .uac_bypass import UACBypassAdapter
from .cve_exploits import CVEExploitFramework
from .phishing_framework import PhishingFramework

logger = logging.getLogger(__name__)

class PentestToolCategory(Enum):
    """Kategorier f√∂r penetrationstest-verktyg"""
    BYPASS_TOOLS = "bypass_tools"
    AUTOMATION_TOOLS = "automation_tools"
    PRIVILEGE_ESCALATION = "privilege_escalation"
    EXPLOIT_FRAMEWORKS = "exploit_frameworks"
    SOCIAL_ENGINEERING = "social_engineering"

# Pentest plugin registry
PENTEST_PLUGINS = {
    # Bypass Tools
    "cloudflare_bypass": {
        "name": "Cloudflare Bypass Adapter",
        "description": "Bypass Cloudflare protection f√∂r penetrationstestning av egna servrar",
        "adapter_class": CloudflareBypassAdapter,
        "category": PentestToolCategory.BYPASS_TOOLS,
        "security_level": "red",  # Kr√§ver explicit auktorisation
        "version": "1.0.0",
        "author": "Sparkling-Owl-Spin Security Team",
        "tags": ["cloudflare", "bypass", "ddos-protection", "web-security"],
        "swedish_name": "Cloudflare Bypass-adapter",
        "swedish_description": "Kringg√• Cloudflare-skydd f√∂r penetrationstestning av egna servrar",
        "requires_authorization": True,
        "authorized_targets_only": True,
        "disclaimer": "ENDAST f√∂r penetrationstestning av egna servrar och med explicit tillst√•nd"
    },
    
    "captcha_solver": {
        "name": "CAPTCHA Solver Adapter", 
        "description": "L√∂s CAPTCHA-utmaningar f√∂r penetrationstestning av egna servrar",
        "adapter_class": CaptchaSolverAdapter,
        "category": PentestToolCategory.BYPASS_TOOLS,
        "security_level": "red",
        "version": "1.0.0",
        "author": "Sparkling-Owl-Spin Security Team", 
        "tags": ["captcha", "2captcha", "recaptcha", "turnstile", "solver"],
        "swedish_name": "CAPTCHA-l√∂sare",
        "swedish_description": "L√∂s CAPTCHA-utmaningar f√∂r penetrationstestning av egna servrar",
        "requires_authorization": True,
        "authorized_targets_only": True,
        "disclaimer": "ENDAST f√∂r penetrationstestning av egna servrar och med explicit tillst√•nd"
    },
    
    # Automation Tools
    "undetected_browser": {
        "name": "Undetected Browser Adapter",
        "description": "Undetected browser automation f√∂r penetrationstestning",
        "adapter_class": UndetectedBrowserAdapter,
        "category": PentestToolCategory.AUTOMATION_TOOLS,
        "security_level": "red",
        "version": "1.0.0",
        "author": "Sparkling-Owl-Spin Security Team",
        "tags": ["browser", "automation", "stealth", "tls-fingerprinting", "selenium"],
        "swedish_name": "Undetected Browser-adapter",
        "swedish_description": "Undetected browser-automatisering f√∂r penetrationstestning",
        "requires_authorization": True,
        "authorized_targets_only": True,
        "disclaimer": "ENDAST f√∂r penetrationstestning av egna servrar och med explicit tillst√•nd"
    },
    
    # Privilege Escalation
    "uac_bypass": {
        "name": "UAC Bypass Adapter",
        "description": "Windows UAC bypass techniques f√∂r penetrationstestning",
        "adapter_class": UACBypassAdapter,
        "category": PentestToolCategory.PRIVILEGE_ESCALATION,
        "security_level": "red",
        "version": "1.0.0",
        "author": "Sparkling-Owl-Spin Security Team",
        "tags": ["uac", "bypass", "windows", "privilege-escalation", "fodhelper"],
        "swedish_name": "UAC Bypass-adapter",
        "swedish_description": "Windows UAC bypass-tekniker f√∂r penetrationstestning",
        "requires_authorization": True,
        "authorized_targets_only": True,
        "disclaimer": "ENDAST f√∂r penetrationstestning av egna Windows-servrar och med explicit tillst√•nd",
        "platform_specific": "windows"
    },
    
    # Exploit Frameworks
    "cve_exploits": {
        "name": "CVE Exploit Framework",
        "description": "CVE exploit framework f√∂r penetrationstestning av egna servrar",
        "adapter_class": CVEExploitFramework,
        "category": PentestToolCategory.EXPLOIT_FRAMEWORKS,
        "security_level": "red",
        "version": "1.0.0",
        "author": "Sparkling-Owl-Spin Security Team",
        "tags": ["cve", "exploits", "vulnerabilities", "security", "metasploit"],
        "swedish_name": "CVE Exploit Framework",
        "swedish_description": "CVE exploit framework f√∂r penetrationstestning av egna servrar",
        "requires_authorization": True,
        "authorized_targets_only": True,
        "disclaimer": "ENDAST f√∂r penetrationstestning av egna servrar och med explicit tillst√•nd"
    },
    
    # Social Engineering
    "phishing_framework": {
        "name": "Phishing Framework",
        "description": "Social engineering och phishing f√∂r penetrationstestning av egna organisationer",
        "adapter_class": PhishingFramework,
        "category": PentestToolCategory.SOCIAL_ENGINEERING,
        "security_level": "red",
        "version": "1.0.0", 
        "author": "Sparkling-Owl-Spin Security Team",
        "tags": ["phishing", "social-engineering", "email", "templates", "awareness"],
        "swedish_name": "Phishing Framework",
        "swedish_description": "Social engineering och phishing f√∂r penetrationstestning av egna organisationer",
        "requires_authorization": True,
        "authorized_targets_only": True,
        "disclaimer": "ENDAST f√∂r penetrationstestning av egna organisationer och med explicit tillst√•nd"
    }
}

def get_pentest_plugins_by_category(category: PentestToolCategory) -> Dict[str, Dict[str, Any]]:
    """H√§mta pentest plugins filtrerade efter kategori"""
    return {
        plugin_id: plugin_info 
        for plugin_id, plugin_info in PENTEST_PLUGINS.items()
        if plugin_info["category"] == category
    }

def get_all_pentest_plugins() -> Dict[str, Dict[str, Any]]:
    """H√§mta alla pentest plugins"""
    return PENTEST_PLUGINS.copy()

def get_pentest_plugin_info(plugin_id: str) -> Optional[Dict[str, Any]]:
    """H√§mta information om en specifik pentest plugin"""
    return PENTEST_PLUGINS.get(plugin_id)

def is_pentest_plugin_available(plugin_id: str) -> bool:
    """Kontrollera om pentest plugin √§r tillg√§nglig"""
    return plugin_id in PENTEST_PLUGINS

def get_pentest_security_warning() -> str:
    """H√§mta s√§kerhetsvarning f√∂r penetrationstest-verktyg"""
    return """
    ‚ö†Ô∏è S√ÑKERHETSVARNING - PENETRATIONSTEST-VERKTYG ‚ö†Ô∏è
    
    Dessa verktyg √§r ENDAST avsedda f√∂r:
    ‚Ä¢ Penetrationstestning av EGNA servrar och system
    ‚Ä¢ Auktoriserade s√§kerhetstester med EXPLICIT tillst√•nd
    ‚Ä¢ Utbildning i kontrollerad milj√∂
    
    ANV√ÑND ALDRIG dessa verktyg f√∂r:
    ‚Ä¢ Obeh√∂riga intr√•ng i andras system
    ‚Ä¢ Skadlig verksamhet eller cyberbrott
    ‚Ä¢ Testning utan explicit skriftligt tillst√•nd
    
    Anv√§ndaren √§r FULLT ANSVARIG f√∂r att f√∂lja g√§llande lagar
    och erh√•lla n√∂dv√§ndiga tillst√•nd innan anv√§ndning.
    
    All anv√§ndning loggas och √∂vervakas.
    """

def get_pentest_usage_guidelines() -> Dict[str, List[str]]:
    """H√§mta riktlinjer f√∂r anv√§ndning av pentest-verktyg"""
    return {
        "f√∂re_anv√§ndning": [
            "Erh√•ll skriftligt tillst√•nd fr√•n system√§gare",
            "Dokumentera testomf√•ng och begr√§nsningar", 
            "S√§kerst√§ll att s√§kerhetskopior finns",
            "Informera relevanta s√§kerhetsteam",
            "F√∂rbered incident response-procedurer"
        ],
        
        "under_testning": [
            "H√•ll dig inom auktoriserat omf√•ng",
            "Dokumentera alla √•tg√§rder och fynd",
            "Undvik att orsaka serviceavbrott",
            "Respektera datas√§kerhet och integritet",
            "Stoppa vid f√∂rsta tecken p√• skada"
        ],
        
        "efter_testning": [
            "Rensa alla testdata och artefakter",
            "√Öterst√§ll system till ursprungligt tillst√•nd",
            "Dokumentera s√•rbarheter och rekommendationer",
            "Rapportera fynd till ber√∂rda parter",
            "F√∂rst√∂r k√§nslig information s√§kert"
        ],
        
        "juridiska_krav": [
            "F√∂lj lokala och nationella lagar",
            "Respektera GDPR och dataskyddsf√∂rordningar",
            "Dokumentera alla avtal och tillst√•nd",
            "S√§kerst√§ll f√∂rs√§kringsskydd",
            "Konsultera juridisk r√•dgivning vid behov"
        ]
    }

def validate_pentest_authorization(plugin_id: str, target: str, 
                                 authorization_token: Optional[str] = None) -> bool:
    """Validera auktorisation f√∂r pentest-verktyg (mock implementation)"""
    plugin_info = get_pentest_plugin_info(plugin_id)
    
    if not plugin_info:
        logger.error(f"Unknown pentest plugin: {plugin_id}")
        return False
        
    if not plugin_info.get("requires_authorization", False):
        return True
        
    # I produktion skulle detta kontrollera mot riktig auktoriseringsdatabas
    logger.warning(f"‚ö†Ô∏è Pentest authorization required f√∂r {plugin_id} -> {target}")
    
    # Mock: returnera False f√∂r att kr√§va explicit auktorisation
    return False

def log_pentest_usage(plugin_id: str, target: str, action: str, 
                     user_id: Optional[str] = None):
    """Logga anv√§ndning av pentest-verktyg"""
    logger.info(f"üîç PENTEST LOG: {plugin_id} | {action} | {target} | User: {user_id}")
    
    # I produktion skulle detta skicka till s√§kerhetslogg/SIEM
    audit_entry = {
        "timestamp": logger.name,  # Should use actual timestamp
        "plugin": plugin_id,
        "target": target,
        "action": action,
        "user": user_id,
        "category": "penetration_testing"
    }
    
    # Skicka till audit log (mock)
    logger.info(f"üìã Audit entry created: {audit_entry}")

# Exportera key functions och klasser
__all__ = [
    'PENTEST_PLUGINS',
    'PentestToolCategory',
    'get_pentest_plugins_by_category',
    'get_all_pentest_plugins', 
    'get_pentest_plugin_info',
    'is_pentest_plugin_available',
    'get_pentest_security_warning',
    'get_pentest_usage_guidelines',
    'validate_pentest_authorization',
    'log_pentest_usage',
    # Adapter classes
    'CloudflareBypassAdapter',
    'CaptchaSolverAdapter',
    'UndetectedBrowserAdapter', 
    'UACBypassAdapter',
    'CVEExploitFramework',
    'PhishingFramework'
]
